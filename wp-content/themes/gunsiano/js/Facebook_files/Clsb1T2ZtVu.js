/*1355719778,178142533*/

if (self.CavalryLogger) { CavalryLogger.start_js(["FFg\/z"]); }

__d("PhotoTagApproval",["array-extensions","event-extensions","Arbiter","CSS","copyProperties","DOM","Parent","PhotosConst","ge"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');var g=b('Arbiter'),h=b('CSS'),i=b('copyProperties'),j=b('DOM'),k=b('Parent'),l=b('PhotosConst'),m=b('ge');function n(o){this.viewer=o;this.units=[];this.currentUnit=0;var p=o.getVersionConst();if(p==l.VIEWER_SNOWLIFT){this._root=m('fbPhotoSnowliftTagApproval');}else this._root=m('fbPhotoPageTagApproval');g.subscribe(o.getEventString('DATA_CHANGE'),this.restartTagApproval.bind(this));Event.listen(this._root,'click',this.handleClick.bind(this));Event.listen(this._root,'mousemove',function(q){this.hiliteCurrentPendingTag();Event.kill(q);}.bind(this));this.restartTagApproval();}i(n.prototype,{handleClick:function(event){var o=event.getTarget();if(h.hasClass(o,'nextPager')&&h.hasClass(o,'enabled')){this.showNextUnit();}else if(h.hasClass(o,'prevPager')&&h.hasClass(o,'enabled')){this.showPrevUnit();}else if(k.byClass(o,'fbPhotoApprovalPendingButtons')){var p=this.units[this.currentUnit],q=this.getTagNameID(p);if(q){var r=k.byClass(o,'approve');g.inform('PhotoTagApproval.UPDATE_TAG_BOX',{id:q,approve:r,version:this.viewer.getVersionConst()});}this.removeSelectedUnit.bind(this).defer();}return true;},loadUnits:function(o){this.units=j.scry(this._root,'div.fbPhotoApprovalUnit');if(this.units.length){h.show(this._root);this.showUnit(o);h.conditionClass(this._root,'hidePagers',this.units.length==1);}else{h.hide(this._root);g.inform('PhotoTagApproval.HILITE_TAG',{tag:null,version:this.viewer.getVersionConst()});}},restartTagApproval:function(){this.loadUnits(0);},removeSelectedUnit:function(){var o=this.units[this.currentUnit];j.remove(o);this.loadUnits(this.currentUnit);},showNextUnit:function(){this.showUnit(this.currentUnit+1);},showPrevUnit:function(){this.showUnit(this.currentUnit-1);},getTagNameID:function(o){var p=o.id.indexOf(':');return o.id.slice(p+1);},showUnit:function(o){this.units.forEach(h.hide);this.currentUnit=(o+this.units.length)%this.units.length;var p=this.units[this.currentUnit];h.show(p);this.hiliteCurrentPendingTag();h.conditionClass(j.find(this._root,'a.prevPager'),'enabled',this.currentUnit>0);h.conditionClass(j.find(this._root,'a.nextPager'),'enabled',this.currentUnit<this.units.length-1);},hiliteCurrentPendingTag:function(){var o=this.units[this.currentUnit],p=this.getTagNameID(o);g.inform('PhotoTagApproval.HILITE_TAG',{tag:p,version:this.viewer.getVersionConst()});}});e.exports=n;});
__d("legacy:photo-tag-approval",["PhotoTagApproval"],function(a,b,c,d){a.PhotoTagApproval=b('PhotoTagApproval');},3);
__d("legacy:photos-constants",["PhotosConst"],function(a,b,c,d){a.PhotosConst=b('PhotosConst');},3);
__d("PhotosTaggingWaterfall",["AsyncSignal","copyProperties"],function(a,b,c,d,e,f){var g=b('AsyncSignal'),h=b('copyProperties');function i(j){i._queueName=j||i._queueName;}h(i,{BEGIN:"begin",TAG_FACE:"tag_face",HOVER_TAG_FACE:"hover_tag_face",ADD_NAME:"add_name",TAG_CONFIRMED:"tag_confirmed",FINISH:"finish",TYPE_NAME:'type_name',SELECT_NAME:'select_name',_queueName:null,sendSignal:function(j,k){new g('/ajax/photos/tag_waterfall.php',{data:JSON.stringify(j)}).setHandler(k).send();}});e.exports=i;});
__d("PhotoTagger",["event-extensions","array-extensions","function-extensions","Arbiter","AsyncRequest","CSS","DOM","ErrorDialog","Keys","Parent","PhotosConst","PhotosUtils","PhotosTaggingWaterfall","Style","Vector","PhotoTagStore","copyProperties","ge","userAction"],function(a,b,c,d,e,f){b('event-extensions');b('array-extensions');b('function-extensions');var g=b('Arbiter'),h=b('AsyncRequest'),i=b('CSS'),j=b('DOM'),k=b('ErrorDialog'),l=b('Keys'),m=b('Parent'),n=b('PhotosConst'),o=b('PhotosUtils'),p=b('PhotosTaggingWaterfall'),q=b('Style'),r=b('Vector'),s=b('PhotoTagStore'),t=b('copyProperties'),u=b('ge'),v=b('userAction');function w(y,z){return ((y%z)+z)%z;}function x(y,z){this.viewer=y;this.version=y.getVersionConst();this.tagHoverFacebox=z;this.datasources={};this.photoData={};this.tagRects={};this.ajaxURIs={tagsInit:'/ajax/photos/photo/tags/tags_init.php',tagsAlbum:'/ajax/photos/photo/tags/tags_album.php',fetchDatasource:'/ajax/photos/photo/tags/fetch_datasource.php',tagAction:'/ajax/photo_tagging_ajax.php',tagWithAction:'/ajax/with_tagging_ajax.php'};x.instances[this.version]=this;}t(x,{instances:{},getInstance:function(y){return x.instances[y];},resetAlbumTaggingSuggestions:function(y){var z=x.getInstance(y);z&&z.resetAlbumTaggingSuggestions();}});t(x.prototype,{TAG_BOX_SIZE:100,EPSILON:.0025,elemNames:{6:{addTagLink:'div.fbPhotosPhotoOwnerButtons',overlayActions:'div.snowliftOverlayBar'}},initSnowlift:function(y,z,aa){this._init(y,z,aa,this.viewer.container);},initPermalink:function(y,z,aa){this._init(y,z,aa,this.viewer.actionList);},_init:function(y,z,aa,ba){this.setupUserActionLogging();this.root=this.viewer.getRoot();this.tagger=y;this.tokenizer=z;this._qn=null;this.typeahead=z.getTypeahead();this.userId=aa;this.makeProfilePicMenuContainer=ba;this.faceboxes=[];this.currentFacebox=null;this.revokedFaceboxes=[];this.requestFaceboxNextTag=false;this.clickState=j.find(this.root,'div.stageActions');this.newTagBox=j.find(this.clickState,'div.newTagBox');this.addTagLink=j.find(this.root,this.elemNames[this.version].addTagLink);this.overlayActions=j.find(this.root,this.elemNames[this.version].overlayActions);this.setupHandlers();this.hideNewTagTimer=null;this.addedSuggestions=[];this.featuredSuggestions=[];this.albumSuggestions=[];this.friendSuggestions=[];this.suggestionAlbum=-1;this.needAlbumSuggestionsFetch=true;this.fetchTaggingSuggestions({owner:this.photoData.owner});this.setDataSource(this.typeahead.getData());this.updateFaceboxes();this.tagAccumulating=false;return this;},setTagAccumulator:function(y){this.tagAccumulating=y;},setupUserActionLogging:function(){this.ua=v(this.viewer.getSourceString()).uai('init','tagging').add_event('init');},logUserActionEvent:function(y){this.ua.add_event(y);},fetchTaggingSuggestions:function(y){this.logUserActionEvent('sugg_fetch');new h().setURI(this.ajaxURIs.tagsInit).setData(y).setOption('retries',1).setAllowCrossPageTransition(true).setHandler(function(aa){var ba=aa.getPayload();this.featuredSuggestions=ba.featuredTaggees;this.friendSuggestions=ba.friendTaggees;this.updateTypeaheadSuggestions();this.logUserActionEvent('sugg_fetch_done');}.bind(this)).send();var z=this.typeahead.subscribe('bootstrap',function(aa,ba){if(ba&&!ba.bootstrapping){if(this.taggingMode)this.updateWithSuggestions();this.typeahead.unsubscribe(z);this.typeahead.subscribe('focus',function(){if(this.taggingMode)this.updateWithSuggestions();}.bind(this));this.typeahead.subscribe('click',function(){if(!this.taggingMode)this.updateWithSuggestions();}.bind(this));this.tokenizer.subscribe('removeToken',this.updateWithSuggestions.bind(this));this.tokenizer.subscribe('addToken',this.addSuggestion.bind(this));this.typeahead.subscribe('respond',function(ca,da){if(this.taggingMode&&da&&!da.results.length)this.updateWithSuggestions();}.bind(this));}}.bind(this));},fetchAlbumTaggingSuggestions:function(){this.logUserActionEvent('sugg_album_fetch');new h().setURI(this.ajaxURIs.tagsAlbum).setData({cachedAlbum:this.suggestionAlbum,photo:this.photoData.fbid}).setOption('retries',1).setAllowCrossPageTransition(true).setHandler(function(y){this.needAlbumSuggestionsFetch=false;var z=y.getPayload();if(z.length===0)return;this.suggestionAlbum=z.album;this.albumSuggestions=z.taggees;this.updateTypeaheadSuggestions();this.logUserActionEvent('sugg_album_fetch_done');}.bind(this)).send();},resetAlbumTaggingSuggestions:function(){this.needAlbumSuggestionsFetch=true;this.updateTypeaheadSuggestions();},updateTypeaheadSuggestions:function(){this.typeahead.getView().setSuggestions(this.addedSuggestions.concat(this.featuredSuggestions,this.needAlbumSuggestionsFetch?[]:this.albumSuggestions,this.friendSuggestions));},setupHandlers:function(){this.handlers=[Event.listen(this.clickState,'click',this.addTag.bind(this)),Event.listen(window,'resize',this.hideTagger.bind(this)),Event.listen(this.addTagLink,'click',this.checkActions.bind(this)),Event.listen(this.overlayActions,'click',this.checkActions.bind(this))];Event.listen(document.documentElement,'keydown',function(event){if(!this.taggingMode)return;var y=Event.getKeyCode(event);if(y===l.ESC){this.deactivateTagging();}else if(y===l.TAB)this.addNextTagFromFacebox(event.shiftKey?-1:1);}.bind(this));this.subscriptions=[g.subscribe(this.viewer.getEventString('PAGE'),this.restartTagging.bind(this)),g.subscribe(this.viewer.getEventString('DATA_CHANGE'),this.setPhotoData.bind(this)),g.subscribe(this.viewer.getEventString('EXTRA_DATA_CHANGE'),this.setExtraData.bind(this)),g.subscribe(this.viewer.getEventString('CLOSE'),this.deactivateTagging.bind(this))];this.tokenizer.subscribe('addToken',this.saveTag.bind(this));this.tokenizer.subscribe('removeToken',this.removeTag.bind(this));this.tokenizer.subscribe('markTagAsSpam',this.markTagAsSpam.bind(this));},updateWithSuggestions:function(y,z){var aa=this.typeahead.getData().buildUids(' ',this.typeahead.getView().getSuggestions(),this.typeahead.getCore().getExclusions());if(!aa.length)return;var ba=this.typeahead.getData().respond('',aa);for(var ca=0;ca<ba.length;ca++)ba[ca].index=-1000+ca;},addSuggestion:function(y,z){var aa=z.info&&z.info.uid;if(aa){this.addedSuggestions.unshift(aa);this.updateTypeaheadSuggestions();}},setQueueName:function(y){this._qn=y;return this;},_sendWaterfallLogSignal:function(y){p.sendSignal({qn:this._qn,source:this.viewer.getSourceString(),step:y,pid:this.photoData.pid});},_bumpQueueName:function(){if(this._qn)this._qn+=1;},activateTagging:function(){this.logUserActionEvent('activate');g.inform('PhotoTagger.ACTIVATE_TAGGING');if(this.getDataSource()){this.dataSourceFetched(this.getDataSource());}else new h(this.ajaxURIs.fetchDatasource).setData({fbid:this.photoData.fbid,version:this.version}).send();if(this.needAlbumSuggestionsFetch)this.fetchAlbumTaggingSuggestions();},restartTagging:function(){this.hideNewTag();this.hideTagger();this.revokedFaceboxes=[];this.setCurrentFacebox(null);if(this.taggingMode){this.requestFaceboxNextTag=true;this.activateTagging();}},getDataSource:function(){return this.datasources[this.getDataSourceKey()];},getDataSourceKey:function(){if(this.photoData.ownertype=='user'&&!this.photoData.obj_id)return 'friends';return this.photoData.obj_id||this.photoData.owner;},setDataSource:function(y){if(this.typeahead.getData()!=y)this.typeahead.swapData(y);this.datasources[this.getDataSourceKey()]=y;},dataSourceFetched:function(y){this.taggingMode=true;i.addClass(this.root,'taggingMode');g.inform('PhotoTagger.ACTIVATED_TAGGING');this._bumpQueueName();this._sendWaterfallLogSignal(p.BEGIN);this.setDataSource(y);},deactivateTagging:function(){this.logUserActionEvent('deactivate');if(this.taggingMode===true)this._sendWaterfallLogSignal(p.FINISH);this.taggingMode=false;this.hideNewTag();this.hideTagger();this.setCurrentFacebox(null);i.removeClass(this.root,'taggingMode');g.inform('PhotoTagger.DEACTIVATED_TAGGING');},checkActions:function(event){var y=event.getTarget();if(m.byClass(y,'fbPhotosPhotoActionsTag'))if(this.taggingMode){this.deactivateTagging();}else{this.activateTagging();this.addNextTagFromFacebox(1);}},hideTagger:function(){i.hide(this.tagger);var y=j.scry(this.tagger,'input.textInput')[0];if(y)y.blur();},showTagger:function(){i.show(this.tagger);(function(){j.find(this.tagger,'input.textInput').focus();}).bind(this).defer();this.hideNewTag();},showNewTag:function(y){if(!this.newTagBox)return;j.setContent(j.find(this.newTagBox,'div.tagName'),j.create('span',null,y));i.show(this.newTagBox);this.hideNewTagTimer=setTimeout(this.hideNewTag.bind(this),3000);},hideNewTag:function(){if(!this.newTagBox)return;if(this.hideNewTagTimer!==null){clearTimeout(this.hideNewTagTimer);this.hideNewTagTimer=null;}i.hide(this.newTagBox);},getTaggerPositioningOrigin:function(){return r.getElementPosition(this.clickState,'document');},addTag:function(event){var y=event.getTarget(),z=m.byClass(y,'fbPhotosPhotoButtons');if(!this.taggingMode||(z&&y!==z)||m.byClass(y,'fbPhotosPhotoActions')||m.byClass(y,'photoTagTypeahead'))return;var aa=this.viewer.getImage(),ba=r.getEventPosition(event),ca=o.absoluteToNormalizedPosition(aa,ba);this.setCurrentFacebox(this.findNearestFacebox(ca));if(this.currentFacebox){this.addTagFromFacebox(this.currentFacebox);}else{i.removeClass(j.find(this.tagger,'.faceBox'),'faceBoxHidden');this.addTagFromPosition(ba,this.TAG_BOX_SIZE);}},findNearestFacebox:function(y){var z=Infinity,aa=null;this.faceboxes.forEach(function(ba){if(ba.rect.contains(y)){var ca=y.distanceTo(ba.rect.getCenter());if(ca<z){z=ca;aa=ba;}}});return aa;},addNextTagFromFacebox:function(y){if(this.faceboxes.length===0)return;if(!this.currentFacebox){this.setCurrentFacebox(this.faceboxes[0]);}else{var z=this.faceboxes.indexOf(this.currentFacebox),aa=w(z+y,this.faceboxes.length);if(aa===z)return;this.setCurrentFacebox(this.faceboxes[aa]);}this.addTagFromFacebox(this.currentFacebox);},addTagFromFacebox:function(y){i.addClass(y.node,'active');i.addClass(j.find(this.tagger,'.faceBox'),'faceBoxHidden');var z=y.rect.getCenter(),aa=this.viewer.getImage(),ba=o.normalizedToAbsolutePosition(aa,z),ca=(y.rect.w()/100)*r.getElementDimensions(aa).x;this.addTagFromPosition(ba,ca);},addTagFromPosition:function(y,z){var aa=this.viewer.getImage(),ba=this.calcTaggerPosition(aa,y,z);this.calcClickPoint(aa,y);if(!ba){this.hideTagger();return;}ba.setElementPosition(this.tagger);if(this.newTagBox){ba.setElementPosition(this.newTagBox);new r(z,z).setElementDimensions(this.newTagBox);}var ca=r.getElementPosition(aa),da=r.getElementDimensions(aa);if(y.y>ca.y+da.y*3/4){i.addClass(this.tagger,'fbPhotoTaggerFlipped');}else i.removeClass(this.tagger,'fbPhotoTaggerFlipped');this.showTagger();if(this.taggingMode){this._sendWaterfallLogSignal(p.TAG_FACE);}else this._sendWaterfallLogSignal(p.HOVER_TAG_FACE);},calcTaggerPosition:function(y,z,aa){var ba=r.getElementPosition(y),ca=r.getElementDimensions(y),da=new r(aa/2,aa/2),ea=z.sub(ba);for(var fa in {x:1,y:1}){if(z[fa]<ba[fa]||z[fa]>ba[fa]+ca[fa])return null;if(ea[fa]<(aa/2)){da[fa]=ea[fa];}else if(ca[fa]<ea[fa]+(aa/2))da[fa]=aa-(ca[fa]-ea[fa]);}var ga=3,ha=j.find(this.tagger,'.faceBox');q.set(ha,'width',(aa-ga*2)+'px');q.set(ha,'height',(aa-ga*2)+'px');var ia=z.sub(this.getTaggerPositioningOrigin());return ia.sub(da.x,da.y);},calcClickPoint:function(y,z){var aa=r.getElementDimensions(y),ba=r.getElementPosition(y),ca=z.sub(ba);this.clickPoint={x:ca.x/aa.x,y:ca.y/aa.y};},saveTag:function(y,z){var aa=this.getTaggingData('add',z.isFreeform()?'':z.getValue(),z.getText());aa.x=this.clickPoint.x*100;aa.y=this.clickPoint.y*100;aa.from_facebox=!!this.currentFacebox;aa.tagging_mode=!!this.taggingMode;this.logUserActionEvent('save');if(this.tagAccumulating){s.getInstance().storeTagWithOptions(this.photoData.fbid,aa.subject,aa.x,aa.y,aa);}else new h().setURI(this.ajaxURIs.tagAction).setMethod('POST').setData(aa).setAllowCrossPageTransition(true).setHandler(this.tagsChangeHandler.bind(this)).setErrorHandler(this.checkError.bind(this,z)).send();if(this.userId===parseInt(aa.subject,10)){var ba=j.scry(this.makeProfilePicMenuContainer,'[data-picid="'+this.viewer.getCurrentPhotoInfo().fbid+'"]');if(ba.length===1){var ca=ba[0];i.removeClass(ca,'hide');}}this.showNewTag(z.getText());this.hideTagger();var da=this.currentFacebox;if(da){if(this.taggingMode)this.addNextTagFromFacebox(1);this.removeFacebox(da);}},getTaggingData:function(y,z,aa){return {cs_ver:this.version,pid:this.photoData.pid,fbid:this.photoData.fbid,id:this.photoData.owner,subject:z,name:aa,action:y,source:this.viewer.getSourceString(),qn:this._qn,position:this.getPosition()};},getPosition:function(){return this.viewer.getPosition();},tagsChangeHandler:function(y){this.logUserActionEvent('save_done');},checkError:function(y,z){if(z.getPayload()&&z.getPayload().clear_tag){y.already_untagged=true;this.tokenizer.removeToken(y);}k.showAsyncError(z);},removeTag:function(y,z,aa){if(z.already_untagged)return;var ba='remove';if(j.scry(z.element,'a.pending')[0])ba='retract';if(z.blockUser)ba='remove_block';this.logUserActionEvent('save');if(this.tagAccumulating){if(z.isFreeform()){s.getInstance().removeTextTag(this.photoData.fbid,z.getInfo().text);}else s.getInstance().removeTag(this.photoData.fbid,z.getInfo().uid);}else new h().setURI(this.ajaxURIs.tagAction).setMethod('POST').setData(this.getTaggingData(ba,z.isFreeform()?'':z.getInfo().uid,z.getInfo().text)).setHandler(function(ea){this.tagsChangeHandler(ea);aa&&aa();}.bind(this)).setAllowCrossPageTransition(true).send();if(this.userId===parseInt(z.getValue(),10)&&this.userId!==this.viewer.getCurrentPhotoInfo().owner){var ca=j.scry(this.makeProfilePicMenuContainer,'[data-picid="'+this.viewer.getCurrentPhotoInfo().fbid+'"]');if(ca.length===1){var da=ca[0];i.addClass(da,'hide');}g.inform('PhotoTagger.REMOVED_MAKE_PROFILE_PIC_OPTION');}},removeTagByID:function(y,z,aa){var ba=this.tokenizer.tokens;for(var ca=0;ca<ba.length;ca++)if(ba[ca].info.uid==z)return this.removeTag(null,ba[ca],aa);},removeTagByIDFromHovercardLink:function(y,z,aa){this.removeTagByID(y,z,function(){if(window.Hovercard)window.Hovercard.contains(aa)&&window.Hovercard.hide(true);});},removeWithTag:function(y,z){new h().setURI(this.ajaxURIs.tagWithAction).setMethod('POST').setData({action:'remove_with',taggee:z,tag:y,version:this.version,fbid:this.photoData.fbid}).setHandler(function(aa){this.tagsChangeHandler(aa);if(window.Hovercard)window.Hovercard.hide(true);}.bind(this)).setAllowCrossPageTransition(true).send();},setPhotoData:function(y,z){this.photoData=z;return this;},setExtraData:function(y,z){this.tagRects=z.tagRects;this.updateFaceboxes();return this;},markTagAsSpam:function(y,z){new h().setURI(this.ajaxURIs.tagAction).setMethod('POST').setData(this.getTaggingData('mark_as_spam',z,null)).send();},removeFacebox:function(y){if(y===null)return;this.revokedFaceboxes.push(y.rect.getCenter());this.faceboxes.remove(y);j.remove(y.node);if(y===this.currentFacebox)this.setCurrentFacebox(null);},setCurrentFacebox:function(y){if(this.currentFacebox)i.removeClass(this.currentFacebox.node,'active');this.currentFacebox=y;},updateRevokedFaceboxes:function(){this.revokedFaceboxes=this.revokedFaceboxes.filter(function(y){for(var z=0;z<this.faceboxes.length;++z){var aa=this.faceboxes[z],ba=y.distanceTo(aa.rect.getCenter());if(ba<this.EPSILON)return true;}return false;}.bind(this));this.revokedFaceboxes.forEach(function(y){var z=this.findNearestFacebox(y);this.faceboxes.remove(z);j.remove(z.node);}.bind(this));},updateFaceboxes:function(){if(this.version!==n.VIEWER_SNOWLIFT)return;this.faceboxes=[];for(var y in this.tagRects)if(o.isFacebox(y))this.faceboxes.push({node:u(y),id:y,rect:this.tagRects[y]});this.updateRevokedFaceboxes();this.faceboxes.sort(function(aa,ba){return aa.rect.getCenter().x-ba.rect.getCenter().x;});if(this.currentFacebox){var z=this.currentFacebox.rect.getCenter();this.setCurrentFacebox(this.findNearestFacebox(z));i.addClass(this.currentFacebox.node,'active');}if(this.requestFaceboxNextTag){this.addNextTagFromFacebox(1);this.requestFaceboxNextTag=false;}},getFacebox:function(y){for(var z=0;z<this.faceboxes.length;++z)if(this.faceboxes[z].id===y)return this.faceboxes[z];return null;}});e.exports=x;});
__d("legacy:PhotoTagger",["PhotoTagger"],function(a,b,c,d){a.PhotoTagger=b('PhotoTagger');},3);
__d("PhotoPermalink",["array-extensions","event-extensions","function-extensions","Arbiter","AsyncRequest","Bootloader","Class","CSS","DOM","KeyEventController","Keys","PageTransitions","Parent","PhotosConst","PhotoSessionLog","PhotoStreamCache","PhotosUtils","PhotoViewer","Style","UserAgent","Vector","$","copyProperties","createArrayFrom","emptyFunction","ge","goURI"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');b('function-extensions');var g=b('Arbiter'),h=b('AsyncRequest'),i=b('Bootloader'),j=b('Class'),k=b('CSS'),l=b('DOM'),m=b('KeyEventController'),n=b('Keys'),o=b('PageTransitions'),p=b('Parent'),q=b('PhotosConst'),r=b('PhotoSessionLog'),s=b('PhotoStreamCache'),t=b('PhotosUtils'),u=b('PhotoViewer'),v=b('Style'),w=b('UserAgent'),x=b('Vector'),y=b('$'),z=b('copyProperties'),aa=b('createArrayFrom'),ba=b('emptyFunction'),ca=b('ge'),da=b('goURI');function ea(){this.parent.construct(this);this.encodingMode=false;this._uriStack=[];this.replaceUrl=false;}z(ea,{STATE_ERROR:'error',STATE_HTML:'html',STATE_IMAGE_DATA:'image',MIN_TAG_DISTANCE:80,_instance:null,getInstance:function(){if(!ea._instance)ea._instance=new ea();return ea._instance;},addPhotoFbids:function(fa,ga,ha){ea.getInstance().addPhotoFbids(fa,ga,ha);},attachTagger:function(fa){ea.getInstance().attachTagger(fa);},disableAjaxPipeForVideo:function(){var fa=ea.getInstance();if(fa.stream)fa.stream.setUseAjaxPipe(false);},init:function(){ea.getInstance().init();},recacheData:function(fa){ea.getInstance().recacheData(fa);},saveTagsFromPayload:function(fa){ea.getInstance().saveTagsFromPayload(fa);},saveTagsFromPayloadDelayed:function(fa){ea.saveTagsFromPayload.curry(fa).defer(2000);},handleServerError:function(fa,ga){ea.getInstance().handleServerError(fa,ga);},setHasLocation:function(fa){ea.getInstance().setHasLocation(fa);},storeFromData:function(fa){ea.getInstance().storeFromData(fa);},swapData:function(){ea.getInstance().swapData();},touchMarkup:ba,updateTotalCount:function(fa,ga,ha){ea.getInstance().updateTotalCount(fa,ga,ha);},isInVideoEncodingMode:function(){return ea.getInstance().isInVideoEncodingMode();},disableAutoRefresh:function(){ea.getInstance().disableAutoRefresh();},enableAutoRefresh:function(fa){ea.getInstance().enableAutoRefresh(fa);}});j.extend(ea,u);z(ea.prototype,{init:function(){this.stream=new s();this.stream.init(q.VIEWER_PERMALINK,'PhotoViewerPagelet');this.reset();this.root=y('fbPhotoPageContainer');this.header=y('fbPhotoPageHeader');this.stageWrapper=l.find(this.root,'.stageContainer');this.videoStage=l.find(this.stageWrapper,'div.videoStage');this.buttonActions=l.find(this.root,'div.stageButtons');this.feedback=ca('fbPhotoPageFeedback');this.image=ca('fbPhotoImage');this.errorBox=ca('fbPhotoPageError');this.actionList=ca('fbPhotoPageActions');this.stageActions=l.find(this.root,'div.stageActions');this.loadingStates={image:false,html:false};this.unhiliteTimer=null;this.pageHandlers=[Event.listen(this.root,'mouseout',this.mouseOutListener.bind(this)),Event.listen(this.root,'mousemove',this.mouseMoveListener.bind(this)),Event.listen(this.stageWrapper,'click',this.stageClickListener.bind(this)),Event.listen(this.stageWrapper,'dragstart',this.killDrag.bind(this)),Event.listen(this.stageWrapper,'selectstart',this.killDrag.bind(this)),Event.listen(this.buttonActions,'click',this.buttonListener.bind(this)),Event.listen(this.actionList,'click',this.rotateListener.bind(this)),Event.listen(this.feedback,'click',function(event){if(p.byClass(event.getTarget(),'like_link'))k.toggleClass(l.find(this.buttonActions,'div.likeCommentGroup'),'viewerLikesThis');}.bind(this))];o.registerHandler(this.transitionHandler.bind(this));m.registerKey('LEFT',this.goNav.bind(this));m.registerKey('RIGHT',this.goNav.bind(this));r.initLogging(r.PERMALINK);g.subscribe('PhotoTagApproval.HILITE_TAG',this.onHiliteTag.bind(this));g.subscribe('PhotoTagApproval.UPDATE_TAG_BOX',this.onUpdateTagBox.bind(this));},getEventPrefix:function(){return 'PhotoPermalink';},getSourceString:function(){return 'permalink';},getVersionConst:function(){return q.VIEWER_PERMALINK;},saveTagsFromPayload:function(fa){this.storeFromData(fa);if('data' in fa&&this.stream.getCursor() in fa.data)this.swapData();},goNav:function(event){var fa=Event.getKeyCode(event)||event.getTarget(),ga=event.type==='click'&&p.byClass(fa,'stageWrapper')&&!p.byClass(fa,'tagBoxPending')&&!p.byClass(fa,'tagBoxPendingResponse');if(ga&&k.hasClass(this.root,'taggingMode'))return false;if(fa==n.LEFT){this.page(-1);}else if(fa==n.RIGHT||ga)this.page(1);return false;},pagerClick:function(fa){if(fa=='prev'){this.page(-1);}else if(fa=='next')this.page(1);return false;},setLoadingState:function(fa,ga){switch(fa){case ea.STATE_IMAGE_DATA:this.loadingStates[fa]=ga;k.conditionClass(this.root,'imageLoading',ga);break;case ea.STATE_HTML:this.loadingStates[fa]=ga;k.conditionClass(this.root,'dataLoading',ga);break;}},checkState:function(fa){if(fa!=ea.STATE_ERROR&&!this.loadingStates[fa])return;switch(fa){case ea.STATE_IMAGE_DATA:var ga=this.stream.getCurrentImageData();if(ga){if(ga.url){this.switchImage(ga.url,true);}else if(ga.video)this.switchVideo(ga.video,true);this.setLoadingState(fa,false);}break;case ea.STATE_HTML:if(this.stream.getCurrentHtml()){this.swapData();this.setLoadingState(fa,false);}break;default:if(this.stream.errorInCurrent()){k.hide(this.image);k.show(this.errorBox);}break;}},reHilitePendingTag:function(){var fa=ca(this.hilitedTag);if(fa&&k.hasClass(fa,'showPendingTagName'))return;var ga=l.scry(this.root,'div.tagsWrapper div.showPendingTagName')[0];if(ga)this.switchHilitedTags(ga.id);},isPagingAllowed:function(fa){return this.stream.isValidMovement(fa)&&!k.hasClass(this.root,'croppingMode');},page:function(fa,ga){if(!this.isPagingAllowed(fa))return;this.unhiliteAllTags();var ha=this.getVideoOnStage();if(ha)this.switchVideo(ha,false);this.recacheData();this.stream.moveCursor(fa);k.hide(this.image);if(this.stream.errorInCurrent()){this.setLoadingState(ea.STATE_HTML,true);k.show(this.errorBox);return;}var ia=this.stream.getCurrentImageData();if(ia){if(ia.url){this.switchImage(ia.url,true);}else if(ia.video)this.switchVideo(ia.video,true);if(!ga){this.replaceUrl=true;da(ia.info.permalink);}}else{this.waitForLoadCount++;this.setLoadingState(ea.STATE_IMAGE_DATA,true);}if(this.stream.getCurrentHtml()){this.swapData();}else this.setLoadingState(ea.STATE_HTML,true);g.inform('PhotoPermalink.PAGE');},transitionHandler:function(fa){if(fa.getPath()!=='/photo.php')return false;if(fa.getQueryData().makeprofile&&fa.getQueryData().fbid==this.stream.getCursor()&&!this.getVideoOnStage()){i.loadModules(['PhotoCropper'],function(ja){ja.start();});o.transitionComplete();return true;}if(this.replaceUrl){this.replaceUrl=false;this._uriStack.push(fa.getQualifiedURI().toString());o.transitionComplete();return true;}var ga=this._uriStack.length;if(ga>=2&&this._uriStack[ga-2]==fa.getQualifiedURI().toString())this._uriStack.pop();var ha=this.stream.getCursorForURI(fa.getUnqualifiedURI().toString());if(ha){var ia=this.stream.getRelativeMovement(ha);this.page(ia,true);o.transitionComplete();return true;}return false;},recacheData:function(fa){if(!this.loadingStates.html){var ga=this.stream.getCurrentHtml();for(var ha in ga){ga[ha]=aa(y(ha).childNodes);if(fa!==true&&ha!=='fbPhotoPageHeader')l.empty(y(ha));}}},getCurrentPhotoInfo:function(){var fa=this.stream.getCurrentImageData();return fa&&fa.info;},getVideoOnStage:function(){var fa=this.stream.getCurrentImageData();return fa&&fa.video;},switchImage:function(fa,ga){k.hide(this.image);k.hide(this.errorBox);var ha=this.stream&&this.stream.getCurrentImageData();if(ha)r.addPhotoView(ha.info);var ia=l.create('img',{id:'fbPhotoImage',className:'fbPhotoImage',alt:'',src:fa});l.replace(this.image,ia);this.image=ia;if(ga)this.stream.preloadImages();},switchVideo:function(fa,ga){var ha='swf_'+fa;if(ga){k.addClass(this.stageWrapper,'showVideo');this.videoStage.id=fa;if(window[ha]&&!ca(ha))window[ha].write(fa);}else{this.videoStage.id='fbPageVideoStage';window[ha].addVariable('video_autoplay',0);l.empty(this.videoStage);k.removeClass(this.stageWrapper,'showVideo');}},swapData:function(){if(this.dataLoadTimer){this.setLoadingState(ea.STATE_HTML,true);clearTimeout(this.dataLoadTimer);this.dataLoadTimer=setTimeout(this.clearTimer.bind(this,true),100);return;}var fa,ga=this.stream.getCurrentHtml();if(ga){for(var ha in ga){fa=ca(ha);fa&&l.setContent(fa,ga[ha]);}g.inform('PhotoPermalink.DATA_CHANGE',this.stream.getCurrentImageData().info,g.BEHAVIOR_STATE);if(this.stream.getCurrentExtraData())g.inform('PhotoPermalink.EXTRA_DATA_CHANGE',this.stream.getCurrentExtraData(),g.BEHAVIOR_STATE);this.setLoadingState(ea.STATE_HTML,false);this.dataLoadTimer=setTimeout(this.clearTimer.bind(this,false),100);}this.adjustForNewData();},clearTimer:function(fa){this.dataLoadTimer=false;fa&&this.swapData();},adjustForNewData:function(){if(!this.image)return;var fa=l.scry(this.stageWrapper,'div.tagsWrapper')[0],ga=x.getElementDimensions(this.image);if(fa){v.set(fa,'width',ga.x+'px');v.set(fa,'height',ga.y+'px');if(w.ie()<=7){var ha=l.scry(this.root,'div.tagContainer')[0];if(ha)k.conditionClass(fa,'ie7VerticalFix',x.getElementDimensions(ha).y>ga.y);}}},fetchInitBucket:function(fa){if(!this.stream.isLoaded())return;this.stream.fetch(fa,true);},addPhotoFbids:function(fa,ga,ha){var ia=this.stream.getCursor()===null;this.stream.attachToFbidsList(fa,ga,ha);if(ha&&ia)this.page(0);},attachTagger:function(fa){l.appendContent(this.stageActions,fa);},storeFromData:function(fa){var ga=this.stream.storeToCache(fa);if('init' in fa){r.setPhotoSet(this.stream.getPhotoSet());r.setLogFbids(true);r.addPhotoView(this.stream.getCurrentImageData().info);}if('error' in ga){this.checkState(ea.STATE_ERROR);return;}if('image' in ga)this.checkState(ea.STATE_IMAGE_DATA);if('data' in ga)this.checkState(ea.STATE_HTML);},handleServerError:function(fa,ga){l.setContent(this.errorBox,fa);this.storeFromData(ga);},updateTotalCount:function(fa,ga,ha){var ia=ca('fbPhotoPagePositionAndCount');ia&&l.setContent(ia,ha);this.stream.setTotalCount(fa);this.stream.setFirstCursorIndex(ga);},buttonListener:function(event){var fa=event.getTarget();if(p.byClass(fa,'likeButton')){var ga=l.scry(this.feedback,'button.like_link')[0];if(!ga){ga=l.scry(this.feedback,'a.UFILikeLink')[0];k.toggleClass(l.find(fa,'^div.likeCommentGroup'),'viewerLikesThis');}ga&&ga.click();}else if(p.byClass(fa,'commentButton')){var ha=l.scry(this.feedback,'div.commentBox textarea')[0];if(!ha)ha=l.scry(this.feedback,'li.UFIAddComment textarea')[0];if(ha){ha.focus();this.root.scrollTop=this.root.scrollHeight;}}},rotateListener:function(event){var fa=event.getTarget();if(p.byClass(fa,'rotateRight')){this.rotate('right');}else if(p.byClass(fa,'rotateLeft'))this.rotate('left');},stageClickListener:function(event){var fa=event.getTarget();if(p.byClass(fa,'fbPhotoTagApprovalBox')||p.byClass(fa,'videoStage')||p.byClass(fa,'tag')){return true;}else if(p.byClass(fa,'fbPhotoViewLarger')){i.loadModules(['PhotoSnowlift'],function(ga){ga.bootstrap(window.location,fa);});}else this.goNav(event);},rotate:function(fa){var ga=this.stream.getCursor();if(this.getVideoOnStage()){var ha=(fa=='left')?270:90;i.loadModules(['VideoRotate'],function(ja){new ja(ga,this.actionList).motionRotate(ha);}.bind(this));return;}var ia=z({fbid:ga,cs_ver:q.VIEWER_PERMALINK},this.stream.getPhotoSetQuery());ia[fa]=1;this.setLoadingState(ea.STATE_IMAGE_DATA,true);k.hide(this.image);new h('/ajax/photos/photo/rotate/').setMethod('POST').setAllowCrossPageTransition(true).setReadOnly(false).setData(ia).setFinallyHandler(this.rotateComplete.bind(this,ga)).send();},rotateComplete:function(fa,ga){if(fa==this.stream.getCursor()){this.setLoadingState(ea.STATE_IMAGE_DATA,false);this.switchImage(this.stream.getCurrentImageData().url);this.swapData();}},mouseOutListener:function(event){var fa=event.getTarget(),ga=event.getRelatedTarget(),ha=p.byClass(fa,'stageActions'),ia=p.byClass(fa,'stageWrapper'),ja=p.byClass(ga,'stageActions'),ka=p.byClass(ga,'stageWrapper'),la=(!ka&&(ia&&!ja)||(ha&&!ka));if(la)this.unhiliteAllTags(true);},mouseMoveListener:function(event){var fa=event.getTarget();if(!p.byClass(fa,'stageActions')&&!p.byClass(fa,'stageWrapper'))return;this.hiliteTagsOnMouseMove(event);},unhiliteAllTags:function(fa,event){l.scry(this.stageWrapper,'div.tagsWrapper div.hover').forEach(function(ga){if(fa&&k.hasClass(ga,'tagBoxPending'))return;k.removeClass(ga,'hover');});if(fa)return;if(this.unhiliteTimer!==null){clearTimeout(this.unhiliteTimer);this.unhiliteTimer=null;}this.hilitedTag=null;},switchHilitedTags:function(fa,ga){this.unhiliteAllTags();var ha=ca(fa);if(ha){this.hilitedTag=fa;k.addClass(ha,'hover');if(k.hasClass(ha,'tagBoxPending')&&!k.hasClass(ha,'showPendingTagName')&&ga===true){l.scry(this.stageWrapper,'div.tagsWrapper div.showPendingTagName').forEach(function(ia){k.removeClass(ia,'showPendingTagName');});k.addClass(ha,'showPendingTagName');}}},hiliteTagsOnMouseMove:function(event){if(!this.stream.getCurrentExtraData()||this.getVideoOnStage())return;if(this.unhiliteTimer!==null)return;var fa=event.getTarget();if(p.byClass(fa,'fbPhotoPageTagApproval')||p.byClass(fa,'tagPointer'))return;var ga=p.byClass(fa,'tagBoxPending'),ha=(this.hilitedTag&&k.hasClass(y(this.hilitedTag),'tagBoxPending')),ia=((!this.hilitedTag&&ga)||(!ha&&ga));if(ia){this.switchHilitedTags(ga.id);return;}if(ga&&(ga.id==this.hilitedTag))return;var ja=250,ka=t.absoluteToNormalizedPosition(this.image,x.getEventPosition(event)),la=t.getNearestBox(this.stream.getCurrentExtraData().tagRects,ka);if(!la){if(!ha){this.unhiliteAllTags();this.reHilitePendingTag();}return;}var ma=null;if(ha){var na={};na[this.hilitedTag]=this.stream.getCurrentExtraData().tagRects[this.hilitedTag];ma=t.getNearestBox(na,ka);}if(ma!==null&&ha)return;if(this.hilitedTag!=la)if(ha){this.unhiliteTimer=this.unhiliteAllTags.bind(this,false,event).defer(ja);}else this.switchHilitedTags(la);},updateTagBox:function(fa,ga){this.unhiliteAllTags();var ha=ca(fa);if(!ha)return;k.addClass(ha,'tagBox');k.addClass(ha,'tagBoxPendingResponse');k.removeClass(ha,'tagBoxPending');k.hide(l.find(ha,'span.tagForm'));if(ga){k.show(l.find(ha,'span.tagApproved'));}else k.show(l.find(ha,'span.tagIgnored'));},killDrag:function(){if(k.hasClass(this.root,'taggingMode'))return false;},reset:function(){while(this.pageHandlers&&this.pageHandlers.length)this.pageHandlers.pop().remove();m.getInstance().resetHandlers();},onHiliteTag:function(fa,ga){if(ga.version!=q.VIEWER_PERMALINK)return;var ha=ga.tag;if(ha){this.switchHilitedTags(ha,true);}else this.unhiliteAllTags();},onUpdateTagBox:function(fa,ga){if(ga.version==q.VIEWER_PERMALINK)this.updateTagBox(ga.id,ga.approve);},disableAutoRefresh:function(){clearTimeout(this.timerId);},isInVideoEncodingMode:function(){return this.encodingMode;},enableAutoRefresh:function(fa){this.encodingMode=true;this.timerId=window.location.reload.bind(window.location).defer(fa);},setHasLocation:function(fa){k.conditionClass(this.root,'hasLocation',fa);}});e.exports=ea;});
__d("legacy:fb-photos-permalink-js",["PhotoPermalink"],function(a,b,c,d){a.PhotoPermalink=b('PhotoPermalink');},3);
function PhotoPermalinkTagger(a){this.parent.construct(this,PhotoPermalink.getInstance());this.photoData=a;}Class.extend(PhotoPermalinkTagger,'PhotoTagger');copyProperties(PhotoPermalinkTagger.prototype,{elemNames:{0:{addTagLink:'div.fbPhotosPhotoActions',overlayActions:'div.fbPhotosPhotoButtons'}},setupHandlers:function(){var a=$('imagestage'),b=$('fbPhotoPageTagBoxes');this.handlers=[Event.listen(this.clickState,'click',this.addTag.bind(this)),Event.listen(a,'click',this.addTag.bind(this)),Event.listen(b,'click',this.addTag.bind(this)),Event.listen(this.addTagLink,'click',this.checkActions.bind(this)),Event.listen(this.overlayActions,'click',this.checkActions.bind(this))];this.subscriptions=[Arbiter.subscribe('PhotoPermalink.PAGE',this.restartTagging.bind(this)),Arbiter.subscribe('PhotoPermalink.DATA_CHANGE',this.setPhotoData.bind(this))];this.tokenizer.subscribe('addToken',this.saveTag.bind(this));this.tokenizer.subscribe('removeToken',this.removeTag.bind(this));this.tokenizer.subscribe('markTagAsSpam',this.markTagAsSpam.bind(this));},setDataForTokenizer:function(){this.tokenizer.setup(null,this.photoData);return this;}});
__d("PhotoCropper",["event-extensions","function-extensions","Arbiter","CSS","DOM","Form","Dialog","Keys","tx","Photocrop2","PhotoPermalink","ProfilePicRequestCreator","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('Arbiter'),h=b('CSS'),i=b('DOM'),j=b('Form'),k=b('Dialog'),l=b('Keys'),m=b('tx'),n=b('Photocrop2'),o=b('PhotoPermalink'),p=b('ProfilePicRequestCreator'),q=b('copyProperties'),r={initialize:function(s){this.clickHandlers=[];if(this.photocrop)this.destroy(false);this.photoPermalink=o.getInstance();this.root=this.photoPermalink.getRoot();this.options=s||{};this.registerClickHandler();this.registerEscapeKeyHandler();g.subscribe('PhotoPermalink.PAGE',function(){this.registerClickHandler();this.registerEscapeKeyHandler();this.destroy(false);}.bind(this),g.SUBSCRIBE_NEW);g.subscribe('PhotoTagger.REMOVED_MAKE_PROFILE_PIC_OPTION',this.destroy.bind(this,false));},registerEscapeKeyHandler:function(){Event.listen(document.documentElement,'keydown',function(event){if(Event.getKeyCode(event)===l.ESC)this.destroy(false);}.bind(this));},registerClickHandler:function(){this.actionLinks=i.find(this.root,'div.fbPhotosPhotoActions');var s=i.scry(this.actionLinks,'a.fbPhotoActionsCrop');if(s.length===0)return;var t=i.find(s[0],'.startCropping');if(this.clickHandlers.indexOf(t)!==-1)return;Event.listen(t,'click',function(){this.start();return false;}.bind(this));this.clickHandlers.push(t);},start:function(){if(this.photocrop)return;this.cropLink=i.find(this.actionLinks,'a.fbPhotoActionsCrop');if(h.hasClass(this.cropLink,'profileAlbum')){new k().setTitle("Make Profile Picture").setBody("You've used this photo as your profile picture before. Do you want to use it again?").setButtons([k.CONFIRM,k.CANCEL]).setModal(true).setHandler(function(){this.reuseProfilePic.bind(this).defer();return false;}.bind(this)).setCancelHandler(function(){this.cancelAndStopEvent();}.bind(this)).show();return false;}h.addClass(this.cropLink,'croppingModeOn');h.addClass(this.root,'croppingMode');var s=i.find(this.root,'img.fbPhotoImage'),t=i.find(this.root,'a.doneCroppingLink'),u=i.find(this.root,'a.cancelCroppingLink'),v=i.find(this.cropLink,'.doneCropping');this.wrapper=i.create('div');h.addClass(this.wrapper,'stageCropper');i.find(this.root,'.stageWrapper').appendChild(this.wrapper);this.wrapper.style.marginTop=s.parentNode.style.marginTop;Event.listen(this.wrapper,'click',function(event){Event.kill(event);});Event.listen(t,'click',this.done.bind(this));Event.listen(u,'click',this.cancelAndStopEvent.bind(this));Event.listen(v,'click',this.done.bind(this));var w={target:this.wrapper,min_width:this.options.min_width},x=(function(){this.photocrop=new n(s,w);}).bind(this);if(s.complete){x();}else Event.listen(s,'load',x);return false;},done:function(){var s=o.getInstance().getCurrentPhotoInfo(),t=this.getProfilePicTarget(s).id,u=this.destroy(true);if(!u)return false;new p(s.fbid,s.owner,t,u).setSuccessURI('profile.php?id='+t).setErrorURI('photo.php?pid='+s.pid+'&id='+s.owner).send();return false;},cancelAndStopEvent:function(){this.destroy(false);return false;},destroy:function(s){if(!this.photocrop){if(!s&&this.wrapper){i.remove(this.wrapper);this.wrapper=null;}return null;}h.removeClass(this.cropLink,'croppingModeOn');h.removeClass(this.root,'croppingMode');if(s){h.addClass(this.root,'profilePicSavingMode');}else{i.remove(this.wrapper);this.wrapper=null;}var t=this.photocrop.done(s);this.photocrop=null;return t;},reuseProfilePic:function(){var s=o.getInstance().getCurrentPhotoInfo(),t=this.getProfilePicTarget(s),u=q({pid:s.pid,owner:s.owner,id:t.id,type:t.type,profile_pic_id:t.id});j.post('/pic_upload.php',u);return false;},getProfilePicTarget:function(s){if(h.hasClass(this.cropLink,'makePageProfile'))return {id:s.owner,type:'object'};return {id:this.options.uid,type:'profile'};}};e.exports=r;});
__d("PhotoTags",["array-extensions","event-extensions","Arbiter","CSS","DOM","Parent","PhotosConst","copyProperties","cx","ge"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');var g=b('Arbiter'),h=b('CSS'),i=b('DOM'),j=b('Parent'),k=b('PhotosConst'),l=b('copyProperties'),m=b('cx'),n=b('ge');function o(p,q,r){this.tagTargets=p;this.tagBox=q;this.version=r||k.VIEWER_PERMALINK;this.handlers=[];this.tagTargets.forEach(function(s){this.handlers.push(Event.listen(s,{mouseover:this.showTag.bind(this),mouseout:this.hideTags.bind(this)}));}.bind(this));this.subscriptions=[];if(this.version==k.VIEWER_SNOWLIFT)this.subscriptions.push(g.subscribe("PhotoSnowlift.PAGE",this.hideTags.bind(this)));}l(o.prototype,{showTag:function(event){var p=event.getTarget(),q=h.hasClass(p,'taggee'),r=h.hasClass(p,"_rx"),s=null;if(q){s=p.getAttribute('data-tag');}else if(r){var t=j.byTag(p,'a');s=t&&t.getAttribute('data-tag');}if(!s){p=j.byClass(p,'taggee');if(p)s=p.getAttribute('data-tag');}var u=this.version==k.VIEWER_PERMALINK?'perm:tag:'+s:'tag:'+s,v=u&&n(u);if(v){h.addClass(v,'showTag');h.addClass(this.tagBox,'showingTag');}},hideTags:function(){h.removeClass(this.tagBox,'showingTag');i.scry(this.tagBox,'div.showTag').forEach(function(p){h.removeClass(p,'showTag');});},destroy:function(){for(var p in this.handlers)this.handlers[p].remove();this.subscriptions.forEach(g.unsubscribe.bind(g));}});e.exports=o;});
__d("legacy:PhotoTags",["PhotoTags"],function(a,b,c,d){a.PhotoTags=b('PhotoTags');},3);
__d("TagToken",["Class","DOM","Token","copyProperties"],function(a,b,c,d,e,f){var g=b('Class'),h=b('DOM'),i=b('Token'),j=b('copyProperties');function k(l){this.parent.construct(this,l,'tag');}g.extend(k,i);j(k.prototype,{createElement:function(){var l=this.isFreeform(),m=h.create('span',{className:'separator'},', '),n=h.create(l?'span':'a',{className:'taggee','data-tag':this.getValue()},this.getText());if(!l)n.href=this.getInfo().path;return h.create('span',{className:'tagItem'},[m,n]);}});e.exports=k;});
__d("TagTokenizer",["Arbiter","Bootloader","Class","CSS","DOM","Input","Parent","PhotosConst","TagToken","Tokenizer","copyProperties","createObjectFrom","ge","tx"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('Bootloader'),i=b('Class'),j=b('CSS'),k=b('DOM'),l=b('Input'),m=b('Parent'),n=b('PhotosConst'),o=b('TagToken'),p=b('Tokenizer'),q=b('copyProperties'),r=b('createObjectFrom'),s=b('ge'),t=b('tx');function u(v,w,x,y){this.parent.construct(this,x,y);g.subscribe('PhotoInlineEditor.CANCEL_INLINE_EDITING',this.updateTokenareaVisibility.bind(this),g.SUBSCRIBE_NEW);this.appphoto=w;g.subscribe(v.getInstance().getEventString('DATA_CHANGE'),this.setup.bind(this),g.SUBSCRIBE_NEW);}i.extend(u,p);q(u.prototype,{setup:function(v,w){this.appphoto=w.byapp;this.byowner=w.isowner;return this.reset();},reset:function(){var v=this.getTokenElements().map(this.getTokenDataFromTag.bind(this));this.withTagKeys={};var w=this.getWithTagTokenElements().map(function(x){return this._tokenKey(this.getTokenDataFromTag(x));}.bind(this));this.withTagKeys=r(w);return this.parent.reset(v);},processEvents:function(event,v,w){if(m.byClass(v,'remove')){var x=this.getTokenFromElement(w);x=this.addTokenData(x,v);this.removeToken(x);event.kill();}},insertToken:function(v){return null;},removeToken:function(v){if(this.appphoto){return this.replaceToken(v);}else{this.inform('removeToken',v);g.inform('Form/change',{node:this.element});}},addTokenData:function(v,w){if(m.byClass(w,'blockuser'))v.blockUser=true;return v;},getTokenDataFromTag:function(v){return {uid:k.find(v,'input').value,text:k.getText(k.find(v,'.taggee'))};},getTokenElementFromTarget:function(v){return m.byClass(v,'tagItem');},getTokenElements:function(){return k.scry(this.tokenarea,'span.tagItem').filter(this.filterNonTokenElements.bind(this));},getWithTagTokenElements:function(){return k.scry(this.tokenarea,'span.withTagItem');},filterNonTokenElements:function(v){return !j.hasClass(v,'markasspam')&&!j.hasClass(v,'reported')&&!j.hasClass(v,'withTagItem');},createToken:function(v,w){var x=this.getToken(this._tokenKey(v));x=x||new o(v);w&&x.setElement(w);return x;},updateTokenareaVisibility:function(){var v=this.getTokenElements().filter(function(x){return j.shown(x);}),w=this.getWithTagTokenElements();j.conditionShow(this.tokenarea,v.length!==0||w.length!==0);},replaceToken:function(v){if(!v)return;var w=this.tokens.indexOf(v);if(w<0)return;this.tokens.splice(this.tokens.indexOf(v),1);delete this.unique[this._tokenKey(v.getInfo())];var x=s('tagspam'+v.getValue());x&&k.remove(x);var y=[' [',"Tag Removed.",' '];y.push(k.create('a',{onclick:this.markAsSpam.bind(this,v.getValue())},"Mark tag as spam"));y.push('] ');var z=k.create('span',{className:'fbPhotosTaglistTag tagItem markasspam',id:'tagspam'+v.getValue()},y);k.replace(v.getElement(),z);this.updateTokenarea();this.inform('removeToken',v);g.inform('Form/change',{node:this.element});},markAsSpam:function(v){var w=s('tagspam'+v),x=[' [',"Tag Reported",'] '],y=k.create('span',{className:'fbPhotosTaglistTag tagItem reported',id:'tagspam'+v},x);k.replace(w,y);this.inform('markTagAsSpam',v);}});e.exports=u;});
__d("TagTypeaheadView",["AsyncRequest","Class","TypeaheadView","copyProperties"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('Class'),i=b('TypeaheadView'),j=b('copyProperties');function k(l,m){this.parent.construct(this,l,m);this.hintText=m.hintText;this.userEd=m.userEd;this.origAutoSelect=m.autoSelect;this.setSuggestions(m.suggestions);}h.extend(k,i);j(k.prototype,{buildResults:function(l){if(!this.value)l.unshift({subtext:this.hintText,type:'hintText'});if(this.userEd){new g().setURI('/ajax/fof/user_education.php').setData({increment:1}).send();l.unshift({subtext:this.userEd,type:'userEdText'});}var m=this.parent.buildResults(l);if(this.userEd)l.shift();if(!this.value)l.shift();return m;},render:function(l,m,n){this.autoSelect=this.origAutoSelect&&l.length;this.disableAutoSelect=l.length===0;this.parent.render(l,m,n);},getItems:function(){var l=this.parent.getItems();if(!this.value)l.shift();if(this.userEd)l.shift();return l;},getSuggestions:function(){return this.suggestions;},setSuggestions:function(l){this.suggestions=l||[];this.visible=!!this.suggestions;},addSuggestion:function(l){this.suggestions.unshift(l);}});e.exports=k;});
__d("legacy:FreeformTokenizerBehavior",["FreeformTokenizerBehavior"],function(a,b,c,d){var e=b('FreeformTokenizerBehavior');if(!a.TokenizerBehaviors)a.TokenizerBehaviors={};a.TokenizerBehaviors.freeform=e;},3);
__d("TypeaheadHintText",["copyProperties","emptyFunction"],function(a,b,c,d,e,f){var g=b('copyProperties'),h=b('emptyFunction');function i(j){this._typeahead=j;}g(i.prototype,{enable:function(){this._typeahead.getCore().resetOnKeyup=false;},disable:h});e.exports=i;});
__d("legacy:HintTextTypeaheadBehavior",["TypeaheadHintText"],function(a,b,c,d){var e=b('TypeaheadHintText');if(!a.TypeaheadBehaviors)a.TypeaheadBehaviors={};a.TypeaheadBehaviors.hintText=function(f){f.enableBehavior(e);};},3);