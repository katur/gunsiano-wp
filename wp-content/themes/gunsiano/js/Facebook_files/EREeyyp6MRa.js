/*1355747085,173213215*/

if (self.CavalryLogger) { CavalryLogger.start_js(["HTGjs"]); }

__d("AggregatedMapCalloutOrientation",["copyProperties"],function(a,b,c,d,e,f){var g=b('copyProperties'),h={};g(h,{TOP:'fbMapCalloutUseArrowTop',LEFT:'fbMapCalloutUseArrowLeft',RIGHT:'fbMapCalloutUseArrowRight',BOTTOM:'fbMapCalloutUseArrowBottom',ALWAYS_ON_MAP:'alwaysOnMap'});e.exports=h;});
__d("AggregatedMapCallout",["AggregatedMapCalloutOrientation","CSS","DOM","Style","Vector","copyProperties"],function(a,b,c,d,e,f){var g=b('AggregatedMapCalloutOrientation'),h=b('CSS'),i=b('DOM'),j=b('Style'),k=b('Vector'),l=b('copyProperties'),m=16,n=10,o=10;function p(q,r,s){this.map=q;this.contentContainer=null;this.width=null;this.height=null;this.anchor=null;this.orientation=g.RIGHT;this.arrowYOffset=null;this.arrowXOffset=null;this.border=r;this.contentContainer=i.find(this.border,'.fbMapCalloutContent');this.arrowWrap=i.find(this.border,'.fbMapCalloutArrowWrap');this.arrowL=i.find(this.border,'.fbMapCalloutArrowLeft');this.arrowR=i.find(this.border,'.fbMapCalloutArrowRight');this.arrowT=i.find(this.border,'.fbMapCalloutArrowTop');this.arrowB=i.find(this.border,'.fbMapCalloutArrowBottom');this._updateDimensions();}l(p.prototype,{setOrientation:function(q){this.orientation=q;},getOrientation:function(){return this.orientation;},getAnchor:function(){return this.anchor;},close:function(){this.anchor=null;this._map_updatePosition();},setContent:function(q){i.setContent(this.contentContainer,q);this._updateDimensions();},getContent:function(){return this.contentContainer;},recalculateArrowYOffset:function(q){if(!this.anchor)return;var r=this.map._callout_determineArrowYOffset(this,q,this.width,this.height);this.setArrowYOffset(r);this._map_updatePosition();},_updateDimensions:function(){h.show(this.border);this.width=k.getElementDimensions(this.border).x;this.height=k.getElementDimensions(this.border).y;this.setArrowXOffset(this.width/2);this.setArrowYOffset(this.height/2);h.hide(this.border);},_map_moveTo:function(q,r){this.anchor=q;this.map._callout_panTo(q,this,r);this._map_updatePosition();},_map_updatePosition:function(){var q=this.anchor&&this.map._callout_getAnchorBounds(this.anchor);if(q===null){h.hide(this.border);return;}var r,s,t,u,v=n,w=this.orientation;if(this.orientation===g.ALWAYS_ON_MAP){var x=q.getCenter().x,y=q.getCenter().y;if(x<0&&y<0){s=o;r=o;}else if(x>this.map.ww&&y<0){t=o;r=o;}else if(x>this.map.ww&&y>this.map.hh){t=o;u=o;}else if(x<0&&y>this.map.hh){s=o;u=o;}else if(x<0){w=g.RIGHT;s=o;r=q.calloutY-this.arrowYOffset;}else if(x>this.map.ww){w=g.LEFT;t=o;r=q.calloutY-this.arrowYOffset;}else if(y<0){w=g.BOTTOM;r=o;s=(q.l+q.r)/2-this.arrowXOffset;}else if(y>this.map.hh){w=g.TOP;u=o;s=(q.l+q.r)/2-this.arrowXOffset;}else{r=q.calloutY-this.arrowYOffset;if(x<this.map.ww/2){s=q.r+v;w=g.RIGHT;}else{s=q.l-v-this.width;w=g.LEFT;}}}switch(this.orientation){case g.LEFT:s=q.l-v-this.width;r=q.calloutY-this.arrowYOffset;break;case g.RIGHT:s=q.r+v;r=q.calloutY-this.arrowYOffset;break;case g.TOP:r=q.t-v-this.height;s=(q.l+q.r)/2-this.arrowXOffset;break;case g.BOTTOM:r=q.b+v;s=(q.l+q.r)/2-this.arrowXOffset;break;}h.setClass(this.arrowWrap,w);this._setPosition('top',r);this._setPosition('right',t);this._setPosition('bottom',u);this._setPosition('left',s);h.show(this.border);},_setPosition:function(q,r){if(r!==undefined){r+='px';}else r='auto';j.set(this.border,q,r);},setArrowXOffset:function(q){this.arrowXOffset=q;q-=Math.round(m/2);j.set(this.arrowT,'left',q+'px');j.set(this.arrowB,'left',q+'px');},setArrowYOffset:function(q){this.arrowYOffset=q;q-=Math.round(m/2);j.set(this.arrowL,'top',q+'px');j.set(this.arrowR,'top',q+'px');}});l(p,{throbber:function(q){q=q||this.DEFAULT_CALLOUT_WIDTH;var r=i.create('div',{}),s=i.create('img',{src:'/images/loaders/indicator_blue_small.gif'});h.setClass(r,'fbAggregatedMapCalloutThrobberDiv');j.set(r,'width',q+'px');h.setClass(s,'fbAggregatedMapCalloutThrobber');i.setContent(r,s);return r;},ARROW_HEIGHT_PLUS_PADDING:n,ARROW_WIDTH:m});e.exports=p;});
__d("AggregatedMapMarker",["DOM","Style","copyProperties"],function(a,b,c,d,e,f){var g=b('DOM'),h=b('Style'),i=b('copyProperties');function j(k,l){this._root=k;this._sprite=l;}i(j.prototype,{setPosition:function(k){var l=k.y-this._sprite.getAnchorY(),m=k.x-this._sprite.getAnchorX();h.set(this._root,'top',l+'px');h.set(this._root,'left',m+'px');},setOnClick:function(k){this._root.onclick=k;},setOnMouseover:function(k){this._root.onmouseover=k;},setOnMouseout:function(k){this._root.onmouseout=k;},remove:function(){g.remove(this._root);},getElement:function(){return this._root;}});e.exports=j;});
__d("AggregatedMapGroup",["AggregatedMapMarker","DOM","Rect","Style","clip","copyProperties"],function(a,b,c,d,e,f){var g=b('AggregatedMapMarker'),h=b('DOM'),i=b('Rect'),j=b('Style'),k=b('clip'),l=b('copyProperties');function m(n,o,p,q){this._boundingBox=o;this._sprite=p;this._marker=null;this._mapToPixel=q;this.pins=n;this.deleted=false;}l(m.prototype,{getType:function(){return 'AggregatedMapGroup';},getCenter:function(){return this._mapToPixel(this._boundingBox.getCenter());},hasMarker:function(){return !!this._marker;},dismissMarker:function(){if(this._marker){this._marker.remove();this._marker=null;}},getMarker:function(){return this._marker&&this._marker.getElement();},getSprite:function(){return this._sprite;},updatePosition:function(n){if(!this._marker)return;var o=this.getCenter();this._marker.setPosition(o);},getSpriteBounds:function(){var n=this._sprite,o=this.getCenter().y-n.getAnchorY(),p=this.getCenter().x-n.getAnchorX(),q=p+n.getWidth(),r=o+n.getHeight(),s=new i(o,q,r,p);s.calloutY=o+n.getCalloutY();return s;},renderMarker:function(n){if(!this._marker){var o=this._sprite.render();this._marker=new g(o,this._sprite);if(this.pins.length==1){var p=1000+k(Math.floor(this.getCenter().y),0,4000);j.set(o,'z-index',Math.floor(p));}h.appendContent(n,o);}return this._marker;},add:function(n,o){return this._boundingBox.add(n,o);}});e.exports=m;});
__d("AggregatedMapOptions",[],function(a,b,c,d,e,f){function g(){this.calloutWidth=null;this.maxCalloutHeight=null;}e.exports=g;});
__d("MapAggregation",["Vector","copyProperties"],function(a,b,c,d,e,f){var g=b('Vector'),h=b('copyProperties');function i(){this.combine=null;this.iterations=0;this.candidates=null;this.loners=null;}h(i.prototype,{aggregate:function(j,k,l){this.overlap=l?l:this._overlap;this.candidates=j;this.combine=k;this.loners=[];while(this.candidates.length>0){var m=this.candidates[this.candidates.length-1],n;do{var o=m.center;this._group(m,Number.MAX_VALUE);n=o!==m.center;}while(!this._isDeleted(m)&&n);if(!this._isDeleted(m)){this.candidates.remove(m);this.loners.push(m);}}return this.loners;},_isDeleted:function(j){return j.center===null;},_delete:function(j){this.candidates.remove(j);this.loners.remove(j);j.center=null;},_group:function(j,k){while(true){this.iterations++;if(this.iterations>=10000){this.iterations%10000===0&&0;return;}var l=this._nearest(j),m=l.nearest,n=l.distanceSquared;if(!m||n>k||!this.overlap(j,m))return;var o=m.center,p=j.center;this._group(m,n-1);if(this._isDeleted(j))return;var q=m.center!==o,r=j.center!==p;if(!q&&!r){this.combine(j,m);this._delete(m);return;}}},_nearest:function(j){var k,l,m,n=null,o=Number.MAX_VALUE;for(k=0;k<this.candidates.length;k++){m=this.candidates[k];if(m===j)continue;l=this._distanceSquared(j,m);if(l<o){n=m;o=l;}}for(k=0;k<this.loners.length;k++){m=this.loners[k];if(m===j)continue;l=this._distanceSquared(j,m);if(l<o){n=m;o=l;}}return {nearest:n,distanceSquared:o};},_overlap:function(j,k){var l=j.radius+k.radius;return this._distanceSquared(j,k)<l*l;},_distanceSquared:function(j,k){var l=j.center.x-k.center.x,m=j.center.y-k.center.y;return l*l+m*m;}});e.exports=i;});
__d("AggregatedMap",["event-extensions","AggregatedMapCallout","AggregatedMapCalloutOrientation","AggregatedMapGroup","AggregatedMapOptions","Arbiter","BingMapCoordinate","BingMaps","CSS","DOM","GeoRectangle","MapAggregation","MapRects","Rect","Style","Vector","clip","copyProperties","csx","mod","$"],function(a,b,c,d,e,f){b('event-extensions');var g=b('AggregatedMapCallout'),h=b('AggregatedMapCalloutOrientation'),i=b('AggregatedMapGroup'),j=b('AggregatedMapOptions'),k=b('Arbiter'),l=b('BingMapCoordinate'),m=b('BingMaps'),n=b('CSS'),o=b('DOM'),p=b('GeoRectangle'),q=b('MapAggregation'),r=b('MapRects'),s=b('Rect'),t=b('Style'),u=b('Vector'),v=b('clip'),w=b('copyProperties'),x=b('csx'),y=b('mod'),z=b('$'),aa=9000,ba=10,ca=7,da=100,ea=50,fa=500,ga=409,ha=90,ia=90,ja=365,ka=.15,la=10,ma=10,na=10,oa=new s(50,50,50,50);function pa(){this.visiblePins=[];this.groups=[];this.renderOffset={x:0,y:0};this.canvas=null;this.ww=null;this.hh=null;this.callouts=[];this.futureHeight=null;this.futureWidth=null;this.pad={t:0,r:0,b:0,l:0};this.lastRender=null;this.zoom=2;this.topLeft=l.fromLatLong(0,0);this.topLeft.setZoom(this.zoom);this.zoomStack=[];this.arrowYOffset=ia;this.padding=da+ea;this.initialized=false;this.mapReady=false;this.iframeReady=false;this.initialPinsToHide=[];this.initialView=null;}w(pa.prototype,{CALLOUT_MARGIN:10,noPanningStrategy:function(qa){return this._noPan.bind(this,qa);},leftRightNoPanningStrategy:function(){return this._leftRightNoPan.bind(this);},anchoredPanningStrategy:function(qa,ra){return this._anchoredPan.bind(this,qa,ra);},smartPanningStrategy:function(qa,ra){return this._smartPan.bind(this,qa,ra);},setPins:function(qa){this._assertInitialized();this.visiblePins=qa;this.calloutAnchor=null;this._setZoomButtonVisibility();this._aggregate();},getGroups:function(){return this.groups;},getBounds:function(){var qa=m.xyToLatLong(this._pixelToMap(new u(0,0)),this.zoom),ra=m.xyToLatLong(this._pixelToMap(new u(this._getW(),this._getH())),this.zoom);return new p(qa.latitude,qa.longitude,ra.latitude,ra.longitude);},pushView:function(){this._assertInitialized();this.zoomStack.push(this._getMapView());},zoomIntoOne:function(qa,ra){this._assertInitialized();this.pushView();this.zoomToOne(qa,ra);},zoomToOne:function(qa,ra,sa){this.zoomToOneTight(qa,ra,0,sa);},zoomToOneTight:function(qa,ra,sa,ta){this._assertInitialized();ra=ra||new u(0,0);sa=sa||0;ta=ta||false;sa=Math.max(this._findMinZoomWherePinIsAlone(qa),sa,this.zoom);qa.setZoom(sa);var ua=qa.anchor.add(ra.mul(-1));this.iframeArbiter.inform('AggregatedMap/setView',{zoom:sa,center:{latitude:ua.getLatitude(),longitude:ua.getLongitude()},animate:ta},k.BEHAVIOR_PERSISTENT);},zoomInto:function(qa){this._assertInitialized();this.pushView();this.zoomTo(qa);},removePin:function(qa){this._assertInitialized();var ra=[];for(var sa=0;sa<this.visiblePins.length;sa++)if(this.visiblePins[sa]!==qa)ra.push(this.visiblePins[sa]);this.visiblePins=ra;this._aggregate();},addPin:function(qa){this._assertInitialized();this.visiblePins.push(qa);this._aggregate();},zoomOut:function(){this._assertInitialized();this.logger&&this.logger.bump('zoom-out');this.zoomDelta(-1,true);},zoomIn:function(){this._assertInitialized();this.logger&&this.logger.bump('zoom-in');this.zoomDelta(1,true);},zoomBack:function(){this._assertInitialized();this.logger&&this.logger.bump('snap-back');var qa;if(this.zoomStack.length){qa=this.zoomStack.pop();}else{qa={};w(qa,this.initialView);qa.zoom=Math.min(qa.zoom,this.zoom);}this.iframeArbiter.inform('AggregatedMap/setView',qa);},setInitialView:function(){this._assertInitialized();this.initialView=this._getMapView();var qa=o.scry(this.canvas,"span.__0")[0];qa&&n.hide(qa);},closeCalloutAndZoomBack:function(){this._assertInitialized();this.hideCallout();this.zoomBack();},onAddPin:function(qa,ra){var sa=ra.pin,ta=ra.content;this.hideCallout();this.addPin(sa);this.zoomIntoOne(sa);this.openCallout(sa,ta);},zoomDelta:function(qa,ra){var sa=null;if(ra&&this._getPrimaryCalloutAnchorGroup()){sa=this._getPrimaryCalloutAnchorGroup().getCenter();if(!r.containsPoint(new s(0,this.ww,this.hh,0),sa))sa=null;}this.iframeArbiter.inform('AggregatedMap/zoom',{zoom:qa,anchor:sa});},getZoom:function(){return this.zoom;},setView:function(qa){this._assertInitialized();this.iframeArbiter.inform('AggregatedMap/setView',qa);},resizingTo:function(qa,ra){this._assertInitialized();this.futureWidth=qa;this.futureHeight=ra;},setViewportPadding:function(qa,ra,sa,ta){this.pad.t=qa;this.pad.r=ra;this.pad.b=sa;this.pad.l=ta;},redraw:function(){this._assertInitialized();this._aggregate();},zoomTo:function(qa,ra){this._assertInitialized();if(qa.length<1)return;var sa=l.MAX_ZOOM;if(qa.length<la)while(this._aggregateZoom(qa,sa-1).length==qa.length&&sa>=ma)sa--;var ta=[];for(var ua=0;ua<qa.length;ua++){var va={latitude:qa[ua].getLatitude(),longitude:qa[ua].getLongitude()};ta.push(va);}var wa=m.getViewForLatLongs(this.ww,this.hh,ta,oa,l.MIN_ZOOM,sa);delete wa.height;delete wa.width;wa.animate=ra;this.iframeArbiter.inform('AggregatedMap/setView',wa,k.BEHAVIOR_PERSISTENT);},hideCallout:function(qa){this._assertInitialized();var ra=this._getPrimaryCallout().getAnchor();this._getPrimaryCallout().close();if(ra&&!qa)this._inform('calloutHidden');},throbber:function(qa){qa=qa||ga;return g.throbber(qa);},openCallout:function(qa,ra,sa){if(this._getTooltipCallout().getAnchor()===qa)this._getTooltipCallout().close();this._getPrimaryCallout().setContent(ra);this._getPrimaryCallout()._map_moveTo(qa,sa);return this._getPrimaryCallout();},getCallout:function(){return this._getPrimaryCallout();},openTooltip:function(qa,ra,sa){if(this._getPrimaryCallout().getAnchor()===qa)return;this._getTooltipCallout().setContent(ra);this._getTooltipCallout()._map_moveTo(qa,sa);return this._getTooltipCallout();},getTooltip:function(){return this._getTooltipCallout();},_callout_getAnchorBounds:function(qa){var ra=this._getCalloutAnchorGroup(qa),sa=ra&&ra.getSpriteBounds();return sa;},_callout_panTo:function(qa,ra,sa){var ta=this._callout_getAnchorBounds(qa),ua=sa?sa(ra,ta):null;if(ua){var va=m.xyToLatLong(this._pixelToMap(ua),this.zoom);this.iframeArbiter.inform('AggregatedMap/setView',{center:va});}},_callout_determineArrowYOffset:function(qa,ra,sa,ta){var ua=this._callout_getAnchorBounds(qa.getAnchor()),va=new u((ua.l+ua.r)/2,ua.calloutY),wa=ta/2,xa=this._getVisibleBounds(),ya=r.containsPoint(this._getNoPanBounds(),va,1),za=wa;if(ra||ya){var ab=xa.t+wa+this.CALLOUT_MARGIN,bb=xa.b-(ta-wa)-this.CALLOUT_MARGIN;za+=va.y-v(va.y,ab,bb);}za=v(za,g.ARROW_WIDTH/2,ta-g.ARROW_WIDTH/2);return za;},_createCallout:function(qa){var ra=o.scry(this.canvas,'.fbAggregatedMapCalloutShell')[0],sa=ra.cloneNode(true);o.appendContent(this.canvas,sa);t.set(sa,'z-index',qa);var ta=new g(this,sa);this.callouts.push(ta);return ta;},_getPrimaryCallout:function(){this.primaryCallout=this.primaryCallout||this._createCallout(aa);return this.primaryCallout;},_getTooltipCallout:function(){this.tooltipCallout=this.tooltipCallout||this._createCallout(aa+1);return this.tooltipCallout;},_assertInitialized:function(){},_init:function(qa,ra,sa,ta,ua,va,wa,xa){this.iframeArbiter=ra;this.logger=wa;this.canvas=sa;this.instanceid=ta;this.ww=ua.width;this.hh=ua.height;this.maxCalloutWidth=ua.maxCalloutWidth||this.ww-ba;this.maxCalloutHeight=ua.maxCalloutHeight||this.hh-ba;if(navigator.userAgent.toLowerCase().indexOf('khtml')>=0){document.addEventListener('mouseup',this._reroute.bind(this),false);document.addEventListener('mousemove',this._reroute.bind(this),false);}this.listeners=[];this.listeners.push(k.subscribe('onload/exit',this._onBeforeLeave.bind(this)));this.iframeListeners=[this.onViewChangeToken=this.iframeArbiter.subscribe('AggregatedMap/viewchanged',this._onViewChange.bind(this)),this.onViewChangeToken=this.iframeArbiter.subscribe('AggregatedMap/viewchangeend',this._onViewChangeEnd.bind(this)),this.onClickToken=this.iframeArbiter.subscribe('AggregatedMap/click',this._onMapClick.bind(this)),this.iframeReadyToken=this.iframeArbiter.subscribe('AggregatedMap/iframeReady',this._iframeReady.bind(this))];for(var ya in pa.Listeners)this._subscribe('AggregatedMap/'+ya,this[ya].bind(this));this.initialized=true;for(var za=0;za<va.length;za++)va[za].xhp&&this.initialPinsToHide.push(va[za].xhp);va.length&&this.setPins(va);if(xa){va[0].setCallout(z(xa));this._getPrimaryCallout()._map_moveTo(va[0],this.noPanningStrategy(h.TOP));}n.hide(o.scry(this.canvas,'.fbAggregatedMapCalloutShell')[0]);this._notifyIfReady();},_guard:function(qa){return function(ra,sa){if(!(!sa||!sa._instanceid))if(sa._instanceid===this.instanceid)return qa(ra,sa);}.bind(this);},_subscribe:function(qa,ra){this.listeners.push(k.subscribe(qa,this._guard(ra)));},_inform:function(qa,ra,sa){ra=ra||{};ra._instanceid=this.instanceid;k.inform('AggregatedMap/'+qa,ra,sa);},_bubbleClick:function(qa){this._inform(pa.Events.bubbleClick,qa);},_bubbleMouseover:function(qa){this._inform(pa.Events.bubbleMouseover,qa);},_bubbleMouseout:function(qa){this._inform(pa.Events.bubbleMouseout,qa);},_pinClick:function(qa){if(qa._agg_map_callout)if(this.getCallout().getAnchor()===qa){this.hideCallout();}else this.openCallout(qa,qa._agg_map_callout);this._inform(pa.Events.pinClick,qa);},_pinMouseover:function(qa){if(qa.name){var ra=o.create('span');n.addClass(ra,'fbAggregatedMapTooltipText');o.setContent(ra,qa.name);this.openTooltip(qa,ra,this.leftRightNoPanningStrategy());}this._inform(pa.Events.pinMouseover,qa);},_pinMouseout:function(qa){if(this.tooltipCallout&&this.tooltipCallout.getAnchor()===qa&&qa.name)this.tooltipCallout.close();this._inform(pa.Events.pinMouseout,qa);},_reroute:function(qa){var ra=u.getElementPosition(this.canvas).sub(u.getScrollPosition());this.iframeArbiter.inform('AggregatedMap/mouseEvent',{e:qa,offset:ra});},_getVisibleBounds:function(){return new s(this.pad.t,this._getW()-this.pad.r,this._getH()-this.pad.b,this.pad.l);},_findMinZoomWherePinIsAlone:function(qa){if(this.visiblePins.length<2)return l.MIN_ZOOM;var ra=Number.MAX_VALUE,sa=null,ta=qa.anchor.getAbsoluteXY();for(var ua=0;ua<this.visiblePins.length;ua++){var va=this.visiblePins[ua],wa=va.anchor.getAbsoluteXY().distanceTo(ta);if(wa<ra&&va!==qa){ra=wa;sa=va;}}var xa=qa.getAggregationRadius()+sa.getAggregationRadius(),ya=l.MAX_ZOOM;while(ra/2>xa&&ya>l.MIN_ZOOM){ya--;ra/=2;}while(ya<l.MAX_ZOOM){var za=this._aggregateZoom(this.visiblePins,ya),ab=false;for(var bb=0;bb<za.length;bb++){var cb=za[bb];if(cb.members.length==1&&cb.members[0]===qa)return ya;}ya++;}return ya;},_smartPan:function(qa,ra,sa,ta){qa=qa||this.maxCalloutWidth;ra=ra||this.maxCalloutHeight;var ua=r.pad(new s(ha,this._getW(),this._getH()-(ra-ja),0),-this.CALLOUT_MARGIN+fa),va=new u(ta.getCenter().x,ta.calloutY);if(r.containsPoint(ua,va)){var wa=this._getVisibleBounds(),xa=va.sub(r.boundPoint(this._getNoPanBounds(),va)),ya=ta.w()/2+g.ARROW_HEIGHT_PLUS_PADDING+qa+this.CALLOUT_MARGIN;if(va.x>wa.getCenter().x){sa.setOrientation(h.LEFT);if(!xa.x)xa.x=va.x-Math.max(va.x,ya+wa.l);}else{sa.setOrientation(h.RIGHT);if(!xa.x)xa.x=va.x-Math.min(va.x,wa.r-ya);}var za=null;if(xa.magnitude()>=1)za=new u(this._getW()/2+xa.x,this._getH()/2+xa.y);return za;}return this._anchoredPan(pa.Anchor.DEFAULT,h.RIGHT,this._getPrimaryCallout(),ta);},_leftRightNoPan:function(qa,ra){if(ra.getCenter().x>this._getVisibleBounds().getCenter().x){qa.setOrientation(h.LEFT);}else qa.setOrientation(h.RIGHT);},_noPan:function(qa,ra,sa){ra.setOrientation(qa);},_anchoredPan:function(qa,ra,sa,ta){var ua=this._getVisibleBounds();sa.setOrientation(ra);if(qa===pa.Anchor.DEFAULT)qa=new u(ua.getCenter().x-this.maxCalloutWidth/2-ta.w()/2,ua.getCenter().y-ka*this._getH()-ia+g.ARROW_WIDTH/2);return ta.getCenter().sub(qa).add(new u(this._getW()/2,this._getH()/2));},_getMapSize:function(){return m.mapSize(this.zoom);},_getMapView:function(){var qa=m.xyToLatLong(this._pixelToMap(new u(this._getW()/2,this._getH()/2)),this.zoom);return {zoom:this.zoom,center:qa};},_renderOverlay:function(){if(!this.mapReady)return;this.lastRender=this.topLeft;var qa,ra=new s(-this.padding,this._getW()+this.padding,this._getH()+this.padding,-this.padding);for(var sa=0;sa<this.groups.length;sa++){qa=this.groups[sa];var ta=qa.getCenter();if(r.containsPoint(ra,ta)){var ua=qa.renderMarker(this.canvas);if(qa.pins.length>1){ua.setOnClick(this._bubbleClick.bind(this,qa));ua.setOnMouseover(this._bubbleMouseover.bind(this,qa));ua.setOnMouseout(this._bubbleMouseout.bind(this,qa));}else{ua.setOnClick(this._pinClick.bind(this,qa.pins[0]));ua.setOnMouseover(this._pinMouseover.bind(this,qa.pins[0]));ua.setOnMouseout(this._pinMouseout.bind(this,qa.pins[0]));}}else qa.dismissMarker();}this._position();while(this.initialPinsToHide.length)n.hide(this.initialPinsToHide.pop());},_mapToPixel:function(qa){return this._mapToPixelBounds(qa,-this.padding,this._getW()+this.padding);},_mapToPixelBounds:function(qa,ra,sa){var ta=qa.sub(this.topLeft.getMapXY());if(ta.x<ra&&ta.x+this._getMapSize()<sa){ta.x+=this._getMapSize();}else if(ta.x>sa&&ta.x-this._getMapSize()>ra)ta.x-=this._getMapSize();return ta;},_pixelToMap:function(qa){var ra=qa.add(this.topLeft.getMapXY());ra.x=y(ra.x,this._getMapSize());return ra;},_getNoPanBounds:function(){var qa=this._getVisibleBounds();return r.pad(new s(qa.t+ha,qa.r,qa.b-(this.maxCalloutHeight-ja),qa.l),-this.CALLOUT_MARGIN);},_getCalloutAnchorGroup:function(qa){return qa&&(qa.group||qa);},_getPrimaryCalloutAnchorGroup:function(){return this._getCalloutAnchorGroup(this._getPrimaryCallout().getAnchor());},updateCallouts:function(){for(var qa=0;qa<this.callouts.length;qa++)this.callouts[qa]._map_updatePosition();},_setZoomButtonVisibility:function(){var qa=o.scry(this.canvas,"label.__1")[0],ra=o.scry(this.canvas,"label.__2")[0];qa&&n.conditionClass(qa,"uiButtonDisabled",this.zoom>=l.MAX_ZOOM);ra&&n.conditionClass(ra,"uiButtonDisabled",this.zoom<=l.MIN_ZOOM);},_aggregate:function(){this.logger&&this.logger.startRun('_aggregate');var qa,ra=this._aggregateZoom(this.visiblePins,this.zoom),sa=[];for(var ta=0;ta<ra.length;ta++){var ua=[],va=ra[ta];qa=new i(va.members,va.rect,va.sprite,this._mapToPixel.bind(this));sa.push(qa);for(var wa=0;wa<va.members.length;wa++)va.members[wa].group=qa;}for(var xa=0;xa<this.groups.length;xa++){qa=this.groups[xa];qa.dismissMarker();qa.deleted=true;}for(var ya=0;ya<this.callouts.length;ya++)if(this.callouts[ya].getAnchor()&&this.callouts[ya].getAnchor().getType()==='AggregatedMapGroup')this.callouts[ya].close();this.groups=sa;this._renderOverlay();this.logger&&this.logger.endRun('_aggregate');},_combine:function(qa,ra){for(var sa=0;sa<ra.members.length;sa++)qa.members.push(ra.members[sa]);qa.rect=r.boundingBox(qa.rect,ra.rect);qa.sprite=qa.sprite.combine(ra.sprite);qa.radius=qa.sprite.getAggregationRadius();qa.center=qa.rect.getCenter();qa.single=0;return qa;},_overlap:function(qa,ra){var sa=qa.center.y-ra.center.y,ta=qa.center.x-ra.center.x;if(qa.single+ra.single==1)if(qa.single&&sa>ca/2){sa-=ca;}else if(ra.single&&-sa<ca/2)sa+=ca;var ua=qa.radius+ra.radius;return ta*ta+sa*sa<ua*ua;},_aggregateZoom:function(qa,ra){for(var sa=0;sa<qa.length;sa++){qa[sa].setZoom(ra);var ta=qa[sa].center;qa[sa].rect=new s(ta.y,ta.x,ta.y,ta.x);qa[sa].single=1;}var ua=[],va=[];for(var wa=0;wa<qa.length;wa++){var xa=qa[wa],ya={};w(ya,xa);ya.radius=xa.getAggregationRadius();ya.members=[xa];if(ya.radius){ua.push(ya);}else va.push(ya);}if(ra<l.MAX_ZOOM&&ua.length>1)ua=new q().aggregate(ua,this._combine.bind(this),this._overlap.bind(this));return ua.concat(va);},_position:function(){this.logger&&this.logger.ping();this.logger&&this.logger.startRun('_position');var qa=this._getW()/2;for(var ra=0;ra<this.groups.length;ra++)this.groups[ra].updatePosition(qa);this.updateCallouts();this.logger&&this.logger.endRun('_position');},_notifyIfReady:function(){if(this.initialized&&this.iframeReady)this._inform(pa.Events.ready,this,k.BEHAVIOR_STATE);},_getDims:function(){return new u(this._getW(),this._getH());},_getH:function(){return this.futureHeight||this.hh;},_getW:function(){return this.futureWidth||this.ww;},_onMapClick:function(qa){this._inform(pa.Events.mapClick);},_onViewChangeEnd:function(qa,ra){this._inform(pa.Events.viewChangeEnd,ra);},_onViewChange:function(qa,ra){this.mapReady=true;this._inform(pa.Events.viewChange,ra,k.BEHAVIOR_STATE);this.hh=ra.height;this.ww=ra.width;var sa=ra.zoom;this.topLeft=l.fromLatLong(ra.center).setZoom(sa).add(this._getDims().mul(-.5));if(this.zoom!==sa){this.zoom=sa;while(this.zoomStack.length&&this.zoom<=this.zoomStack[this.zoomStack.length-1].zoom)this.zoomStack.pop();this._setZoomButtonVisibility();this._aggregate();}else if(!this.lastRender||this.topLeft.calculateDistanceX(this.lastRender)>da||this.topLeft.calculateDistanceY(this.lastRender)>da){this._renderOverlay();}else this._position();var ta=o.scry(this.canvas,"span.__0")[0];ta&&n.conditionShow(ta,this._showSnapBack());},_showSnapBack:function(){if(this.zoomStack.length){return true;}else if(this.initialView){var qa=this.initialView;if(this.zoom>qa.zoom){return true;}else{var ra=this._getMapView(),sa=na/m.scale(1,this.zoom);return Math.abs(ra.center.latitude-qa.center.latitude)>sa||Math.abs(ra.center.longitude-qa.center.longitude)>sa;}}return false;},_iframeReady:function(qa,ra){this.iframeReady=true;this._notifyIfReady();},_onBeforeLeave:function(){for(var qa=0;qa<this.iframeListeners.length;qa++)this.iframeArbiter.unsubscribe(this.iframeListeners[qa]);for(var ra=0;ra<this.listeners.length;ra++)this.listeners[ra].unsubscribe();this.logger=null;this.groups=null;}});w(pa,{Anchor:{DEFAULT:'default_anchor'},Events:{calloutHidden:'calloutHidden',ready:'ready',mapClick:'mapClick',viewChange:'viewChange',viewChangeEnd:'viewChangeEnd',bubbleClick:'bubbleClick',bubbleMouseover:'bubbleMouseover',bubbleMouseout:'bubbleMouseout',pinClick:'pinClick',pinMouseover:'pinMouseover',pinMouseout:'pinMouseout',onSearchSubmit:'onSearchSubmit'},Listeners:{hideCallout:'hideCallout',zoomDelta:'zoomDelta',zoomIn:'zoomIn',zoomOut:'zoomOut',zoomBack:'zoomBack',closeCalloutAndZoomBack:'closeCalloutAndZoomBack',onAddPin:'onAddPin'},inform:function(qa,event,ra,sa){if(!ra){ra={};ra._instanceid=qa;}k.inform('AggregatedMap/'+event,ra,sa);},listenThenInform:function(qa,ra,sa,ta){Event.listen(ra,sa,function(){pa.inform(qa,ta);});},subscribe:function(qa,event,ra){k.subscribe('AggregatedMap/'+event,pa._guard(qa,ra));},subscribeAll:function(qa,ra){for(var sa in pa.Events){var ta=ra['_mapHandler_'+sa];if(ta){ta=ta.bind(ra);pa.subscribe(qa,sa,ta);}}},_guard:function(qa,ra){return function(sa,ta,ua){if(!ua._instanceid){throw new Error('aggregated map didnt pass instanceid');}else if(ua._instanceid!==qa)return;return sa(ua);}.bind(this,ra);}});e.exports=pa;});
__d("AggregatedMapCircleSprite",["copyProperties","CSS","DOM","Style"],function(a,b,c,d,e,f){var g=b('copyProperties'),h=b('CSS'),i=b('DOM'),j=b('Style');function k(o,p,q,r){this._size=o;this._radius=p;this._aggregationRadius=q;this._count=r;}function l(){return this._radius;}function m(){return this._radius*2;}function n(o){var p=this.getCount()+o.getCount();if(p>=100){return k.large(p);}else if(p>=10){return k.medium(p);}else return k.small(p);}g(k.prototype,{render:function(){var o=i.create('div',{className:['fbAggregatedMapBubble','fbAggregatedMapBubble'+this._size].join(' ')});i.setContent(o,this._count);var p=i.create('div',{className:['fbAggregatedMapBubbleShell','fbAggregatedMapBubbleShell'+this._size].join(' ')});i.setContent(p,o);this._root=p;return p;},highlight:function(){this._root&&h.addClass(this._root,'highlighted');},dehighlight:function(){this._root&&h.removeClass(this._root,'highlighted');},combine:n,getCount:function(){return this._count;},getHeight:m,getWidth:m,getAnchorX:l,getAnchorY:l,getCalloutX:l,getCalloutY:l,getAggregationRadius:function(){return this._aggregationRadius;}});g(k,{small:function(o){return new k('Small',15,9,o);},medium:function(o){return new k('Medium',20,11,o);},large:function(o){return new k('Large',28,16,o);},combine:n});e.exports=k;});
__d("AggregatedMapRedPinSprite",["AggregatedMapCircleSprite","CSS","DOM","copyProperties"],function(a,b,c,d,e,f){var g=b('AggregatedMapCircleSprite'),h=b('CSS'),i=b('DOM'),j=b('copyProperties');function k(l,m,n,o,p,q,r,s,t){this.size=l;this.image=m;this.width=n;this.height=o;this.calloutY=p;this.aggregationRadius=q;this.text=s;this.count=r;this.css=t;}j(k.prototype,{render:function(){var l=i.create('div');h.addClass(l,'fbAggregatedMapPin');h.addClass(l,'fbAggregatedMapPin'+this.size);if(this.css)h.addClass(l,this.css);var m='/images/places/map/'+this.image,n=i.create('img',{src:m});i.appendContent(l,n);var o=null;if(this.text){o=i.create('div');h.addClass(o,'fbAggregatedMapPinText');h.addClass(o,'fbAggregatedMapPinText'+this.size);i.setContent(o,this.count);i.appendContent(l,o);}return l;},combine:g.combine,getCount:function(){return this.count;},getHeight:function(){return this.height;},getWidth:function(){return this.width;},getAnchorX:function(){return this.width/2;},getAnchorY:function(){return this.height;},getCalloutX:function(){return this.width/2;},getCalloutY:function(){return this.calloutY;},getAggregationRadius:function(){return this.aggregationRadius;}});j(k,{dot:function(l){if(l===undefined)l=1;return new k('Small','small_dot.png',17,22,8,10,l,false);},smallBlank:function(l){return new k('Small','small_blank.png',17,22,8,10,l,true);},mediumBlank:function(l){return new k('Medium','medium_blank.png',25,34,12,14,l,true);},largeBlank:function(l){return new k('Large','large_blank.png',29,43,14,17,l,true);}});e.exports=k;});
__d("AggregatedMapPin",["AggregatedMapRedPinSprite","BingMapCoordinate","Vector","copyProperties"],function(a,b,c,d,e,f){var g=b('AggregatedMapRedPinSprite'),h=b('BingMapCoordinate'),i=b('Vector'),j=b('copyProperties');function k(){this.anchor=null;this.name=null;this.group=null;}j(k.prototype,{getType:function(){return 'AggregatedMapPin';},setZoom:function(l){this.anchor.setZoom(l);this.center=new i(this.anchor.getMapX(),this.anchor.getMapY());},getLatitude:function(){return this.anchor.getLatitude();},getLongitude:function(){return this.anchor.getLongitude();},getGroup:function(){return this.group;},getAggregationRadius:function(){return this.sprite.getAggregationRadius();},setSprite:function(l){this.sprite=l;},setCallout:function(l){this._agg_map_callout=l;}});j(k,{create:function(l,m,n,o){var p=new k();p.anchor=h.fromLatLong(l);p.sprite=m;if(n)p.name=n;if(o)p.xhp=o;return p;},redPinWithDot:function(l,m,n,o){var p=g.dot(o);return k.create(l,p,m,n);},pageLocationPin:function(l,m,n,o){var p=k.redPinWithDot(l,m,n);p.profileID=o;return p;}});e.exports=k;});
__d("legacy:AggregatedMap",["AggregatedMap","AggregatedMapCalloutOrientation"],function(a,b,c,d){a.AggregatedMap=b('AggregatedMap');a.AggregatedMapCalloutOrientation=b('AggregatedMapCalloutOrientation');},3);
__d("legacy:aggregated-map-pin",["AggregatedMapPin"],function(a,b,c,d){a.AggregatedMapPin=b('AggregatedMapPin');},3);
__d("TimelineMapStory",["copyProperties"],function(a,b,c,d,e,f){var g=b('copyProperties');function h(i){g(this,i);}g(h.prototype,{passesTimeframe:function(i){return (!i||(!i.start||this.timestamp!==null&&i.start<=this.timestamp)&&(!i.end||this.timestamp!==null&&i.end>this.timestamp));}});e.exports=h;});
__d("TimelineMapPlace",["TimelineMapStory","copyProperties"],function(a,b,c,d,e,f){var g=b('TimelineMapStory'),h=b('copyProperties');function i(j){this.stories=[];this.creation=false;this.name=null;h(this,j);if(this.region)this.region=this.region+':'+this.country;this.visibleStories=this.stories;}h(i.prototype,{setFilters:function(j,k){var l=[];for(var m=0;m<this.stories.length;m++){var n=this.stories[m].passesTimeframe(j)&&(!k||this.stories[m].categories.contains(k));if(n)l.push(this.stories[m]);}this.visibleStories=l;},getStories:function(j,k){if(j===undefined)j=true;var l=j?this.visibleStories:this.stories;if(!k){return l;}else{var m=[];for(var n=0;n<l.length;n++){var o=l[n];if(k(o))m.push(o);}return m;}},count:function(j,k){var l=this.getStories(j,k).length;if(this.creation)l++;return l;}});h(i,{Filters:{MLE:function(j){return j&&!j.isEnt;},ALL:null}});e.exports=i;});
__d("randomShuffle",["randomInt"],function(a,b,c,d,e,f){var g=b('randomInt');function h(i){for(var j=i.length-1;j>0;j--){var k=g.call(this,j+1);if(k!=j){var l=i[k];i[k]=i[j];i[j]=l;}}return i;}e.exports=h;});
__d("TimelineMapController",["AggregatedMap","AggregatedMapCalloutOrientation","AggregatedMapPin","AggregatedMapRedPinSprite","Arbiter","AsyncRequest","BingMapCoordinate","CSS","DOM","MapRects","Rect","Style","TimelineMapPlace","TimelineMapStory","Vector","$","copyProperties","isEmpty","mod","randomShuffle"],function(a,b,c,d,e,f){var g=b('AggregatedMap'),h=b('AggregatedMapCalloutOrientation'),i=b('AggregatedMapPin'),j=b('AggregatedMapRedPinSprite'),k=b('Arbiter'),l=b('AsyncRequest'),m=b('BingMapCoordinate'),n=b('CSS'),o=b('DOM'),p=b('MapRects'),q=b('Rect'),r=b('Style'),s=b('TimelineMapPlace'),t=b('TimelineMapStory'),u=b('Vector'),v=b('$'),w=b('copyProperties'),x=b('isEmpty'),y=b('mod'),z=b('randomShuffle'),aa=198,ba=132,ca=108;function da(ea,fa,ga,ha,ia){this.profileID=null;this.viewasID=null;this.places={};this.visiblePins=null;this.stories={};this.hiddenStories={};this.placesByTime=[];this.category=null;this.timeframe=null;this.pending=null;this.waitingOnConfirmation=false;this.highlightedPin=null;this.arbiterListeners=[];this.calloutBeingFetched=null;this.initialized=false;this._lastResizeCalloutAnchor=null;this._lastResizeCalloutStoryHeight=null;this._scrollableCalloutController=null;this.inCreation=false;this.lastTypeaheadEvent=null;this.initialPosition=null;this.initialPlace=null;this.initialStory=null;this.hh=0;this.ww=0;this.smartPan=null;this.requestID=0;this.asyncRequests={};this.intervals=[];this.groups=[];this.pagerIndex=null;this.categoryCountUnique={};if(ea)this._init(ea,fa,ga,ha,ia);}w(da.prototype,{HOVER_FETCH_DELAY:100,HOVER_DISMISS_DELAY:300,MAP_BOTTOM_PADDING:40,MIN_MAP_HEIGHT:532,MIN_CALLOUT_STORY_HEIGHT:200,MAX_CALLOUT_HEIGHT:458,RESIZE_CHECK_INTERVAL:50,HOVERCARD_WIDTH:279,HOVERCARD_HEIGHT:251,HOVERCARD_CLOSED:undefined,HOVERCARD_WAITING_TO_FETCH:1,HOVERCARD_BEING_FETCHED:2,HOVERCARD_OPEN:3,HOVERCARD_WAITING_TO_DISMISS:4,TIMELINE_MAP_HOVERCARD_PLACE:'Place',TIMELINE_MAP_HOVERCARD_CITY:'City',TIMELINE_MAP_HOVERCARD_REGION:'Region',TIMELINE_MAP_HOVERCARD_COUNTRY:'Country',HOVERCARD_CITY_REGION_HEURISTIC:3,setCategory:function(ea){this.logger&&this.logger.startRun('set-category');this.map.hideCallout();this.category=ea;this._filter();},setTimeframe:function(ea,fa){this.logger&&this.logger.startRun('set-timeframe');this.map.hideCallout();this.timeframe=fa;this._filter();this._inform(da.Events.timeframeChange,null,k.BEHAVIOR_STATE);},setCategoryCountUnique:function(ea){this.categoryCountUnique=ea;},getCategories:function(){var ea={},fa,ga;for(var ha in this.places){var ia=this.places[ha],ja={},ka=0;for(var la=0;la<ia.stories.length;la++){ga=ia.stories[la];if(ga.passesTimeframe(this.timeframe)){ka++;if(ga.categories)for(var ma=0;ma<ga.categories.length;ma++){fa=ga.categories[ma];if(this.categoryCountUnique[fa]&&ja[fa])continue;if(!ea[fa])ea[fa]={count:0,name:fa};if(!ja[fa])ja[fa]=1;ea[fa].count++;}}}}return ea;},zoomToVisible:function(){this.map.zoomTo(this.visiblePins);},cleanupCreationCallout:function(ea){this.map.hideCallout(ea);this._cleanUpHiglightedPin();},cancelCreation:function(ea){if(!this.inCreation)return;this.inCreation=false;this.cleanupCreationCallout();k.inform('TimelineMapTour/resumeTour');},creationFinished:function(ea,fa){var ga=fa.place,ha=fa.story,ia=fa.showCallout;this.inCreation=false;this.waitingOnConfirmation=false;this.cleanupCreationCallout();this.addStories(null,{stories:[ha],places:[ga]});if(ia)this.showCallout(null,{place_id:ga.id,story_id:ha.id});k.inform('TimelineMapTour/resumeTour');},page:function(ea,fa){var ga=this.map.getGroups();if(!ga)return;var ha=[],ia=true,ja=0;for(var ka=0;ka<ga.length;ka++){var la=ga[ka];if(la.hasMarker()){var ma=la.getCenter(),na=new q(0,this.ww,this.hh,0);if(p.containsPoint(na,ma)){ha.push(la);if(la===this.groups[ja]){ja++;}else if(ia)ia=false;}}}ia=ia&&ja===this.groups.length;if(!ia){this.groups=ha;this.sortedGroups=ha.concat([]).sort(function(pa,qa){return pa.getCenter().x-qa.getCenter().x;});if(fa>0){this.pagerIndex=0;}else this.pagerIndex=-1;}else this.pagerIndex+=(fa>0)?1:-1;this.pagerIndex=y(this.pagerIndex,this.sortedGroups.length);var oa=this.sortedGroups[this.pagerIndex];if(oa.pins.length>1){this._openCallout(oa,this.map.throbber(325),this.map.leftRightNoPanningStrategy());oa.hoverPermanent=true;oa.hoverState=this.HOVERCARD_WAITING_TO_FETCH;this._fetchHovercard(oa);}else this._mapHandler_pinClick(null,oa.pins[0]);},hovercard:function(ea,fa){var ga=this._getAsyncContext(fa.requestID);if(ga.deleted||ga.hoverState!==this.HOVERCARD_BEING_FETCHED)return;ga.hoverState=this.HOVERCARD_OPEN;var ha=o.create('div');ha.onmouseover=function(){if(!this.map||!this.map.getCallout().getAnchor())return null;this._mapHandler_bubbleMouseover(null,this.map.getCallout().getAnchor());}.bind(this);ha.onmouseout=function(){if(!this.map||!this.map.getCallout().getAnchor())return null;this._mapHandler_bubbleMouseout(null,this.map.getCallout().getAnchor());}.bind(this);n.setClass(ha,'fbTimelineMapHovercard');o.setContent(ha,fa.content);if(ga===this.map.getCallout().getAnchor()){this.map.getCallout().setContent(ha);}else this._openCallout(ga,ha,this.map.leftRightNoPanningStrategy());this.map.getCallout().recalculateArrowYOffset(true);this.logger&&this.logger.endRun('load-hovercard');},callout:function(ea,fa){var ga=this._getAsyncContext(fa.requestID);if(this.map.getCallout().getAnchor()!==ga)return;this._openCallout(ga,fa.content);this.logger&&this.logger.endRun('load-callout');},addPending:function(ea,fa){var ga=fa.count;this.pending=this.pending||0;this.pending+=ga;this._checkReady();},hideCallout:function(ea,fa){fa=fa||{};fa._instanceid=this.instanceID;k.inform('AggregatedMap/hideCallout',fa);},addStories:function(ea,fa){var ga=fa.stories,ha=fa.places;if(fa.count)this.pending=(this.pending||0)-fa.count;var ia,ja,ka,la;for(la=0;la<ha.length;la++){ja=new s(ha[la]);if(!this.places[ja.id]){this.places[ja.id]=ja;this.placesByTime.push(ja);}ja.mostRecentTimestamp=0;}for(la=0;la<ga.length;la++){ka=new t(ga[la]);this.stories[ka.id]=ka;ia=ka.placeID;ja=this.places[ia];ja.stories.push(ka);ja.mostRecentTimestamp=Math.max(ja.mostRecentTimestamp,ka.timestamp);}if(fa.count===undefined){this._refresh();}else this._checkReady();},updateStory:function(ea,fa){var ga=fa.place,ha=fa.story,ia=this.stories[ha.id];if(ia.placeID!=ga.id){var ja={};ja[ia.id]=true;this._removeStories(ia.placeID,ja);this.addStories(null,{stories:[ha],places:[ga]});}this._showCallout(this.places[ga.id].pin,ga.id,ha.id);},deleteStory:function(ea,fa){var ga=this.map.getCallout().getAnchor(),ha=this.stories[fa];if(!ha)return;var ia={};ia[ha.id]=true;this.map.hideCallout();var ja=this._removeStories(ha.placeID,ia);ja.stories_removed&&this._refresh();!ja.place_removed&&this._showCallout(ga,ga.place.id);},hideStory:function(ea,fa){var ga=this.map.getCallout().getAnchor(),ha=this.stories[fa.story_id];if(!ga)return;if(ga.getType()!=='AggregatedMapPin')return;if(!ha||ha.placeID!=ga.place.id)return;var ia=v(fa.story_domid);n.hide(ia);var ja=o.insertAfter(ia,fa.undo_html)[0];this.hiddenStories[ha.id]={story_domid:ia.id,undo_domid:ja.id};},undoHideStory:function(ea,fa){var ga=this.stories[fa],ha=this.hiddenStories[ga.id];o.remove(ha.undo_domid);n.show(ha.story_domid);delete this.hiddenStories[ga.id];},showCallout:function(ea,fa){var ga=this.places[fa.place_id].pin;this._showCallout(ga,fa.place_id,fa.story_id);},zoomIntoOne:function(ea,fa){var ga=this.places[fa.place_id];this._zoomToPlace(ga);},zoomToArea:function(ea,fa){var ga=fa.type,ha=fa.key,ia=[];for(var ja in this.places){var ka=this.places[ja],la=ka.pin;if((ka.city===ha&&ga===this.TIMELINE_MAP_HOVERCARD_CITY)||(ka.region===ha&&ga===this.TIMELINE_MAP_HOVERCARD_REGION)||(ka.country===ha&&ga===this.TIMELINE_MAP_HOVERCARD_COUNTRY))ia.push(la);}this.map.zoomInto(ia);},creationFlow:function(ea,fa){var ga=fa.place,ha={latitude:ga.latitude,longitude:ga.longitude};this.waitingOnConfirmation=false;this._highlightPlace(ga.id,ha);this._openCallout(this.highlightedPin,fa.content,this.smartPan);this.inCreation=true;},highlightMapPlace:function(ea,fa){if(fa.dismiss&&this.waitingOnConfirmation)return;if(fa.showThrobber){this._openCallout(this.highlightedPin,this.map.throbber(),this.smartPan);return;}this.map.hideCallout();if(fa.dismiss){this._cleanUpHiglightedPin();}else if(fa.selected){this.waitingOnConfirmation=true;}else if(fa.center)this._highlightPlace(fa.placeID,fa.center);this.map.setView(fa);},registerScrollableCallout:function(ea,fa){this._scrollableCalloutController=fa;},_init:function(ea,fa,ga,ha,ia,ja){this.profileID=ea;this.viewasID=fa.viewas;this.mapContainer=ga;this.canvas=o.find(this.mapContainer,'.fbAggregatedMapContainer');this.logger=ia;this.instanceID=ha;this._dynamicSize=fa.dynamicSize;if(fa.center)this.initialPosition={latitude:fa.center.lat,longitude:fa.center.long};this.initialPlace=fa.highlightedPlace;this.initialStory=fa.highlightedStory;this.enableHovercards=fa.enableHovercards;this.calloutDiv=ja&&v(ja);this.border=v('fbTimelineMapBorder');this._subscribe('onload/exit',this._onBeforeLeave.bind(this));this._subscribe('AggregatedMap/ready',this._onInit.bind(this));this._subscribe('AggregatedMap/calloutHidden',this.cancelCreation.bind(this));this._subscribe('AggregatedMap/calloutHidden',k.inform.shield(null,'reflow'));this._subscribe('TimelineMapStickyHeaderComposer/typeaheadFocus',this._handleTypeahead.bind(this,'focus'));this._subscribe('TimelineMapStickyHeaderComposer/typeaheadBlur',this._handleTypeahead.bind(this,'blur'));this._subscribe('TimelineMapStickyHeaderComposer/typeaheadSelect',this._handleTypeahead.bind(this,'select'));},_onInit:function(ea,fa){this.map=fa;if(this._dynamicSize){this._resizeMap();this.intervals=[setInterval(this._resizeMap.bind(this),this.RESIZE_CHECK_INTERVAL),setInterval(this._resizeCallout.bind(this),this.RESIZE_CHECK_INTERVAL)];}else{this.hh=this.map.hh;this.ww=this.map.ww;}this.initialized=true;for(var ga in da.Listeners)this._subscribe('TimelineMap/'+ga,this[ga].bind(this));for(var ha in g.Events){var ia=this['_mapHandler_'+ha];if(ia){ia=ia.bind(this);this._subscribe('AggregatedMap/'+ha,ia);}}this.smartPan=this.map.smartPanningStrategy();},_getAsyncContext:function(ea){var fa=this.asyncRequests[ea];delete this.asyncRequests[ea];return fa;},_storeAsyncContext:function(ea){var fa=this.requestID++;this.asyncRequests[fa]=ea;return fa;},_inform:function(ea,fa,ga){fa=fa||{};fa._instanceid=this.instanceID;k.inform('TimelineMap/'+ea,fa,ga);},_cleanUpHiglightedPin:function(){if(this.highlightedPin){if(this.highlightedPin.isPreview){this.map.removePin(this.highlightedPin);}else{this.highlightedPin.setSprite(this._getPlaceSprite(this.highlightedPin.place));this.map.redraw();}this.highlightedPin=null;n.removeClass(this.canvas,'fbTimelineMapDimPinMode');}},_handleTypeahead:function(ea){if(!this.inCreation&&ea=='blur'&&this.lastTypeaheadEvent=='focus')k.inform('TimelineMapTour/resumeTour');this.lastTypeaheadEvent=ea;},_checkReady:function(){if(this.pending!==0)return;this._refresh();if(this.logger){window._cstart&&this.logger.set('flushTTI',Date.now()-window._cstart);for(var ea in this.places){var fa=this.places[ea];this.logger.bump('places');this.logger.bump('stories',fa.count());}this.logger.set('profileID',this.profileID);}if(window.CavalryLogger)window.CavalryLogger.getInstance().measurePageLoad(true);var ga=this.initialPlace,ha=this.initialStory;if(ga){this.map.zoomTo(this.visiblePins,false);this.map.setInitialView();var ia=this.places[ga].pin;if(ia){var ja=new u(aa,ba);ja=ja.sub(new u(this.ww/2,this.hh/2));this.map.zoomIntoOne(ia,ja);var ka=o.find(this.calloutDiv,'.fbTimelineMapCallout');o.remove(this.calloutDiv);this._openCallout(ia,ka);this.map.getCallout().setArrowYOffset(ca);this.map.updateCallouts();}}else if(this.initialPosition){this.map.setView({center:this.initialPosition});}else{this.map.zoomTo(this.visiblePins,false);this.map.setInitialView();}n.addClass(this.border,'fbTimelineMapContainerLoaded');},_refresh:function(){this.placesByTime=this.placesByTime.sort(function(ea,fa){return ea.mostRecentTimestamp-fa.mostRecentTimestamp;});this._filter();this._inform(da.Events.timeframeChange,null,k.BEHAVIOR_STATE);},_resizeMap:function(){var ea=u.getViewportDimensions().y,fa=u.getElementPosition(this.border).y,ga=u.getElementDimensions(this.border).y,ha=ea-(fa+ga),ia=this.hh+ha-this.MAP_BOTTOM_PADDING;ia=Math.max(this.MIN_MAP_HEIGHT,Math.min(ia,ea));if(Math.abs(this.hh-ia)>1){r.set(this.mapContainer,'height',ia+'px');this.hh=ia;this.ww=this.map.ww;this.map.resizingTo(this.ww,this.hh);this._resizeMap();}},_resizeCallout:function(){var ea,fa,ga,ha=(ea=this.map.getCallout().getContent())&&(fa=o.scry(ea,'.fbTimelineMapCalloutStory')[0])&&(ga=o.scry(ea,'.fbTimelineMapScrollableStory')[0]);if(!ha)return;var ia=u.getElementDimensions(fa).y;if(this.map.getCallout().getAnchor()===this._lastResizeCalloutAnchor&&ia===this._lastResizeCalloutStoryHeight)return;var ja=o.find(ea,'.fbTimelineMapCalloutHeader'),ka=u.getElementDimensions(ja).y,la=u.getElementPosition(ga).y,ma=u.getElementPosition(this.mapContainer).y,na=this.hh-this.map.CALLOUT_MARGIN,oa=Math.max(this.MIN_CALLOUT_STORY_HEIGHT,Math.min((ma+na)-la,na-ka)),pa=Math.min(ia,oa,this.MAX_CALLOUT_HEIGHT);r.set(ga,'height',pa+'px');this._lastResizeCalloutAnchor=this.map.getCallout().getAnchor();this._lastResizeCalloutStoryHeight=ia;if(this._scrollableCalloutController)this._scrollableCalloutController.adjustGripper();this.map.getCallout()._updateDimensions();this.map.getCallout().recalculateArrowYOffset();},_filter:function(){var ea=[];for(var fa in this.places){var ga=this.places[fa];ga.setFilters(this.timeframe,this.category);if(ga.count()>0){var ha=this._getPlaceSprite(ga),ia=i.create(ga,ha,ga.name);ga.pin=ia;ia.place=ga;ea.push(ia);}}this.visiblePins=ea;if(this.highlightedPin)this.visiblePins.push(this.highlightedPin);this.map.setPins(ea);},_getPlaceSprite:function(ea){var fa=ea.getStories(),ga=fa.length,ha;if(ga>=100){ha=j.largeBlank(ga);}else if(ga>10){ha=j.mediumBlank(ga);}else if(ga>1){ha=j.smallBlank(ga);}else if(fa[0]&&fa[0].pin){ha=j.mediumBlank(1);ha.text=false;ha.image=fa[0].pin+'.png';}else ha=j.dot();return ha;},_getHighlightedSprite:function(){var ea=j.dot();ea.aggregationRadius=0;ea.css='fbTimelineMapHighlighted';return ea;},_highlightPlace:function(ea,fa){this._cleanUpHiglightedPin();var ga;if(ea&&this.places[ea]!==undefined){ga=this.places[ea].pin;ga.setSprite(this._getHighlightedSprite());this.map.redraw();}else{ga=new i();ga.anchor=m.fromLatLong(fa);ga.sprite=this._getHighlightedSprite();ga.isPreview=true;this.map.addPin(ga);}this.highlightedPin=ga;n.addClass(this.canvas,'fbTimelineMapDimPinMode');return ga;},_showCallout:function(ea,fa,ga){this._openCallout(ea,this.map.throbber(),this.smartPan);this._fetchCallout(ea,fa,ga);},_fetchCallout:function(ea,fa,ga){this.logger&&this.logger.startRun('load-callout');var ha=this._storeAsyncContext(ea),ia=this.places[fa],ja=[],ka={},la=ia.getStories();for(var ma=0;ma<la.length;++ma){var na=la[ma];if(!na.isEnt){ja.push(na.unitParams);}else{ka[na.storyType]=ka[na.storyType]||[];ka[na.storyType].push(na.id);}}var oa={profile_id:this.profileID,targetid:ia.id,storyid:ga,unitparams:ja,storiesbytype:ka,request_id:ha};if(this.viewasID&&this.viewasID!="0")oa.viewas=this.viewasID;new l().setURI('/ajax/timeline/map/callout.php').setMethod('POST').setData(oa).send();},_openCallout:function(ea,fa,ga){var ha=this.map.getCallout().getAnchor();ha&&this._dismissHovercard(ha);this.map.openCallout(ea,fa,ga);this._resizeCallout();},_zoomToPlace:function(ea){var fa=h.LEFT,ga=h.RIGHT,ha=this.map.getCallout().getOrientation()===fa,ia=new u(ha?200:-200,0);this.map.zoomIntoOne(ea.pin,ia);this._openCallout(ea.pin,this.map.throbber(),this.map.noPanningStrategy(ha?fa:ga));this._fetchCallout(ea.pin,ea.id);},_fetchHovercard:function(ea){this.logger&&this.logger.startRun('load-hovercard');if(ea.deleted||ea.hoverState!==this.HOVERCARD_WAITING_TO_FETCH)return;if(ea.pins.length<2)throw 'bubble has < 2 pins!';delete ea.timeoutToken;ea.hoverState=this.HOVERCARD_BEING_FETCHED;var fa=[],ga=[],ha={},ia={},ja={},ka={},la={},ma={};ea.pins.forEach(function(jb){var kb=jb.place,lb=kb.getStories();ma[kb.id]=true;for(var mb=0;mb<lb.length;mb++)fa.push(lb[mb]);ga.push(kb);if(kb.city){ha[kb.city]=ha[kb.city]||0;ha[kb.city]++;if(kb.region)la[kb.region]=kb.city;if(kb.country)ka[kb.country]=kb.city;}if(kb.region){ia[kb.region]=ia[kb.region]||0;ia[kb.region]++;}if(kb.country){ja[kb.country]=ja[kb.country]||0;ja[kb.country]++;}});var na=ga.length,oa=this._storeAsyncContext(ea),pa=this._getStoriesByType(fa).TimelineMapStoryPhoto||[],qa=pa.length,ra=z(pa).slice(0,4),sa={},ta=ga.length<=3,ua=ga.sort(function(jb,kb){return kb.getStories().length-jb.getStories().length;}).slice(0,3).map(function(jb){var kb=0,lb={},mb=jb.getStories();for(var nb=0;nb<mb.length;nb++){var ob=mb[nb],pb=ob.visitID;if(pb===0){kb++;}else if(!(pb in lb)){lb[pb]=true;kb++;}}sa[jb.id]=kb;return jb.id;}),va=false,wa=false,xa=false;for(var ya in this.places){var za=this.places[ya];if(!ma[za.id]&&(xa=xa||ja[za.country])&&(wa=wa||ia[za.region])&&(va=va||ha[za.city]))break;}var ab=null,bb=null,cb=null,db=null,eb=null,fb=function(jb,kb,lb){return jb[lb]-jb[kb];};ha=Object.keys(ha).sort(fb.curry(ha));ia=Object.keys(ia).sort(fb.curry(ia));ja=Object.keys(ja).sort(fb.curry(ja));var gb={};gb[this.TIMELINE_MAP_HOVERCARD_COUNTRY]=ja.map(function(jb){return ka[jb];});gb[this.TIMELINE_MAP_HOVERCARD_REGION]=ia.map(function(jb){return la[jb];});gb[this.TIMELINE_MAP_HOVERCARD_CITY]=ha;gb[this.TIMELINE_MAP_HOVERCARD_PLACE]=ga.map(function(jb){return jb.id;});if(ja.length>0)if(!xa){bb=this.TIMELINE_MAP_HOVERCARD_COUNTRY;if(ja.length>1){db=this.TIMELINE_MAP_HOVERCARD_COUNTRY;}else if(ia.length>1){db=this.TIMELINE_MAP_HOVERCARD_REGION;}else db=this.TIMELINE_MAP_HOVERCARD_CITY;}if(ia.length>0&&!bb){var hb=this.HOVERCARD_CITY_REGION_HEURISTIC;if(!wa||ia.length>1&&ha.length>ia.length*hb){bb=this.TIMELINE_MAP_HOVERCARD_REGION;if(ia.length>1){db=this.TIMELINE_MAP_HOVERCARD_REGION;}else db=this.TIMELINE_MAP_HOVERCARD_CITY;}}if(ha.length>0&&!bb)if(!va||ha.length>1){bb=this.TIMELINE_MAP_HOVERCARD_CITY;if(ha.length>1){db=this.TIMELINE_MAP_HOVERCARD_CITY;}else eb=ga.length;}if(!bb){bb=this.TIMELINE_MAP_HOVERCARD_PLACE;eb=-1;}ab=gb[bb];if(db)cb=gb[db];var ib={profile_id:this.profileID,request_id:oa,target_count:na,photo_count:qa,photo_ids:ra,place_counts:sa,target_ids:ua,all_places:ta,ids:ab,title_type:bb,subtitle_count:eb,links:cb,link_type:db};if(this.viewasID&&this.viewasID!="0")ib.viewas=this.viewasID;new l().setURI('/ajax/timeline/map/hovercard.php').setMethod('POST').setData(ib).send();},_dismissHovercard:function(ea){delete ea.timeoutToken;delete ea.hoverState;delete ea.hoverPermanent;if(this.map.getCallout().getAnchor()===ea)this.map.hideCallout();},_getStoriesByType:function(ea){var fa={};ea.forEach(function(ga){fa[ga.storyType]=fa[ga.storyType]||[];fa[ga.storyType].push(ga.isEnt?ga.id:ga.unitParams);});return fa;},_removeStories:function(ea,fa){var ga=0,ha=false,ia=this.places[ea],ja=[],ka;for(ka=0;ka<ia.stories.length;++ka){var la=ia.stories[ka];if(fa[la.id]){delete this.stories[la.id];++ga;}else ja.push(la);}if(ja.length===0){delete this.places[ea];ha=true;}else ia.stories=ja;return {place_removed:ha,stories_removed:ga};},_removeHiddenStories:function(){var ea=this.map.getCallout().getAnchor();if(!ea)return;if(ea.getType()!=='AggregatedMapPin')return;if(x(this.hiddenStories))return;var fa=ea.place.id,ga=this._removeStories(fa,this.hiddenStories);if(ga.stories_removed!==0){this._refresh();this.hiddenStories={};}},_guard:function(ea){return function(fa,ga){if(!ga||!ga._instanceid||ga._instanceid===this.instanceID)ea(fa,ga);}.bind(this);},_subscribe:function(ea,fa){this.arbiterListeners.push(k.subscribe(ea,this._guard(fa)));},_mapHandler_mapClick:function(){this._removeHiddenStories();this.map.hideCallout();this._inform(da.Events.mapClick);},_mapHandler_pinClick:function(ea,fa){this.logger&&this.logger.bump('pin-click');this._removeHiddenStories();if(this.map.getCallout().getAnchor()===fa){this.map.hideCallout();}else this._showCallout(fa,fa.place.id);},_mapHandler_bubbleClick:function(ea,fa){this.logger&&this.logger.bump('bubble-click');this.map.hideCallout();this.map.zoomInto(fa.pins);},_mapHandler_bubbleMouseover:function(ea,fa){if(!this.enableHovercards||fa.hoverPermanent)return;if(!fa.hoverState||fa.hoverState===this.HOVERCARD_CLOSED){fa.hoverState=this.HOVERCARD_WAITING_TO_FETCH;fa.timeoutToken=setTimeout(this._fetchHovercard.bind(this,fa),this.HOVER_FETCH_DELAY);}else if(fa.hoverState===this.HOVERCARD_WAITING_TO_DISMISS){clearTimeout(fa.timeoutToken);delete fa.timeoutToken;fa.hoverState=this.HOVERCARD_OPEN;}},_mapHandler_bubbleMouseout:function(ea,fa){if(fa.hoverPermanent)return;if(fa.hoverState===this.HOVERCARD_WAITING_TO_FETCH||fa.hoverState===this.HOVERCARD_BEING_FETCHED){clearTimeout(fa.timeoutToken);delete fa.timeoutToken;delete fa.hoverState;}else if(fa.hoverState===this.HOVERCARD_OPEN){fa.timeoutToken=setTimeout(this._dismissHovercard.bind(this,fa),this.HOVER_DISMISS_DELAY);fa.hoverState=this.HOVERCARD_WAITING_TO_DISMISS;}},_onBeforeLeave:function(){for(var ea=0;ea<this.arbiterListeners.length;ea++)this.arbiterListeners[ea].unsubscribe();for(var fa=0;fa<this.intervals.length;fa++)clearInterval(this.intervals[fa]);this.logger&&this.logger.submit();this.logger=null;this.map=null;this.places=null;}});w(da,{Events:{timeframeChange:'timeframeChange',mapClick:'mapClick'},Listeners:{addStories:'addStories',updateStory:'updateStory',deleteStory:'deleteStory',hideStory:'hideStory',undoHideStory:'undoHideStory',addPending:'addPending',page:'page',creationFlow:'creationFlow',cleanupCreationCallout:'cleanupCreationCallout',cancelCreation:'cancelCreation',creationFinished:'creationFinished',showCallout:'showCallout',callout:'callout',hovercard:'hovercard',highlightMapPlace:'highlightMapPlace',registerScrollableCallout:'registerScrollableCallout',setTimeframe:'setTimeframe',zoomToVisible:'zoomToVisible',hideCallout:'hideCallout',zoomIntoOne:'zoomIntoOne',zoomToArea:'zoomToArea'}});e.exports=da;});
__d("legacy:TimelineMapController",["TimelineMapController"],function(a,b,c,d){a.TimelineMapController=b('TimelineMapController');},3);
__d("TimelineMapFilter",["Arbiter","CSS","DOM","TimelineMapController","$","copyProperties","cx","ge","StickyPlaceholderInput"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('CSS'),i=b('DOM'),j=b('TimelineMapController'),k=b('$'),l=b('copyProperties'),m=b('cx'),n=b('ge'),o=b('StickyPlaceholderInput');function p(){}l(p.prototype,{init:function(q,r,s,t,u,v,w){this._classes=w?{count:"_3d0",filter:"_3c_",selected:"_3s-",text:"_3sz"}:{count:'fbTimelineMapFilterTagCount',filter:'fbTimelineMapFilter',selected:'selected',text:'fbTimelineMapFilterText'};this.catNames=[];this.catIndex=0;this.mapController=q;this.container=k(r);this.stickies=s||[];this.filters=i.scry(this.container,'.'+this._classes.filter);this.tagUnit=n('fbTimelineMapTagUnit');this.tagUnitInited=false;this.mapID=t;this.pluralMap=u;this.initialCatName=v;var x={};for(var y=0;y<this.stickies.length;y++)for(var z=0;z<this.stickies[y].name.length;z++)x[this.stickies[y].name[z]]=this.stickies[y].countOnlyUnique;this.mapController.setCategoryCountUnique(x);g.subscribe('TimelineMap/timeframeChange',this.updateCategories.bind(this));},setCategory:function(q){this.mapController.setCategory(this.catNames[q]);var r=i.scry(this.container,'.'+this._classes.filter);h.removeClass(r[this.catIndex],this._classes.selected);this.catIndex=q;h.addClass(r[this.catIndex],this._classes.selected);var s=k('pagelet_timeline_medley_map');i.find(s,'.fbTimelineStickyHeaderPlaceComposer input.skiptowant').setAttribute('value',this.stickies[q].name.skip_to_want);o.setPlaceholderText(i.find(s,'.fbTimelineStickyHeaderPlaceComposer div.uiStickyPlaceholderInput'),this.stickies[q].name.placeholder);},setCategoryAndZoomToVisible:function(q){this.setCategory(q);this.mapController.zoomToVisible();},setFilter:function(q,r,s,t){if(typeof r==='string')return;var u=this.filters[q],v=s;if(v>=200)v=(v%100)+100;v=r[this.pluralMap[v]];this.catNames[q]=r[2];i.setContent(i.find(u,'.'+this._classes.text),v);i.setContent(i.find(u,'.'+this._classes.count),s);h.conditionClass(u.firstChild,t,!!t);h.show(u);},updateCategories:function(q,r){if(r._instanceid!==this.mapID)return;var s=this.mapController.getCategories(),t=this.catNames[this.catIndex]||this.initialCatName;this.catNames=[];var u=0;for(var v=0;v<this.stickies.length;v++){var w=this.stickies[v],x=w.name,y=0,z=w.domClass,aa=x[2];if(s[aa]){y=s[aa].count;delete s[aa];}if(w.showWhenZero||y!==0){this.setFilter(u,x,y,z);u++;}}var ba=[];for(var ca in s)ba.push(s[ca]);ba=ba.sort(function(ga,ha){return ha.count-ga.count;});for(var da=0;da<this.filters.length-u;da++){var ea=ba[da];if(ea){this.setFilter(da+u,ea.name,ea.count);}else h.hide(this.filters[da+u]);}if(t){this.initialCatName=null;var fa=this.catNames.indexOf(t);if(fa!=-1){this.setCategory(fa);}else this.setCategory(0);}}});e.exports=p;});
function TimelineMapLogger(){this.profiler={};this.log={};this.lastInteraction=new Date().getTime();this.interactionTime=0;}copyProperties(TimelineMapLogger,{IDLE_LIMIT:20000});copyProperties(TimelineMapLogger.prototype,{ping:function(){var a=new Date().getTime(),b=a-this.lastInteraction;if(b<TimelineMapLogger.IDLE_LIMIT)this.interactionTime+=b;this.lastInteraction=a;},set:function(a,b){this.log[a]=b;},bump:function(a,b){if(b===undefined)b=1;this.log[a]=(this.log[a]||0)+b;},startRun:function(a){if(!this.profiler[a])this.profiler[a]={average:0,count:0};this.profiler[a].start=+new Date();},endRun:function(a){if(!this.profiler[a]||!this.profiler[a].start)return;this._recordRun(a,new Date()-this.profiler[a].start);this.profiler[a].start=null;},submit:function(){for(var a in this.profiler){var b=new Date().getTime();this.log[a+'-count']=this.profiler[a].count;this.log[a+'-average']=this.profiler[a].average;}this.log['interaction-time']=this.interactionTime;window.EagleEye&&EagleEye.log('maptab_session',this.log);this.log=null;},_recordRun:function(a,b){var c=this.profiler[a];c.average=(c.average*c.count+b)/(c.count+1);c.count++;}});
__d("TimelineMLEPhotoPreviewGrid",["AsyncUploadRequest","Bootloader","CSS","DOM","FileInputUploader","Parent","ProgressBar","SortableGroup","copyProperties","tx","TimelineMLEPhotoConfig"],function(a,b,c,d,e,f){var g=b('AsyncUploadRequest'),h=b('Bootloader'),i=b('CSS'),j=b('DOM'),k=b('FileInputUploader'),l=b('Parent'),m=b('ProgressBar'),n=b('SortableGroup'),o=b('copyProperties'),p=b('tx'),q=b('TimelineMLEPhotoConfig');function r(v,w,x){this._container=v;this._grid=w;this._photoLimit=x;this._progressBarMarkup=q.progressBarMarkup;this._loadingIndicators=[];if(!q.enableDrag)return;this._sortableGroup=new n().setGrabCallback(t).setDropCallback(u);var y=j.scry(w,'.mlePhotoPreviewThumb');for(var z=0;z<y.length;z++)this._bindPhoto(y[z]);}o(r.prototype,{destroy:function(){this._sortableGroup&&this._sortableGroup.destroy();},_getNumPhotos:function(){return j.scry(this._grid,'.mlePhotoPreviewThumb').length;},_bindPhoto:function(v){this._sortableGroup&&this._sortableGroup.addSortable(j.find(v,'input').getAttribute('value'),v);},_unbindPhoto:function(v){this._sortableGroup&&this._sortableGroup.removeSortable(j.find(v,'input').getAttribute('value'));},attachPhoto:function(v,w){if(!this._loadingIndicators[w])return;var x=this._loadingIndicators[w].getRoot();if(l.byTag(x,'body')){j.replace(x,v);this._bindPhoto(v);}delete this._loadingIndicators[w];},detachPhoto:function(v){this._unbindPhoto(v);j.remove(v);var w=this._getNumPhotos();if(w===0){i.show(j.find(this._container,'.mlePhotoButtons'));i.hide(j.find(this._container,'.mleAddMorePhotoButtons'));}else if(w===this._photoLimit-1)i.show(j.find(this._container,'.mleAddMorePhotoButtons'));},createPlaceholder:function(v){if(this._getNumPhotos()===this._photoLimit-1)i.hide(j.find(this._container,'.mleAddMorePhotoButtons'));var w=this._progressBarMarkup.cloneNode(true);w=j.appendContent(this._grid,w)[0];this._loadingIndicators[v]=new m(w);},destroyPlaceholder:function(v){if(!this._loadingIndicators[v])return;j.remove(this._loadingIndicators[v].getRoot());delete this._loadingIndicators[v];},initUploader:function(v,w){var x=v.getInput();x.multiple=w.multiple&&g.isSupported();v.subscribe('change',this._uploadPhotos.bind(this,x,w));},_uploadPhotos:function(v,w){i.hide(j.find(this._container,'.mlePhotoButtons'));i.show(j.find(this._container,'.mleAddMorePhotoButtons'));var x=v.files?v.files.length:1;if(x+this._getNumPhotos()>this._photoLimit){var y=p._("The maximum number of photos you can add to this life event is {limit}. Please remove some photos and try again.",{limit:this._photoLimit});h.loadModules(['Dialog'],function(ca){new ca().setTitle("Too Many Photos").setBody(y).setButtons(ca.OK).show();});s(v);return;}for(var z=0;z<x;z++){var aa=v.files?v.files[z].name:v.value.split('\\').pop();this.createPlaceholder(aa);}var ba=new k(v).setURI(w.uploadURI).setData(w.uploadData).setAllowCrossOrigin(true).setUploadInParallel(true);ba.subscribe('progress',this._onProgress.bind(this));ba.subscribe('failure',this._onFailure.bind(this));ba.send();s(v);},_onProgress:function(v,w){var event=w.event,x=this._loadingIndicators[w.upload.getFile().name];i.hide(j.find(x.getRoot(),'.mlePhotoLoadingIndicator'));i.show(j.find(x.getRoot(),'.mlePhotoProgressBar'));if(event.loaded==event.total){x.setPosition(50);x.setTarget(100,2000);}else x.setPosition(50*event.loaded/event.total);},_onFailure:function(v,w){this.destroyPlaceholder(w.upload.getFile().name);}});function s(v){v.value='';v.files=null;}function t(v){i.addClass(v,'dragging');}function u(v,w){i.removeClass(w,'dragging');}e.exports=r;});
__d("TimelineMLEPhotoPreview",["event-extensions","CSS","Dialog","DOM","Parent","TimelineMLEPhotoPreviewGrid","$"],function(a,b,c,d,e,f){b('event-extensions');var g=b('CSS'),h=b('Dialog'),i=b('DOM'),j=b('Parent'),k=b('TimelineMLEPhotoPreviewGrid'),l=b('$'),m=[],n={initPreviewGrid:function(o,p){var q=j.byClass(o,'mleContainer');n.destroyPreviewGrid(q);m[q.id]=new k(q,o,p);},destroyPreviewGrid:function(o){if(m[o.id]){m[o.id].destroy();delete m[o.id];}},initUploader:function(o,p,q){if(m[p])m[p].initUploader(o,q);},attachPhoto:function(o,p,q){if(m[o])m[o].attachPhoto(p,q);},listenForDetach:function(o,p){var q=m[p];Event.listen(i.find(o,'.detachPhotoIcon'),'click',q.detachPhoto.bind(q,o));},listenForPhotoSelect:function(o,p,q){var r=l(p);Event.listen(o,'click',function(){g.hide(i.find(r,'.mlePhotoButtons'));g.show(i.find(r,'.mleAddMorePhotoButtons'));h.getCurrent().hide();if(m[r.id])m[r.id].createPlaceholder(q);});}};e.exports=n;});
__d("TimelineMLE",["event-extensions","Arbiter","AsyncRequest","Bootloader","CSS","DOM","DOMScroll","Form","Parent","ProgressiveDatepicker","TimelineCapsule","TimelineComposerUtilities","TimelineContentLoader","TimelineMLEPhotoPreview","Vector","$","areObjectsEqual","csx"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('AsyncRequest'),i=b('Bootloader'),j=b('CSS'),k=b('DOM'),l=b('DOMScroll'),m=b('Form'),n=b('Parent'),o=b('ProgressiveDatepicker'),p=b('TimelineCapsule'),q=b('TimelineComposerUtilities'),r=b('TimelineContentLoader'),s=b('TimelineMLEPhotoPreview'),t=b('Vector'),u=b('$'),v=b('areObjectsEqual'),w=b('csx'),x=0,y={},z=null,aa=null;function ba(ja){return n.byClass(ja,'mleFlyoutForm');}function ca(ja){var ka=n.byClass(ja.getContext(),'fbTimelineCapsule');if(ka)return ka;return r.capsuleForCurrentSection();}function da(ja){if(!ja)return;var ka=t.getScrollPosition().x,la=t.getElementPosition(ja).y;la=la-r.HEADER_SCROLL_CUTOFF;l.scrollTo(new t(ka,la,'document'));}function ea(ja){var ka=m.serialize(ja);if(!v(ka,y.state)){fa(ja);new h().setData(ka).setURI('/ajax/timeline/mle_header.php').setRelativeTo(ja).send();}}function fa(ja){ja=ja||y.element;if(!ja)return;y={element:ja,state:m.serialize(ja)};}function ga(event){var ja=event.getTarget(),ka=ja.options[ja.selectedIndex];g.inform('TimelineMLE/mleSelectUpdated',ja);var la=n.byClass(ka,'mleFormContainer'),ma=k.scry(la,'.mleOtherLabel'),na=k.scry(la,'.mleOtherField');if(ma.length)ma=ma[0];if(na.length)na=na[0];if(j.hasClass(ka,'mleOther')){j.show(ma);j.show(na);var oa=k.find(na,'.inputOuter').firstChild;oa.focus();}else{j.hide(ma);j.hide(na);}}function ha(ja){if(ja)Event.listen(ja,'change',ga);}var ia={cancel:function(ja){if(ba(ja)){ia.hideFlyout();}else{var ka=n.byClass(ja,'mleContainer');ka&&s.destroyPreviewGrid(ka);var la=n.byClass(ja,'fbTimelineNewMLE'),ma=n.byClass(ja,'fbTimelineCapsule');if(la){k.remove(la);}else{la=n.byClass(ja,'fbTimelineEditMLE');j.removeClass(la,'fbTimelineEditMLE');k.remove(k.scry(la,'.timelineUnitContainer')[0]);j.show(k.scry(la,'.timelineUnitContainer')[0]);}if(j.hasClass(la,'fbTimelineNotStarred')){j.removeClass(la,'fbTimelineNotStarred');i.loadModules(['TimelineStar'],function(na){na.unstarUnit(la.childNodes[0],null,true);});}ma&&p.balanceCapsule(ma);}y={};return false;},replace:function(ja,ka){var la=n.byClass(ja,'mleContainer');la&&s.destroyPreviewGrid(la);if(ba(ja)){var ma=n.byClass(ja,'fbTimelineEditMLEFlyout');if(ma){var na=n.byClass(ja,'uiContextualLayerPositioner'),oa=na.getAttribute('data-ownerid');ja=u(oa);ia.hideFlyout();}else{i.loadModules(['TimelineStoryPublisher'],function(sa){sa.publish(ka,z.getContext());ia.hideFlyout();});return false;}}var pa=n.byClass(ja,'fbTimelineNewMLE'),qa=n.byClass(ja,'fbTimelineCapsule'),ra=false;if(pa){ra=true;j.removeClass(pa,'fbTimelineNewMLE');j.removeClass(pa,'mleEditUnitContainer');}else{pa=n.byClass(ja,'fbTimelineEditMLE');j.removeClass(pa,'fbTimelineEditMLE');}k.setContent(pa,ka.streamStory);j.addClass(pa,'lifeEventContainer');if((ra||j.hasClass(pa,'fbTimelineNotStarred'))&&!k.scry(pa,'div.keepStarred')[0]){j.removeClass(pa,'fbTimelineNotStarred');i.loadModules(['TimelineStar'],function(sa){sa.unstarUnit(pa.childNodes[0],null,true);});}qa&&p.balanceCapsule(qa);return false;},swapInPromotedMLE:function(ja,ka,la,ma){var na=ja.parentNode;k.replace(ja,la);j.addClass(na,'lifeEventContainer');j.removeClass(na,'fbTimelineTwoColumn');j.addClass(na,'fbTimelineOneColumn');ia.startEdit(na,ka);k.insertAfter(k.scry(na,'div.topBorder')[0],ma);return false;},startEdit:function(ja,ka){ia.hideFlyout();var la=k.scry(ja,'div.timelineUnitContainer')[0];j.hide(la);j.addClass(ja,'fbTimelineEditMLE');if(!ka)j.addClass(ja,'fbTimelineNotStarred');},showFlyout:function(ja,ka,la){ia.hideFlyout();z=ja;x=0;g.subscribe('TimelineMLE/mleSelectUpdated',function(qa,ra){var sa=n.byClass(ra,'mleFormOuterContainer'),ta=k.scry(sa,'.registrationLink');if(!ta.length)return;var ua=ra.selectedIndex;j.hide(ta[x]);j.show(ta[ua]);x=ua;});if(ka==='header'||ka==='map'){i.loadModules(['TimelineStickyHeader'],function(qa){var ra=qa.getRoot();if(!ra)ra=u("pagelet_timeline_medley_map");var sa;if(ka==='header'){sa=k.scry(ra,'.lifeEventAttachment')[0]||k.scry(ra,"._yq")[0];}else sa=k.find(ra,'div.fbTimelineMapStickyHeaderComposerContainer');ja.setContext(sa).show();var ta=g.subscribe(qa.VISIBLE,function(ua,va){if(!va&&z===ja){ia.hideFlyout();ta.unsubscribe();}});});}else if(ka==='composer'){q.showMLEFlyout(ja);da(ja.getContext());}else if(ka==='yearly_summary'){ja.setContext(u("addMLELink")).show();}else if(ka==='goals_pagelet'){ja.setContext(u("addGoalLink")).show();}else if(ka==='edit'){ja.show();var ma=u(la),na=n.byClass(ma,'lifeEventContainer');j.addClass(na,'fbTimelineEditMLE');var oa=k.find(ja.getContent(),'.timelineUnitContainer');j.addClass(oa,'fbTimelineEditMLEFlyout');l.ensureVisible(oa,null,100);}else i.loadModules(['TimelineSpine'],function(qa){qa.showMLEFlyout(ja);da(ja.getContext());});if(ka!='map'){var pa=k.scry(ja.getContent(),'.mleSelect');if(pa.length)ha(pa[0]);}ia.setEstimatedDate(ja);g.inform('TimelineMLE/mleFlyoutShown',ja);},showPrivacyNotice:function(ja,ka){if(!ka||!ja)return;var la=k.find(ja.getContent(),'.audienceSelector');ka.setContext(la).show();aa=ka;Event.listen(la,'click',ka.hide.bind(ka));Event.listen(k.find(ka.getContent(),'input'),'click',ka.hide.bind(ka));g.subscribe('TimelineMLE/mleFlyoutHidden',ka.hide.bind(ka));},hideFlyout:function(){if(z){var ja=z,ka=k.scry(ja.getContent(),'.mleContainer')[0];ka&&s.destroyPreviewGrid(ka);ja.hide();y={};z=null;g.inform('TimelineMLE/mleFlyoutHidden');}},getFlyout:function(){return z;},listenForEditChanges:function(ja){var ka=k.find(ja,'form.mleFormContainer'),la=ka.elements;for(var ma=0;ma<la.length;++ma){if(n.byClass(la[ma],'uiTypeahead')||n.byClass(la[ma],'uiTokenizer'))continue;Event.listen(la[ma],'blur',function(){ea(ka);},Event.Priority._BUBBLE);}y={element:ka,state:m.serialize(ka)};},updateHeader:function(ja){ea(n.byClass(ja,'mleFormContainer'));},setEstimatedDate:function(ja){var ka=o.getInstance(k.scry(ja.getContent(),'.uiProgressiveDatepicker')[0]),la=k.scry(ja.getContext().parentNode,'.fbTimelineComposerUnit')[0];if(!la)q.setEstimatedDate(ka,ca(ja));},updatePrivacyNoticePosition:function(){aa&&aa.updatePosition();},registerOptionHandler:function(ja){var ka=k.scry(ja,'.lifeEventContainer')[0],la=k.scry(ka,'.mleSelect');if(la.length)ha(la[0]);},subscribeToTypeahead:function(ja,ka){ja.subscribe(['select','unselect','reset','blur'],ia.updateHeader.curry(ka));},subscribeToTokenizer:function(ja,ka){ja.subscribe(['addToken','removeToken'],ia.updateHeader.curry(ka));},replaceYearlySummary:function(ja){k.replace(u('pagelet_yearly'),ja);}};e.exports=a.TimelineMLE||ia;});
__d("legacy:TimelineMLE",["TimelineMLE"],function(a,b,c,d){a.TimelineMLE=b('TimelineMLE');},3);
function TimelineMapStickyHeaderComposer(){Arbiter.subscribe('TimelineMapStickyHeaderComposer/showPhotoTagUnit',this.showPhotoTagUnit.bind(this));Arbiter.subscribe('TimelineMapStickyHeaderComposer/hidePhotoTagUnit',this.hidePhotoTagUnit.bind(this));}copyProperties(TimelineMapStickyHeaderComposer.prototype,{initPlaceTypeahead:function(a){a.subscribe('focus',function(){Bootloader.loadComponents('TimelineMLE',function(){TimelineMLE.hideFlyout();});Arbiter.inform('TimelineMapStickyHeaderComposer/typeaheadFocus');}.bind(this));a.subscribe('blur',function(){Arbiter.inform('TimelineMapStickyHeaderComposer/typeaheadBlur');}.bind(this));a.subscribe('select',function(){Arbiter.inform('TimelineMapStickyHeaderComposer/typeaheadSelect');}.bind(this));},showPhotoTagUnit:function(a,b){this.tagUnit=$('fbTimelineMapTagUnit');CSS.show(this.tagUnit);var c=ge('mainContainer');c&&CSS.addClass(c,'photoTaggingMode');if(!this.tagUnitInited){this.tagUnitInited=true;this.indicator=$('fbTimelineMapAddPhotoLoading');CSS.show(this.indicator);var d=b?b.sid:null;new AsyncRequest().setURI('/ajax/timeline/map/photo_strip.php').setData({div_id:'fbTimelineMapTagUnit',sid:d}).setReadOnly(true).setHandler(bind(this,'_onLoadPhotoStrip')).send();}else this._onLoadPhotoStrip();},hidePhotoTagUnit:function(){CSS.hide(this.tagUnit);var a=ge('mainContainer');a&&CSS.removeClass(a,'photoTaggingMode');},_onLoadPhotoStrip:function(){CSS.hide(this.indicator);}});
__d("legacy:TimelineMapFilter",["TimelineMapFilter"],function(a,b,c,d){a.TimelineMapFilter=b('TimelineMapFilter');},3);
__d("TypeaheadTimelineHighlightMapPlace",["Arbiter","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties');function i(j){this._typeahead=j;}h(i.prototype,{_subscription:null,enable:function(){this._subscription=this._typeahead.subscribe(['reset','select','highlight'],function(j,k){if(j==='highlight'&&k.index!==-1&&k.selected.type!='freeform'&&k.selected.latitude&&k.selected.longitude&&!k.selected.changeCity&&k.index!=this.lastDataIdx){var l=k.selected.place_type=='city'?10:15;g.inform('TimelineMap/highlightMapPlace',{placeID:k.selected.uid,center:{latitude:k.selected.latitude,longitude:k.selected.longitude},zoom:l});}else if(j==='highlight'&&k.index==-1){g.inform('TimelineMap/highlightMapPlace',{dismiss:true});}else if(j==='select'){g.inform('TimelineMap/highlightMapPlace',{selected:true});}else if(j==='reset')g.inform('TimelineMap/highlightMapPlace',{dismiss:true});this.lastDataIdx=k&&k.index;});},disable:function(){this._typeahead.unsubscribe(this._subscription);this._subscription=null;}});e.exports=i;});
__d("TypeaheadTimelineShowThrobberOnSelect",["Arbiter","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties');function i(j){this._typeahead=j;}h(i.prototype,{_subscription:null,enable:function(){this._subscription=this._typeahead.subscribe(['select'],function(j,k){g.inform('TimelineMap/highlightMapPlace',{showThrobber:true});});},disable:function(){this._typeahead.unsubscribe(this._subscription);this._subscription=null;}});e.exports=i;});
__d("legacy:TimelineMapPlaceTypeaheadBehaviors",["TypeaheadTimelineHighlightMapPlace","TypeaheadTimelineShowThrobberOnSelect"],function(a,b,c,d){var e=b('TypeaheadTimelineHighlightMapPlace'),f=b('TypeaheadTimelineShowThrobberOnSelect');if(!a.TypeaheadBehaviors)a.TypeaheadBehaviors={};a.TypeaheadBehaviors.highlightMapPlace=function(g){g.enableBehavior(e);};a.TypeaheadBehaviors.showThrobberOnSelect=function(g){g.enableBehavior(f);};},3);
function TimelineMapTour(){this.parent.construct(this);}Class.extend(TimelineMapTour,'Tour');copyProperties(TimelineMapTour.prototype,{ENDPOINT:'/ajax/timeline/map/tour.php',NEXT_STEPS:{start:'tag_photos',tag_photos:'tour_complete'},currentStep:null,_tokens:[],init:function(a){this.parent.init();this.currentStep=a;_tokens=[Arbiter.subscribe('TimelineMapStickyHeaderComposer/typeaheadFocus',this._handleTypeaheadFocus.bind(this)),Arbiter.subscribe('TimelineMapStickyHeaderComposer/showPhotoTagUnit',this._handleAddPhotosClick.bind(this)),Arbiter.subscribe('TimelineMapTour/resumeTour',this.resumeTour.bind(this))];},_unsubscribeSubscriptions:function(){this.parent._unsubscribeSubscriptions();_tokens.forEach(Arbiter.unsubscribe.bind(Arbiter));},showStep:function(a){this.parent.showStep(a);},resumeTour:function(){if(this.currentStep=='tag_photos')new AsyncRequest().setURI(this.ENDPOINT).send();},_handleTypeaheadFocus:function(){if(this.openDialog){this.hideOpenDialog();if(this.currentStep=='start')this._advanceTour();}},_handleAddPhotosClick:function(){if(this.openDialog){this.hideOpenDialog();if(this.currentStep=='tag_photos')this._advanceTour();}},_advanceTour:function(){if(this.NEXT_STEPS[this.currentStep])this._saveStep(this.NEXT_STEPS[this.currentStep]);},_completeTour:function(){if(this.currentStep!='tour_complete')this._saveStep('tour_complete');},_saveStep:function(a){this.currentStep=a;new AsyncRequest().setURI(this.ENDPOINT).setMethod('POST').setData({step:a,suppress:1}).send();}});