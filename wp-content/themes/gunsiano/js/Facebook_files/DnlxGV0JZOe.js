/*1355957874,178142509*/

if (self.CavalryLogger) { CavalryLogger.start_js(["BcbRS"]); }

__d("GenderConst",[],function(a,b,c,d,e,f){var g={UNKNOWN:0,FEMALE_SINGULAR:1,MALE_SINGULAR:2,FEMALE_SINGULAR_GUESS:3,MALE_SINGULAR_GUESS:4,MIXED_SINGULAR:5,MIXED_PLURAL:5,NEUTER_SINGULAR:6,UNKNOWN_SINGULAR:7,FEMALE_PLURAL:8,MALE_PLURAL:9,NEUTER_PLURAL:10,UNKNOWN_PLURAL:11};e.exports=g;});
__d("BlackbirdUpsell",["event-extensions","Arbiter","AsyncRequest","ContextualDialogX","DOM","LayerDestroyOnHide","LayerHideOnTransition","PresencePrivacy","copyProperties","BlackbirdUpsellConfig","BlackbirdUpsellConstants","BlackbirdUpsellTemplates"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('AsyncRequest'),i=b('ContextualDialogX'),j=b('DOM'),k=b('LayerDestroyOnHide'),l=b('LayerHideOnTransition'),m=b('PresencePrivacy'),n=b('copyProperties'),o=b('BlackbirdUpsellConfig'),p=b('BlackbirdUpsellConstants'),q=b('BlackbirdUpsellTemplates'),r='/ajax/chat/blackbird/update_clicks.php',s='/ajax/chat/blackbird/update_impressions.php',t='/ajax/chat/blackbird/dismiss.php',u=235,v=null,w=null,x=false,y=false;function z(){}n(z,{shouldShow:function(){if(this._dialogDismissed)return false;if(this.isEducation()){return !!o.EducationGK&&!o.EducationDismissed&&o.EducationImpressions<o.EducationImpressionLimit;}else return !!o.UpsellGK&&!o.UpsellDismissed&&o.UpsellImpressions<o.UpsellImpressionLimit&&o.FriendCount>=o.UpsellMinFriendCount;},isEducation:function(){return o.TimeOffline<=o.EducationTimeOfflineThresdhold;},getOfflineContent:function(){if(this.isEducation()){return this._getEducationContent();}else return this._getUpsellContent();},_getEducationContent:function(){fa();var ja=q[':fb:chat:blackbird:offline-educate'].build(),ka=ja.getNode('chatSettingsButton');Event.listen(ka,'click',function(){g.inform('chat/advanced-settings-dialog-opened');ia(p.CLICK_TYPE_OPEN_SETTINGS);ca();});return ja.getRoot();},_getUpsellContent:function(){ea();var ja=q[':fb:chat:blackbird:upsell'].build(),ka=ja.getNode('chatSettingsButton');Event.listen(ka,'click',function(){g.inform('chat/advanced-settings-dialog-opened');ha(p.CLICK_TYPE_OPEN_SETTINGS);ba();});var la=ja.getNode('enableChatButton');Event.listen(la,'click',function(){ha(p.CLICK_TYPE_ENABLE_CHAT);ba();});return ja.getRoot();},getBlackbirdContent:function(ja){fa();switch(ja){case m.ONLINE:return q[':fb:chat:blackbird:most-friends-educate'].build().getRoot();case m.OFFLINE:return q[':fb:chat:blackbird:some-friends-educate'].build().getRoot();}},showOfflineDialog:function(ja){this.showDialog(ja,this.getOfflineContent.bind(this));},showBlackbirdDialog:function(ja,ka){this.showDialog(ja,this.getBlackbirdContent.curry(ka));},showDialog:function(ja,ka){!v&&this._constructDialog();j.setContent(w,ka());v.setContext(ja);v.show();},hide:function(){if(v&&v.isShown())v.hide();},dismiss:function(){this.hide();if(this.isEducation()){ca();}else ba();},registerDismissClick:function(){if(this.isEducation()){ia(p.CLICK_TYPE_DISMISS_PROMO);}else ha(p.CLICK_TYPE_DISMISS_PROMO);},isVisible:function(){return y&&!x;},_constructDialog:function(){var ja=q[':fb:chat:blackbird:dialog-frame'].build();w=ja.getNode('dialogContent');v=new i();v.init(ja.getRoot());v.setPosition('above').setWidth(u).setFixed(true).disableBehavior(k).disableBehavior(l);Event.listen(ja.getNode('dialogCloseButton'),'click',this.dismiss.bind(this));Event.listen(ja.getNode('dialogCloseButton'),'click',this.registerDismissClick.bind(this));}});function aa(ja,ka){if(!x&&y){x=true;m.inform('privacy-user-presence-changed');var la=new h(t);la.setData({source:ja,impressions:ka,time_offline:o.TimeOffline});la.setErrorHandler(function(){x=false;});la.send();}}function ba(){aa(p.ACTION_UPSELL,o.UpsellImpressions);}function ca(){aa(p.ACTION_EDUCATE,o.EducationImpressions);}function da(ja,ka){if(!y){y=true;var la=new h(s);la.setData({action:ja,impressions:ka,time_offline:o.TimeOffline});la.setErrorHandler(function(){y=false;});la.send();}}function ea(){da(p.ACTION_UPSELL,o.UpsellImpressions);}function fa(){da(p.ACTION_EDUCATE,o.EducationImpressions);}function ga(ja,ka,la,ma){var na=new h(r);na.setData({action:ja,impressions:la,source:ka,time_offline:ma});na.send();}function ha(ja){ga(ja,p.ACTION_UPSELL,o.UpsellImpressions,o.TimeOffline);}function ia(ja){ga(ja,p.ACTION_EDUCATE,o.EducateImpressions,o.TimeOffline);}g.subscribe('chat/advanced-settings-dialog-opened',z.dismiss.bind(z));g.subscribe('chat-visibility/go-online',z.dismiss.bind(z));g.subscribe('chat-visibility/go-offline',z.dismiss.bind(z));e.exports=z;});
__d("NubController",["ArbiterMixin","Class","Dock","copyProperties"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('Class'),i=b('Dock'),j=b('copyProperties');function k(){}j(k.prototype,g,{init:function(l){this.el=l;i.registerNubController(l,this);return this;},buttonContentChanged:function(){this.inform('nub/button/content-changed');},flyoutContentChanged:function(){this.inform('nub/flyout/content-changed');},hide:function(){i.hide(this.el);},show:function(){i.show(this.el);}});e.exports=k;});
__d("AsyncLoader",["copyProperties","AsyncRequest","BaseAsyncLoader"],function(a,b,c,d,e,f){var g=b('copyProperties'),h=b('AsyncRequest'),i=b('BaseAsyncLoader');function j(k,l){this._endpoint=k;this._type=l;}g(j.prototype,i.prototype);j.prototype.send=function(k,l,m,n,o){new h(k).setData({ids:l}).setHandler(n).setErrorHandler(o).setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();};e.exports=j;});
__d("ChatHovercard",["Arbiter","AsyncLoader","Hovercard","JSLogger","debounce"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncLoader'),i=b('Hovercard'),j=b('JSLogger'),k=b('debounce'),l=5,m=new h('/ajax/chat/hovercard/sidebar.php','hover'),n=j.create('chat_hovercard');g.subscribe('Hovercard/dirty',m.reset.bind(m));function o(s,t){m.get(s,function(u){(function(){if(!u){n.error('fetch_failure',{id:s});return;}var v=i.getDialog(u);if(!v){n.error('no_hovercard',{id:s,endpoint:u});return;}if(s==t.getActiveID())t.showHovercard(s,v);}).defer();});}function p(s,t){var u=[];function v(y){if(y>=0&&y<s.length)u.push(s[y]);}var w=s.indexOf(t);if(w>-1){v(w);for(var x=1;x<l;x++){v(w+x);v(w-x);}}return u;}function q(s,t){var u=t.getActiveID();if(u){var v=s.getShowingUsers(),w=p(v,u);m.get(w,function(){});}}function r(s){var t=s.getHoverController();t.registerDefault(o);t.subscribe('hover',k(q.curry(s,t),100));}e.exports=r;});
__d("ChatOrderedListHover",["event-extensions","function-extensions","ArbiterMixin","Class","CSS","DOM","ErrorUtils","LayerFadeOnHide","LayerHideOnBlur","Parent","copyProperties","setTimeoutAcrossTransitions","tx"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('ArbiterMixin'),h=b('Class'),i=b('CSS'),j=b('DOM'),k=b('ErrorUtils'),l=b('LayerFadeOnHide'),m=b('LayerHideOnBlur'),n=b('Parent'),o=b('copyProperties'),p=b('setTimeoutAcrossTransitions'),q=b('tx');function r(u){i.addClass(u,'fetching');}function s(u){i.removeClass(u,'fetching');}function t(u){this._orderedList=u;this._root=u.getRoot();Event.listen(this._root,'mouseover',this._mouseOver.bind(this));Event.listen(this._root,'mouseleave',this._mouseLeave.bind(this));u.subscribe('click',this._hide.shield(this));}o(t.prototype,g,{_root:null,_activeItem:null,_hideTimeout:null,_showTimeout:null,_showingDialog:null,_showingID:null,_alreadyShowing:false,_handlers:{},_defaultHandler:null,_mouseOver:function(u){var v=u.getTarget(),w=n.byClass(v,'item');w&&this._setActiveItem(w);},_mouseLeave:function(u){this._setActiveItem(null);},_clearTimeouts:function(){this._showTimeout&&clearTimeout(this._showTimeout);this._showTimeout=null;this._hideTimeout&&clearTimeout(this._hideTimeout);this._hideTimeout=null;},_checkAlreadyShowing:function(){var u=this.getActiveID();if(!u&&!this._showingID)this._alreadyShowing=false;},_hide:function(){if(this._showingDialog){this._showingDialog.enableBehavior(l);this._showingDialog.hide();this._showingDialog=null;this._showingID=null;}this._checkAlreadyShowing();},_show:function(){this._alreadyShowing=true;var u=this.getActiveID(),v=false;if(this._handlers[u]){v=true;k.applyWithGuard(this._handlers[u],{},[u,this]);}else if(this._defaultHandler){v=true;k.applyWithGuard(this._defaultHandler,{},[u,this]);}if(v&&this._showingID!=this.getActiveID())r(this._activeItem);},_setActiveItem:function(u){if(u!=this._activeItem){this._clearTimeouts();this._activeItem&&s(this._activeItem);this._activeItem=null;var v=u?0:100;this._hideTimeout=p(function(){if(this.getActiveID()!=this._showingID)this._hide();}.bind(this),v);if(u){var w=this._orderedList.getUserForNode(u);this._activeItem=u;var x=v+(this._alreadyShowing?75:500);this._showTimeout=p(function(){this._show();}.bind(this),x);this.inform('hover',w);}else this.inform('leave');this._checkAlreadyShowing();}},register:function(u,v){if(!this._handlers[u]){this._handlers[u]=v;return {unregister:function(){if(u==this._showingID)this._hide();delete this._handlers[u];var w=this._orderedList.getAllNodes(),x=w[u];x&&s(x);}.bind(this)};}},registerDefault:function(u){this._defaultHandler=u;},getActiveID:function(){var u=this._activeItem&&this._orderedList.getUserForNode(this._activeItem);return u||null;},showHovercard:function(u,v){if(u==this.getActiveID()&&u!=this._showingID){this._clearTimeouts();s(this._activeItem);this._hide();this._showingDialog=v;this._showingID=u;var w=v.subscribe('mouseenter',this._setActiveItem.bind(this,this._activeItem)),x=v.subscribe('mouseleave',function(){w.unsubscribe();this._setActiveItem(null);}.bind(this)),y=v.subscribe('hide',function(){w.unsubscribe();x.unsubscribe();y.unsubscribe();});v.enableBehavior(m).setContext(this._activeItem).setPosition('left').setOffsetY(9).show();}}});e.exports=t;});
__d("ChatOrderedList",["event-extensions","Animation","Arbiter","ArbiterMixin","AsyncDialog","AsyncRequest","AvailableList","AvailableListConstants","Chat","ChatConfig","ChatOrderedListHover","ChatQuietLinks","ChatVisibility","CSS","DataStore","DOM","HTML","JSLogger","LastMobileActiveTimes","OrderedFriendsList","Parent","PresencePrivacy","ShortProfiles","Tooltip","TypeaheadUtil","URI","XHPTemplate","copyProperties","createObjectFrom","debounceAcrossTransitions","goURI","tx","guid","MercuryConfig","ChannelImplementation"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Animation'),h=b('Arbiter'),i=b('ArbiterMixin'),j=b('AsyncDialog'),k=b('AsyncRequest'),l=b('AvailableList'),m=b('AvailableListConstants'),n=b('Chat'),o=b('ChatConfig'),p=b('ChatOrderedListHover'),q=b('ChatQuietLinks'),r=b('ChatVisibility'),s=b('CSS'),t=b('DataStore'),u=b('DOM'),v=b('HTML'),w=b('JSLogger'),x=b('LastMobileActiveTimes'),y=b('OrderedFriendsList'),z=b('Parent'),aa=b('PresencePrivacy'),ba=b('ShortProfiles'),ca=b('Tooltip'),da=b('TypeaheadUtil'),ea=b('URI'),fa=b('XHPTemplate'),ga=b('copyProperties'),ha=b('createObjectFrom'),ia=b('debounceAcrossTransitions'),ja=b('goURI'),ka=b('tx'),la=b('guid'),ma=b('MercuryConfig'),na=c('ChannelImplementation').instance;function oa(ta,ua,va,wa){this._root=ta;this._items={};this._isVisible=false;this._excludedIds={};this._numTopFriends=5;this._hasRendered=false;this._preventRendering=false;this._hoverController=null;this._template=ua;this._messageTemplate=va;this._contextualDialog=wa;Event.listen(this._root,'click',this._onClick.bind(this));Event.listen(this._root,'mouseenter',this._mouseEnter.bind(this));Event.listen(this._root,'mouseleave',this._mouseLeave.bind(this));l.subscribe(m.ON_AVAILABILITY_CHANGED,this.update.shield(this));aa.subscribe('privacy-changed',this.update.shield(this));na.subscribe([na.CONNECTED,na.RECONNECTING,na.SHUTDOWN,na.MUTE_WARNING,na.UNMUTE_WARNING],this.update.shield(this));this.inform('initialized',this,h.BEHAVIOR_PERSISTENT);this.render();h.subscribe(w.DUMP_EVENT,function(xa,ya){ya.chat_lists=ya.chat_lists||{sorted_list:this.getSortedList(),ordered_list:y.getList(),available_list:oa.getAvailableList(this._excludedIds),excluded_list:this._excludedIds};}.bind(this));}function pa(ta,ua){var va=qa(ta,ua);if(va!==0)return va;var wa=ra(ta,ua);if(wa!==0)return wa;return y.compare(ta,ua);}function qa(ta,ua){var va=aa.allows(ta),wa=aa.allows(ua);if(va!==wa)return va?-1:1;return 0;}function ra(ta,ua){var va=ba.getNow(ta),wa=ba.getNow(ua),xa=da.flatten((va||{}).name||'~'),ya=da.flatten((wa||{}).name||'~');if(xa!==ya)return xa<ya?-1:1;return 0;}function sa(ta,ua){var va=l.get(ta)===m.MOBILE,wa=l.get(ua)===m.MOBILE;if(va!==wa)return wa?-1:1;return ra(ta,ua);}ga(oa,{getSortedList:function(ta,ua){var va=y.getList().filter(function(lb){return !(lb in ta);});va=va.filter(function(lb){return aa.getFriendVisibility(lb)!==aa.BLACKLISTED;});var wa=[],xa=r.isOnline();if(xa){if(aa.getOnlinePolicy()===aa.ONLINE_TO_WHITELIST){var ya=va,za={},ab,bb;va=[];for(ab=0;ab<ya.length;++ab){bb=ya[ab];if(aa.allows(bb)){za[bb]=true;va.push(bb);}}var cb=aa.getWhitelist();for(ab=0;ab<cb.length;++ab){bb=cb[ab];if(!(bb in za))va.push(bb);}for(ab=0;ab<ya.length;++ab){bb=ya[ab];if(!aa.allows(bb))va.push(bb);}}var db=o.get('ordered_list.top_friends',0),eb=o.get('ordered_list.available_target',0),fb=Math.floor(ua*eb),gb=[];for(var ab=0,hb=va.length;ab<hb&&fb>0;ab++){var bb=va[ab],ib=l.get(bb),jb=ib===m.ACTIVE;if(o.get('chat_sidebar_mobile_available'))jb=jb||(ib===m.MOBILE);if(jb||ab<db){wa.push(bb);jb&&fb--;}else gb.push(bb);}if(ab<hb)Array.prototype.push.apply(gb,va.slice(ab));if(wa.length<ua)Array.prototype.push.apply(wa,gb);}else Array.prototype.push.apply(wa,va);wa=wa.slice(0,ua);if(wa.length===ua){var kb=oa.getAvailableList(wa.concat(ta)).length;kb&&wa.splice(-1);}wa.sort(pa);return wa;},getAvailableList:function(ta){return l.getOnlineIDs().filter(function(ua){return !(ua in ta);});}});ga(oa.prototype,i,{getAllNodes:function(){var ta={},ua=u.scry(this._root,'li.item');for(var va=0;va<ua.length;va++){var wa=t.get(ua[va],'id');if(wa)ta[wa]=ua[va];}return ta;},getShowingUsers:function(){return u.scry(this._root,'li.item').map(function(ta){return t.get(ta,'id');});},getUserForNode:function(ta){return t.get(ta,'id');},getHoverController:function(){if(!this._hoverController)this._hoverController=new p(this,this._contextualDialog);return this._hoverController;},_getListItem:function(ta){var ua=this._items[ta];if(ua){var va=l.get(ta),wa=aa.allows(ta)&&!na.disconnected(),xa={active:false,mobile:false,greenphone:false},ya=u.scry(ua,'.active_time')[0]||null;ya&&u.empty(ya);xa.active=va===m.ACTIVE;if(o.get('sidebar_mobile_icon_green')){xa.greenphone=va===m.MOBILE;}else xa.mobile=va===m.MOBILE;if(xa.mobile){var za=x.getShortDisplay(ta);ya&&u.setContent(ya,za);}for(var ab in xa)s.conditionClass(ua,ab,xa[ab]&&wa);s.conditionClass(ua,'invis',!wa);u.scry(ua,'img.status').forEach(function(bb){if(va===m.ACTIVE&&wa){bb.alt="Online";}else if(va===m.MOBILE&&wa){bb.alt="Mobile";}else bb.alt='';});}return ua;},getRoot:function(){return this._root;},getSortedList:function(){return oa.getSortedList(this._excludedIds,this._numTopFriends);},hide:function(){if(!this._isVisible)return;this._isVisible=false;s.hide(this._root);this.inform('hide');},_onClick:function(event){var ta=event.getTarget(),ua=z.byTag(ta,'li');if(ua){if(s.hasClass(ua,'blackbirdWhitelist')){var va=new ea('/ajax/chat/privacy/settings_dialog.php').addQueryData({ref:'whitelist_separator'});j.send(new k(va));event.prevent();return false;}var wa=t.get(ua,'id');if(wa){var xa='ordered_list';while(ua.previousSibling){ua=ua.previousSibling;if(s.hasClass(ua,'separator')){if(s.hasClass(ua,'moreOnlineFriends')){xa='more_online_friends';break;}if(s.hasClass(ua,'blackbirdWhitelist')){xa='blackbird_offline_section';break;}}}var ya=[];if(o.get('chat_realtime_coefficient_impressions'))ya=this.getSortedList();ba.get(wa,function(za){n.openTab(wa,za.name,'friend',xa,ya);});this.inform('click',{id:wa});}else if(s.hasClass(ua,'separator')&&z.byClass(ta,'inner'))this.scrollTo(ua);return false;}},_mouseEnter:function(){this._preventRendering=true;},_mouseLeave:function(){this._preventRendering=false;},setExcludedIds:function(ta){this._excludedIds=ha(ta||[]);},setNumTopFriends:function(ta){if(ta!==this._numTopFriends){this._numTopFriends=ta;this.render();}},_getOfflineToSectionItems:function(){var ta='subheader-text-'+la(),ua=u.create('a',{href:'#','aria-describedby':ta},u.tx._("Edit")),va=[],wa=ma.ChatControlLanguageChangeGK?u.tx._("MORE FRIENDS"):u.tx._("OFFLINE FRIENDS");va.push(v('<li class="separator">'+'<div class="outer">'+'<div class="inner">'+'<span class="text">'+wa+'</span>'+'<div class="dive"><span class="bar"></span></div>'+'</div>'+'</div>'+'</li>'));va.push(v('<li class="separator blackbirdWhitelist">'+'<div class="outer">'+'<div class="inner">'+'<div class="subheader">'+'<span id="'+ta+'" class="subheaderText">'+u.tx._("These friends can't see you on chat. {=link}",{'=link':ua})+'</span>'+'</div>'+'</div>'+'</li>'));return va;},render:function(){this.render=ia(function(){if(!this._isVisible||(this._preventRendering&&this._hasRendered))return;this._hasRendered=true;var ta=this.getSortedList(),ua=[],va,wa,xa=aa.getVisibility()&&aa.getOnlinePolicy()==aa.ONLINE_TO_WHITELIST;for(var ya=0,za=ta.length;ya<za;ya++){va=ta[ya];if(xa)if(!aa.allows(va)){if(ya+2>=ta.length)break;xa=false;var ab=this._getOfflineToSectionItems();ua.push(ab[0]);ua.push(ab[1]);za-=2;}wa=this._getListItem(va);if(wa){ua.push(wa);}else this._renderListItem(va,this.render.bind(this));}var bb=oa.getAvailableList(this._excludedIds),cb=ha(ta);bb=bb.filter(function(ib){return !(ib in cb);});bb.sort(sa);var db=ma.ChatControlLanguageChangeGK?"MORE FRIENDS":"MORE ONLINE FRIENDS";if(bb.length&&ua.length)ua.push(v('<li class="separator moreOnlineFriends">'+'<div class="outer">'+'<div class="inner">'+'<span class="text">'+ka._("{MORE ONLINE FRIENDS} ({=count})",{'MORE ONLINE FRIENDS':db,'=count':bb.length})+'</span>'+'<div class="dive"><span class="bar"></span></div>'+'</div>'+'</div>'+'</li>'));for(var eb=0,fb=bb.length;eb<fb;eb++){va=bb[eb];wa=this._getListItem(va);if(wa){ua.push(wa);}else this._renderListItem(va,this.render.bind(this));}if(!ta.length&&!bb.length){var gb=this._messageTemplate.render(),hb=fa.getNode(gb,'message');u.setContent(hb,"No one is available to chat.");ua.push(gb);}if(ua.length){u.setContent(this._root,ua);q.nukeLinks(this.getRoot());this.inform('render');}},300,this);this.render();},_renderListItem:function(ta,ua){ba.get(ta,function(va){if(va.type==='friend'){var wa=this._template.render(),xa=fa.getNode(wa,'profile-photo');xa.setAttribute('src',va.thumbSrc);var ya=fa.getNode(wa,'name');u.setContent(ya,va.name);var za=fa.getNode(wa,'anchor');za.setAttribute('href','/messages/'+ta);var ab=fa.getNode(wa,'timeline_icon');if(ab){var bb=ka._("Go to {name}'s timeline",{name:va.firstName});ca.set(ab,bb,'above','center');Event.listen(ab,'click',function(event){event.kill();ja(va.uri);});}t.set(wa,'id',ta);this._items[ta]=wa;ua&&ua(wa);}}.bind(this));},show:function(){if(this._isVisible)return;this._isVisible=true;s.show(this._root);this.render();this.inform('show');},isVisible:function(){return this._isVisible;},update:function(){this._hasRendered=false;this.render();},setScrollContainer:function(ta){if(u.contains(ta,this._root))this._scrollContainer=ta;},scrollTo:function(ta){if(!this._scrollContainer)return;var ua=this._scrollContainer.scrollHeight,va=this._scrollContainer.clientHeight,wa=this._scrollContainer.scrollTop,xa=Math.min(ta.offsetTop,ua-va);if(wa!==xa){var ya=Math.abs(xa-wa)/this._scrollContainer.clientHeight*500;g(this._scrollContainer).to('scrollTop',xa).ease(g.ease.end).duration(ya).go();}}});e.exports=oa;});
__d("TypingDetector",["event-extensions","function-extensions","ArbiterMixin","Class","Input","Run","copyProperties","createObjectFrom","emptyFunction"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('ArbiterMixin'),h=b('Class'),i=b('Input'),j=b('Run'),k=b('copyProperties'),l=b('createObjectFrom'),m=b('emptyFunction');function n(o){this._input=o;this._ignoreKeys={};}n.INACTIVE=0;n.TYPING=1;n.QUITTING=2;k(n.prototype,g,{_timeout:7000,_currentState:n.INACTIVE,init:function(){this.init=m;this.reset();Event.listen(this._input,'keyup',this._update.bind(this));j.onUnload(this._onunload.bind(this));},reset:function(){clearTimeout(this._checkTimer);this._checkTimer=null;this._lastKeystrokeAt=null;this._currentState=n.INACTIVE;},setIgnoreKeys:function(o){this._ignoreKeys=l(o);},_onunload:function(){if(this._currentState==n.TYPING)this._transition(n.QUITTING);},_update:function(event){var o=Event.getKeyCode(event),p=this._currentState;if(!this._ignoreKeys[o])if(i.getValue(this._input).trim().length===0){if(p==n.TYPING)this._transition(n.INACTIVE);}else if(p==n.TYPING){this._recordKeystroke();}else if(p==n.INACTIVE){this._transition(n.TYPING);this._recordKeystroke();}},_transition:function(o){this.reset();this._currentState=o;this.inform('change',o);},_recordKeystroke:function(){this._lastKeystrokeTime=Date.now();if(!this._checkTimer)this._checkTimer=this._checkTyping.bind(this).defer(this._timeout);},_checkTyping:function(){var o=this._lastKeystrokeTime+this._timeout,p=Date.now();if(p>o){this._transition(n.INACTIVE);}else{clearTimeout(this._checkTimer);this._checkTimer=this._checkTyping.bind(this).defer(o-p+10);}}});e.exports=n;});
__d("TypingIndicator",["AsyncRequest","AvailableList","AvailableListConstants","ChannelConnection","ChatVisibility","Keys","PresencePrivacy","ShortProfiles","TypingDetector","copyProperties","emptyFunction"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('AvailableList'),i=b('AvailableListConstants'),j=b('ChannelConnection'),k=b('ChatVisibility'),l=b('Keys'),m=b('PresencePrivacy'),n=b('ShortProfiles'),o=b('TypingDetector'),p=b('copyProperties'),q=b('emptyFunction');function r(t){if(!k.isOnline())return false;if(t){var u=n.getNow(t);return u&&u.type=="friend"&&m.allows(t);}return true;}function s(t,u,v,w,x){this.userID=t;this.input=u;this.source=v;this.threadID=x;this.remoteState=o.INACTIVE;this.notifyTimer=null;w=w||{};this.notifyDelay=w.notifyDelay||this.notifyDelay;this._typingDetector=new o(u);this._typingDetector.init(w);this._typingDetector.subscribe('change',this._stateChange.bind(this));}p(s.prototype,{notifyDelay:1000,setUserAndThread:function(t,u){if(this.userID!==t||this.threadID!==u){this.resetState();this.userID=t;this.threadID=u;}},setIgnoreEnter:function(t){var u=t?[l.RETURN]:[];this._typingDetector.setIgnoreKeys(u);},resetState:function(){this.remoteState=s.INACTIVE;this._typingDetector.reset();clearTimeout(this.notifyTimer);this.notifyTimer=null;},_stateChange:function(t,u){if(u!=o.QUITTING){clearTimeout(this.notifyTimer);this.notifyTimer=this._notifyState.shield(this,u).defer(this.notifyDelay,false);}else this._notifyState(u,true);},_notifyState:function(t,u){if(!this.userID&&!this.threadID)return;var v=this.userID,w=r(v);if(w&&t!=this.remoteState){this.remoteState=t;if(j.disconnected())return;var x={typ:t,to:v,source:this.source,thread:this.threadID};new g().setHandler(this._onTypResponse.bind(this,v)).setErrorHandler(q).setData(x).setURI('/ajax/messaging/typ.php').setAllowCrossPageTransition(true).setOption('asynchronous',!u).send();}},_onTypResponse:function(t,u){var v=u.getPayload()||{};if(v.offline)h.set(t,i.OFFLINE,'typing_response');}});e.exports=s;});
__d("ChatSidebarSheet",["event-extensions","function-extensions","ArbiterMixin","BlackbirdUpsell","ChannelConnection","ChannelConstants","ChatBehavior","ChatConfig","ChatVisibility","CSS","DOM","JSLogger","PresencePrivacy","copyProperties","tx","MercuryConfig"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('ArbiterMixin'),h=b('BlackbirdUpsell'),i=b('ChannelConnection'),j=b('ChannelConstants'),k=b('ChatBehavior'),l=b('ChatConfig'),m=b('ChatVisibility'),n=b('CSS'),o=b('DOM'),p=b('JSLogger'),q=b('PresencePrivacy'),r=b('copyProperties'),s=b('tx'),t=b('MercuryConfig'),u=p.create('sidebar_sheet');function v(y){switch(y){case j.HINT_AUTH:return "Your session has timed out. Please log in.";case j.HINT_CONN:return s._("Facebook {Chat} is currently unavailable.",{Chat:"Chat"});case j.HINT_MAINT:return s._("Facebook {Chat} is currently down for maintenance.",{Chat:"Chat"});default:return s._("Facebook {Chat} is currently unavailable.",{Chat:"Chat"});}}function w(y){var z;if(y===null){z="Unable to connect to chat. Check your Internet connection.";}else if(y>l.get('warning_countdown_threshold_msec')){var aa=o.create('a',{href:'#',className:'fbChatReconnectLink'},"Try again");z=o.tx._("Unable to connect to chat. {try-again-link}",{'try-again-link':aa});}else if(y>1000){z=s._("Unable to connect to chat. Reconnecting in {seconds}...",{seconds:Math.floor(y/1000)});}else z="Unable to connect to chat. Reconnecting...";return z;}function x(y){this._root=y;this._message=o.find(y,'div.fbChatSidebarMessage div.message');i.subscribe([i.CONNECTED,i.SHUTDOWN,i.RECONNECTING],this._handleConnectionChange.bind(this));i.subscribe([i.MUTE_WARNING,i.UNMUTE_WARNING],this._render.bind(this));q.subscribe('privacy-user-presence-changed',this._render.bind(this));k.subscribe(k.ON_CHANGED,this._render.bind(this));this._render();}r(x.prototype,g,{_channelStatus:null,_channelData:null,_handleConnectionChange:function(y,z){this._channelStatus=y;this._channelData=z;this._render();},_showWarningTimeout:null,_warningMsgEventListener:null,_renderChannelDisconnect:function(){if(this._channelStatus===i.SHUTDOWN){return o.setContent(this._message,v(this._channelData));}else if(this._channelStatus===i.RECONNECTING){var y=this._channelData;o.setContent(this._message,w(y));if(y>1000){if(y>l.get('warning_countdown_threshold_msec'))this._warningMsgEventListener=Event.listen(this._message,'click',function(event){if(n.hasClass(event.getTarget(),'fbChatReconnectLink')){i.reconnect();return false;}});this._showWarningTimeout=setTimeout(this._handleConnectionChange.bind(this,i.RECONNECTING,y-1000),1000,false);}}},_goOnlineEventListener:null,_renderOffline:function(){var y='fbChatGoOnlineLink',z=t.ChatControlLanguageChangeGK?"Turn on chat":"Go online",aa=o.create('a',{href:'#',className:y},z),ba;if(t.ChatControlLanguageChangeGK){ba=o.tx._("{=Go online} to see who's available.",{'=Go online':aa});}else ba=o.tx._("{=Go online} to see who's online to chat.",{'=Go online':aa});o.setContent(this._message,ba);this._goOnlineEventListener=Event.listen(this._message,'click',function(event){if(n.hasClass(event.getTarget(),y)){u.log('sidebar_go_online');m.goOnline();return false;}});},_renderBlackbirdUpsell:function(){o.setContent(this._message,h.getOfflineContent());},_renderBlackbird:function(y){o.setContent(this._message,h.getBlackbirdContent(y));},_clear:function(){if(this._showWarningTimeout){clearTimeout(this._showWarningTimeout);this._showWarningTimeout=null;}if(this._warningMsgEventListener){this._warningMsgEventListener.remove();this._warningMsgEventListener=null;}if(this._goOnlineEventListener){this._goOnlineEventListener.remove();this._goOnlineEventListener=null;}n.removeClass(this._root,'upsell');n.removeClass(this._root,'offline');n.removeClass(this._root,'blackbird');n.removeClass(this._root,'error');n.removeClass(this._root,'notice');o.empty(this._message);},_render:function(){this._clear();if(h.shouldShow()){if(m.hasBlackbirdEnabled()){var y=m.isOnline()?'blackbird':'upsell';n.addClass(this._root,y);this._renderBlackbird(q.getVisibility());}else if(!m.isOnline()){n.addClass(this._root,'upsell');this._renderBlackbirdUpsell();}}else if(!m.isOnline()){n.addClass(this._root,'offline');this._renderOffline();}else if(i.disconnected()){n.addClass(this._root,'error');this._renderChannelDisconnect();}else if(!k.notifiesUserMessages()){n.addClass(this._root,'notice');o.setContent(this._message,"Alerts are off while you use another client to chat.");}this.inform('updated');}});e.exports=x;});
__d("ChatSidebar",["JSXDOM","ChatOrderedList","ChatTypeaheadBehavior","ChatTypeaheadCore","ChatTypeaheadDataSource","ChatTypeaheadRenderer","event-extensions","Typeahead","Arbiter","ArbiterMixin","AsyncRequest","ChatConfig","ChatHovercard","ChatOptions","ChatSidebarSheet","CSS","DOM","DOMDimensions","FBDesktopPlugin","JSLogger","OrderedFriendsList","PresencePrivacy","ScrollableArea","Style","UserAgent","ViewportBounds","copyProperties","createArrayFrom","debounce","emptyFunction"],function(a,b,c,d,e,f){var g=b('JSXDOM');b('ChatOrderedList');b('ChatTypeaheadBehavior');b('ChatTypeaheadCore');b('ChatTypeaheadDataSource');b('ChatTypeaheadRenderer');b('event-extensions');b('Typeahead');var h=b('Arbiter'),i=b('ArbiterMixin'),j=b('AsyncRequest'),k=b('ChatConfig'),l=b('ChatHovercard'),m=b('ChatOptions'),n=b('ChatSidebarSheet'),o=b('CSS'),p=b('DOM'),q=b('DOMDimensions'),r=b('FBDesktopPlugin'),s=b('JSLogger'),t=b('OrderedFriendsList'),u=b('PresencePrivacy'),v=b('ScrollableArea'),w=b('Style'),x=b('UserAgent'),y=b('ViewportBounds'),z=b('copyProperties'),aa=b('createArrayFrom'),ba=b('debounce'),ca=b('emptyFunction'),da,ea=false,fa=false,ga=false,ha=false,ia=false,ja,ka,la,ma,na=null,oa=s.create('chat_sidebar'),pa=32;function qa(){o.removeClass(document.documentElement,'sidebarMode');if(!ha||!wa.isVisible()){h.inform('reflow');return;}ga=false;na=null;o.hide(ka);ja.hide();la.getCore().reset();oa.rate('sidebar_hide',ha);wa.inform('sidebar/hide',wa);h.inform('sidebar/hide',wa);h.inform('reflow');}function ra(){var xa=wa.shouldShowSidebar();o.conditionClass(document.documentElement,'sidebarCapable',xa);if(wa.isEnabled()&&xa){sa();var ya=ma.height;aa(ka.childNodes).forEach(function(za){if(za!==da)ya-=q.getElementDimensions(za).height;});ya=Math.max(0,ya);w.set(da,'height',ya+'px');this._maxItems=Math.floor((ya-8)/pa);ja.setNumTopFriends(this._maxItems);la.getData().setMaxResults(this._maxItems);wa.inform('sidebar/resized',wa);h.inform('sidebar/resized',wa);h.inform('reflow');}else qa();if(!ha){va();ha=true;}na=null;}function sa(){if(wa.isVisible())return;ga=true;na=null;o.show(ka);o.addClass(document.documentElement,'sidebarMode');ja.show();oa.rate('sidebar_show',ha);wa.inform('sidebar/show',wa);h.inform('sidebar/show',wa);}function ta(){m.setSetting('sidebar_mode',wa.isEnabled(),'sidebar');new j('/ajax/chat/settings.php').setHandler(ca).setErrorHandler(ca).setData({sidebar_mode:wa.isEnabled()}).setAllowCrossPageTransition(true).send();}function ua(){return t.getList().length<=k.get('sidebar.min_friends');}function va(){var xa=true;if(!wa.isEnabled()){oa.log('state_not_enabled');xa=false;}if(!wa.isViewportCapable()){oa.log('state_not_shown_viewport');xa=false;}if(fa){oa.log('state_not_shown_hidden');xa=false;}if(ua()){oa.log('state_not_shown_num_friends');xa=false;}if(r.shouldSuppressSidebar()){oa.log('state_not_shown_fbdesktop');xa=false;}oa.log(xa?'state_shown':'state_not_shown');}var wa={init:function(xa,ya,za){wa.init=ca;ia=true;ka=xa;ja=ya;la=za;da=p.find(xa,'div.fbChatSidebarBody');if(k.get('chat_sidebar_hovercards'))new l(ya);var ab=new n(xa);ab.subscribe('updated',ra);h.subscribe('sidebar/invalidate',ra);ya.setScrollContainer(p.find(da,'div.uiScrollableAreaWrap'));ya.subscribe(['render','show','hide'],ba(function(){var bb=ya.getRoot(),cb=v.getInstance(bb);cb&&cb.adjustGripper();}));Event.listen(window,'resize',ra);if(x.firefox()>=17)Event.listen(window,'storage',function(bb){if(bb.key=='_socialfox_active'&&bb.oldValue!=bb.newValue)ra();});h.subscribe('chat/option-changed',function(bb,cb){if(cb.name=="sidebar_mode"){ea=!!m.getSetting('sidebar_mode');ra();}});za.subscribe(['respond','reset'],function(bb,cb){if(ga)if(cb&&cb.value&&cb.value===za.getCore().getValue()&&za.getView().isVisible()){ja.hide();}else ja.show();});za.getData().subscribe('beforeQuery',ra);h.subscribe('buddylist-nub/initialized',function(bb,cb){Event.listen(cb.getButton(),'click',function(event){wa.enable();return !wa.shouldShowSidebar();});});ea=!!m.getSetting('sidebar_mode');u.subscribe('privacy-user-presence-changed',ra);ra();y.addRight(wa.getVisibleWidth);wa.inform('sidebar/initialized',wa,h.BEHAVIOR_PERSISTENT);h.inform('sidebar/initialized',wa,h.BEHAVIOR_PERSISTENT);},isInitialized:function(){return ha;},disable:function(){if(!wa.isEnabled())return;ea=false;ta();qa();},enable:function(){if(wa.isEnabled())return;ea=true;ta();ra();!function(){if(wa.isVisible())la.getCore().getElement().focus();}.defer();},ensureLoaded:function(){if(ia)return;d(['UIPagelet'],function(xa){var ya=g.div({id:"pagelet_sidebar"});p.appendContent(document.body,ya);xa.loadFromEndpoint('SidebarPagelet','pagelet_sidebar');});ia=true;},hide:function(){if(fa)return;fa=true;qa();},unhide:function(){if(!fa)return;fa=false;ra();},getBody:function(){return da;},getRoot:function(){return ka;},getVisibleWidth:function(){if(!ga||!ka)return 0;if(na===null)na=ka.offsetWidth;return na;},isEnabled:function(){return ea;},isViewportCapable:function(){ma=q.getViewportWithoutScrollbarDimensions();var xa=k.get('sidebar.minimum_width');return ma.width>xa;},shouldShowSidebar:function(){return wa.isViewportCapable()&&!fa&&!ua()&&!r.shouldSuppressSidebar();},isVisible:function(){return ga;},resize:ra,toggle:function(){wa.isEnabled()?wa.disable():wa.enable();}};z(wa,i);e.exports=wa;});
__d("VideoCallingTour",["event-extensions","Arbiter","ArbiterMixin","Chat","ChatSidebar","ChatVisibility","CSS","DOM","PresencePrivacy","Run","Toggler","Vector","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('Chat'),j=b('ChatSidebar'),k=b('ChatVisibility'),l=b('CSS'),m=b('DOM'),n=b('PresencePrivacy'),o=b('Run'),p=b('Toggler'),q=b('Vector'),r=b('copyProperties'),s,t,u,v,w=[],x=function(){};function y(){if(j.isVisible()){z();}else if(u)aa();}function z(){s.setContext(t.getBody());ba();s.show();ca();}function aa(){if(!v)v=p.createInstance(u.getRoot());var fa=m.scry(u.getRoot(),'div.fbNubFlyout')[0];if(fa){s.setContext(fa);ba();s.show();ca();}}function ba(){var fa=q.getElementDimensions(s.getContext()).y;s.setOffsetY(fa*.6);s.updatePosition();}function ca(){if(u)w.push(u.subscribe('hide',function(){da();if(!j.isVisible())s.hide();}),u.subscribe('show',function(){s.show();}),u.subscribe('resize',function(){ba();s.updatePosition();}));w.push(g.subscribe('sidebar/show',z),g.subscribe('sidebar/hide',aa),g.subscribe('sidebar/resized',ba));}function da(){if(v){v.setSticky(false);v=null;}}function ea(){while(w.length)w.pop().unsubscribe();if(u)da();s.hide();l.show('fbVideoCallingGetStarted');}r(x,h,{start:function(fa){s=fa;l.hide('fbVideoCallingGetStarted');k.goOnline(function(){w.push(n.subscribe('privacy-user-presence-changed',ea));o.onLeave(ea);i.openBuddyList();var ga=null;w.push(j.subscribe('sidebar/initialized',function(ha,ia){t=ia;clearTimeout(ga);ga=y.defer();}),x.subscribe('videocallingtour/end',ea));w.push(g.subscribe('buddylist-nub/initialized',function(ha,ia){u=ia;clearTimeout(ga);ga=y.defer();}));});x.inform('videocallingtour/start');}});e.exports=x;});
__d("md5",[],function(a,b,c,d,e,f){function g(u,v){var w=u[0],x=u[1],y=u[2],z=u[3];w=i(w,x,y,z,v[0],7,-680876936);z=i(z,w,x,y,v[1],12,-389564586);y=i(y,z,w,x,v[2],17,606105819);x=i(x,y,z,w,v[3],22,-1044525330);w=i(w,x,y,z,v[4],7,-176418897);z=i(z,w,x,y,v[5],12,1200080426);y=i(y,z,w,x,v[6],17,-1473231341);x=i(x,y,z,w,v[7],22,-45705983);w=i(w,x,y,z,v[8],7,1770035416);z=i(z,w,x,y,v[9],12,-1958414417);y=i(y,z,w,x,v[10],17,-42063);x=i(x,y,z,w,v[11],22,-1990404162);w=i(w,x,y,z,v[12],7,1804603682);z=i(z,w,x,y,v[13],12,-40341101);y=i(y,z,w,x,v[14],17,-1502002290);x=i(x,y,z,w,v[15],22,1236535329);w=j(w,x,y,z,v[1],5,-165796510);z=j(z,w,x,y,v[6],9,-1069501632);y=j(y,z,w,x,v[11],14,643717713);x=j(x,y,z,w,v[0],20,-373897302);w=j(w,x,y,z,v[5],5,-701558691);z=j(z,w,x,y,v[10],9,38016083);y=j(y,z,w,x,v[15],14,-660478335);x=j(x,y,z,w,v[4],20,-405537848);w=j(w,x,y,z,v[9],5,568446438);z=j(z,w,x,y,v[14],9,-1019803690);y=j(y,z,w,x,v[3],14,-187363961);x=j(x,y,z,w,v[8],20,1163531501);w=j(w,x,y,z,v[13],5,-1444681467);z=j(z,w,x,y,v[2],9,-51403784);y=j(y,z,w,x,v[7],14,1735328473);x=j(x,y,z,w,v[12],20,-1926607734);w=k(w,x,y,z,v[5],4,-378558);z=k(z,w,x,y,v[8],11,-2022574463);y=k(y,z,w,x,v[11],16,1839030562);x=k(x,y,z,w,v[14],23,-35309556);w=k(w,x,y,z,v[1],4,-1530992060);z=k(z,w,x,y,v[4],11,1272893353);y=k(y,z,w,x,v[7],16,-155497632);x=k(x,y,z,w,v[10],23,-1094730640);w=k(w,x,y,z,v[13],4,681279174);z=k(z,w,x,y,v[0],11,-358537222);y=k(y,z,w,x,v[3],16,-722521979);x=k(x,y,z,w,v[6],23,76029189);w=k(w,x,y,z,v[9],4,-640364487);z=k(z,w,x,y,v[12],11,-421815835);y=k(y,z,w,x,v[15],16,530742520);x=k(x,y,z,w,v[2],23,-995338651);w=l(w,x,y,z,v[0],6,-198630844);z=l(z,w,x,y,v[7],10,1126891415);y=l(y,z,w,x,v[14],15,-1416354905);x=l(x,y,z,w,v[5],21,-57434055);w=l(w,x,y,z,v[12],6,1700485571);z=l(z,w,x,y,v[3],10,-1894986606);y=l(y,z,w,x,v[10],15,-1051523);x=l(x,y,z,w,v[1],21,-2054922799);w=l(w,x,y,z,v[8],6,1873313359);z=l(z,w,x,y,v[15],10,-30611744);y=l(y,z,w,x,v[6],15,-1560198380);x=l(x,y,z,w,v[13],21,1309151649);w=l(w,x,y,z,v[4],6,-145523070);z=l(z,w,x,y,v[11],10,-1120210379);y=l(y,z,w,x,v[2],15,718787259);x=l(x,y,z,w,v[9],21,-343485551);u[0]=r(w,u[0]);u[1]=r(x,u[1]);u[2]=r(y,u[2]);u[3]=r(z,u[3]);}function h(u,v,w,x,y,z){v=r(r(v,u),r(x,z));return r((v<<y)|(v>>>(32-y)),w);}function i(u,v,w,x,y,z,aa){return h((v&w)|((~v)&x),u,v,y,z,aa);}function j(u,v,w,x,y,z,aa){return h((v&x)|(w&(~x)),u,v,y,z,aa);}function k(u,v,w,x,y,z,aa){return h(v^w^x,u,v,y,z,aa);}function l(u,v,w,x,y,z,aa){return h(w^(v|(~x)),u,v,y,z,aa);}function m(u){var v=u.length,w=[1732584193,-271733879,-1732584194,271733878],x;for(x=64;x<=u.length;x+=64)g(w,n(u.substring(x-64,x)));u=u.substring(x-64);var y=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(x=0;x<u.length;x++)y[x>>2]|=u.charCodeAt(x)<<((x&3)<<3);y[x>>2]|=128<<((x&3)<<3);if(x>55){g(w,y);for(x=0;x<16;x++)y[x]=0;}y[14]=v*8;g(w,y);return w;}function n(u){var v=[],w=0;while(w<64)v[w>>2]=u.charCodeAt(w++)|(u.charCodeAt(w++)<<8)|(u.charCodeAt(w++)<<16)|(u.charCodeAt(w++)<<24);return v;}var o='0123456789abcdef'.split('');function p(u){var v='',w=0;for(;w<4;w++)v+=o[(u>>((w<<3)+4))&15]+o[(u>>(w<<3))&15];return v;}function q(u){for(var v=0;v<u.length;v++)u[v]=p(u[v]);return u.join('');}var r=function(u,v){return (u+v)&4294967295;};function s(u){var v="",w,x;for(var y=0;y<u.length;y++){w=u.charCodeAt(y);x=y+1<u.length?u.charCodeAt(y+1):0;if(55296<=w&&w<=56319&&56320<=x&&x<=57343){w=65536+((w&1023)<<10)+(x&1023);y++;}if(w<=127){v+=String.fromCharCode(w);}else if(w<=2047){v+=String.fromCharCode(192|((w>>>6)&31),128|(w&63));}else if(w<=65535){v+=String.fromCharCode(224|((w>>>12)&15),128|((w>>>6)&63),128|(w&63));}else if(w<=2097151)v+=String.fromCharCode(240|((w>>>18)&7),128|((w>>>12)&63),128|((w>>>6)&63),128|(w&63));}return v;}function t(u){if(null===u||undefined===u){return null;}else{for(var v=0;v<u.length;v++)if(u[v]>"\u007F"){u=s(u);break;}return q(m(u));}}if(t('hello')!='5d41402abc4b2a76b9719d911017c592')r=function(u,v){var w=(u&65535)+(v&65535),x=(u>>16)+(v>>16)+(w>>16);return (x<<16)|(w&65535);};e.exports=t;});
__d("DropdownContextualHelpLink",["copyProperties","DOM","ge"],function(a,b,c,d,e,f){var g=b('copyProperties'),h=b('DOM'),i=b('ge'),j={set:function(k){var l=i('navHelpCenter');if(l!==null)h.replace(l,k);}};e.exports=j;});
__d("isRTL",[],function(a,b,c,d,e,f){var g='A-Za-z\xC0-\xD6\xD8-\xF6\xF8-\u02B8\u0300-\u0590\u0800-\u1FFF'+'\u200E\u2C00-\uFB1C\uFE00-\uFE6F\uFEFD-\uFFFF',h='\u0591-\u07FF\u200F\uFB1D-\uFDFF\uFE70-\uFEFC',i=new RegExp('^[^'+g+']*['+h+']'),j=new RegExp('['+g+']');function k(l){var m=0,n=0;l.split(/\s+/,20).forEach(function(o){if(/^https?:\/\//.test(o))return;if(i.test(o)){n++;m++;}else if(j.test(o))m++;});return !!(m&&(n/m>.4));}e.exports=k;});
__d("IntlDateFormats",[],function(a,b,c,d,e,f){var g={},h={setFormats:function(i,j){g=j;},getFormat:function(i){if(!(i in g))return i;return g[i];}};e.exports=h;});
__d("date-extensions",["IntlDateFormats","copyProperties","tx"],function(a,b,c,d,e,f){var g=b('IntlDateFormats'),h=b('copyProperties'),i=b('tx'),j=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],k=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],l=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],m=["January","February","March","April","May","June","July","August","September","October","November","December"];function n(o,p){p=p||2;o=''+o;while(o.length<p)o='0'+o;return o;}Date.format=function(o,p,q){var r=p?new Date(p*1000):new Date();return r.format(o,q);};h(Date.prototype,{format:function(o,p){if(!o)return '';var q=[],r=null,s=null,t=(p?'getUTC':'get'),u=this[t+'Date'](),v=this[t+'Day'](),w=this[t+'Month'](),x=this[t+'FullYear'](),y=this[t+'Hours'](),z=this[t+'Minutes'](),aa=this[t+'Seconds'](),ba=this[t+'Milliseconds']();for(var ca=0;ca<o.length;ca++){s=o.charAt(ca);if(s=='\\'){ca++;q.push(o.charAt(ca));continue;}switch(s){case 'd':r=n(u);break;case 'D':r=j[v];break;case 'j':r=u;break;case 'l':r=k[v];break;case 'F':r=m[w];break;case 'm':r=n(w+1);break;case 'M':r=l[w];break;case 'n':r=w+1;break;case 'Y':r=x;break;case 'y':r=(''+x).slice(2);break;case 'a':r=y<12?'am':'pm';break;case 'A':r=y<12?'AM':'PM';break;case 'g':r=(y==0||y==12)?12:y%12;break;case 'G':r=y;break;case 'h':r=(y==0||y==12)?12:n(y%12);break;case 'H':r=n(y);break;case 'i':r=n(z);break;case 's':r=n(aa);break;case 'S':r=n(ba,3);break;default:r=s;}q.push(r);}return q.join('');}});a.IntlDateFormats=g;},3);
__d("FileFormResetOnSubmit",["DOMQuery","copyProperties"],function(a,b,c,d,e,f){var g=b('DOMQuery'),h=b('copyProperties');function i(j){this._form=j;}h(i.prototype,{enable:function(){this._subscription=this._form.subscribe('submit',Function.prototype.defer.bind(this._reset.bind(this)));},disable:function(){this._subscription.unsubscribe();this._subscription=null;},_reset:function(){var j=g.scry(this._form.getRoot(),'input[type="file"]');j.forEach(function(k){k.value='';});}});e.exports=i;});
__d("FileInput",["event-extensions","ArbiterMixin","CSS","DOM","UserAgent","copyProperties","cx"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ArbiterMixin'),h=b('CSS'),i=b('DOM'),j=b('UserAgent'),k=b('copyProperties'),l=b('cx'),m=j.ie();function n(o,p,q){this.container=o;this.control=p;this.input=q;var r=i.scry(this.container,'a')[0];r&&r.removeAttribute('href');var s=i.create('div',{className:"_3jk"},this.input);i.appendContent(this.control,s);this._initListeners();}k(n.prototype,g,{getValue:function(){return this.input.value;},getInput:function(){return this.input;},clear:function(){if(m){var o=i.deepClone(this.input);i.replace(this.input,o);this.input=o;while(this._listeners.length)this._listeners.pop().remove();this._initListeners();}else{this.input.value='';this.input.files=null;}},_initListeners:function(){this._listeners=[Event.listen(this.input,'change',m===7?this._handleChangeInIE7.bind(this):this._handleChange.bind(this)),Event.listen(this.input,'focus',this._handleFocusChange.bind(this)),Event.listen(this.input,'blur',this._handleFocusChange.bind(this))];},_handleChangeInIE7:function(event){if(this._blurring){this._blurring=false;return;}this._handleChange(event);(function(){this._blurring=true;this.input.blur();}).bind(this).defer();},_handleChange:function(event){this.inform('change',event);var o=this.input.form;if(o&&m<9)Event.fire(o,'change',event);},_handleFocusChange:function(event){h.conditionClass(this.control,"_3t8",event.type==='focus');}});e.exports=n;});
__d("MercuryFileUploader",["event-extensions","ArbiterMixin","CSS","DOM","FileForm","FileFormResetOnSubmit","FileInput","FormSubmitOnChange","MercuryAttachment","MercuryAttachmentTemplates","copyProperties","csx","cx","getObjectValues","startsWith"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ArbiterMixin'),h=b('CSS'),i=b('DOM'),j=b('FileForm'),k=b('FileFormResetOnSubmit'),l=b('FileInput'),m=b('FormSubmitOnChange'),n=b('MercuryAttachment'),o=b('MercuryAttachmentTemplates'),p=b('copyProperties'),q=b('csx'),r=b('cx'),s=b('getObjectValues'),t=b('startsWith'),u=0;function v(x,y,z,aa){this._parentElem=x;this._attachments={};this._uploading={};this._uploadTemplates={};this._fileForm=new j(y,[m,k]);var ba=i.find(y,"._3kt");if(!z)z=i.create('input',{type:'file',className:"_n",name:'attachment[]',multiple:1});new l(ba,i.find(ba,"._213"),z);this._subscriptions=[this._fileForm.subscribe('submit',function(){var ca='upload_'+u++;aa.value=ca;if(z.files){for(var da=0;da<z.files.length;da++)this._addFileUploadRow(ca,z.files[da].name);}else this._addFileUploadRow(ca,z.value);}.bind(this)),this._fileForm.subscribe('success',this._onFileUploadSuccess.bind(this))];}p(v.prototype,g,{isUploading:function(){return !!Object.keys(this._uploading).length;},getAttachments:function(){return s(this._attachments);},removeAttachments:function(){this._attachments={};this._uploadTemplates={};this._uploading={};i.empty(this._parentElem);this.inform('dom-updated');},destroy:function(){this._subscriptions.forEach(function(x){x.unsubscribe();});this._fileForm.destroy();},_addFileUploadRow:function(x,y){var z=o[':fb:mercury:upload-file-row'].build(),aa=w(y),ba=x+'/'+aa;this._uploadTemplates[ba]=z;this._uploading[ba]=true;i.appendContent(z.getNode('iconText'),aa);Event.listen(z.getNode('closeFileUpload'),'click',this._removeFileUploader.bind(this,ba));i.appendContent(this._parentElem,z.getRoot());this.inform('dom-updated');},_removeFileUploader:function(x,event){delete this._attachments[x];delete this._uploading[x];var y=this._uploadTemplates[x];delete this._uploadTemplates[x];if(y){i.remove(y.getRoot());this.inform('dom-updated');}this.inform('upload-canceled');return false;},_updateFileUploader:function(x,y){var z=this._uploadTemplates[x],aa=n.getAttachIconClassByMime(y.filetype);h.addClass(z.getNode('iconText'),aa);h.addClass(z.getRoot(),'done');},_onFileUploadSuccess:function(event,x){var y=x.response.getPayload(),z=y.uploadID,aa=y.metadata;for(var ba=0;ba<aa.length;ba++){var ca=z+'/'+aa[ba].filename;if(this._uploading[ca]){delete this._uploading[ca];this._attachments[ca]=aa[ba];this._updateFileUploader(ca,aa[ba]);}}if(!this.isUploading())this.inform('all-uploads-completed');},_onFileUploadFailure:function(event,x){}});function w(x){if(x&&t(x,'C:\\fakepath\\'))return x.substring(12);return x;}e.exports=v;});
__d("ChatActivity",["event-extensions","Arbiter","AvailableList","AvailableListConstants","JSLogger","MercuryConfig","MercuryThreads","PresenceState","UserActivity","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('AvailableList'),i=b('AvailableListConstants'),j=b('JSLogger'),k=b('MercuryConfig'),l=b('MercuryThreads').get(),m=b('PresenceState'),n=b('UserActivity'),o=b('copyProperties'),p=k.activity_limit||60000,q=k.idle_limit||1800000,r=k.idle_poll_interval||300000,s=j.create('chat_activity'),t=Date.now(),u=t,v=true;function w(){var aa=Date.now();return !!(v&&(aa-t<p));}var x=o(new g(),{isActive:w});function y(){var aa=t;t=Date.now();if(t-aa>q){s.debug('idle_to_active',aa);m.doSync();}x.inform('activity');}h.subscribe(i.ON_AVAILABILITY_CHANGED,function(){if(!h.isUserIdle())u=Date.now();});Event.listen(window,'focus',function(){v=true;y();});Event.listen(window,'blur',function(){v=false;});n.subscribe(function(){y();});function z(aa){var ba=aa&&aa.at&&m.verifyNumber(aa.at);if(typeof ba!=='number')ba=null;return ba||0;}setInterval(function(){var aa=Date.now(),ba=z(m.get()),ca=Math.max(t,ba,u);if(aa-ca>q){s.debug('idle',{cookie:ba,local:t,presence:u});x.inform('idle',aa-ca);}},r);m.registerStateStorer(function(aa){var ba=z(aa);if(ba<t)aa.at=t;return aa;});g.subscribe(j.DUMP_EVENT,function(aa,ba){ba.chat_activity={activity_limit:p,idle_limit:q,idle_poll_interval:r,last_active_time:t,last_global_active_time:u};});e.exports=x;});
__d("MercuryNotificationRenderer",["MercuryAssert","MercuryMessages","MercuryParticipants","MercuryThreads","tx"],function(a,b,c,d,e,f){var g=b('MercuryAssert'),h=b('MercuryMessages'),i=b('MercuryParticipants'),j=b('MercuryThreads').get(),k=b('tx');function l(m,n){g.isThreadID(m);j.getThreadMeta(m,function(o){h.getThreadMessagesRange(m,0,1,function(p){var q=p.length&&p[p.length-1];if(q&&q.author!=i.user){i.get(q.author,function(r){if(o.name){n(k._("{senderName} messaged {groupName}",{senderName:r.short_name,groupName:o.name}));}else n(k._("{name} messaged you",{name:r.short_name}));});}else n("New message!");});});}e.exports={renderDocumentTitle:l};});
__d("MercuryTimestampTracker",["MercuryConstants","MercuryServerRequests"],function(a,b,c,d,e,f){var g=b('MercuryConstants'),h=b('MercuryServerRequests'),i=0;e.exports={getLastUserMessageTimestamp:function(){return i;}};h.subscribe('update-messages',function(j,k){if(!k.actions||!k.actions.length)return;var l=g.MercuryPayloadSource;if(k.payload_source==l.CLIENT_SEND_MESSAGE||k.payload_source==l.UNKNOWN)return;for(var m=0;m<k.actions.length;m++){var n=k.actions[m],o=n.action_type;if(o==g.MercuryActionType.USER_GENERATED_MESSAGE&&n.thread_id&&n.timestamp>i)i=n.timestamp;}});});
__d("ChatTitleBarBlinker",["ChatActivity","DocumentTitle","JSLogger","MercuryThreadInformer","MercuryNotificationRenderer","PresenceState","MercuryTimestampTracker","MercuryUnseenState"],function(a,b,c,d,e,f){var g=b('ChatActivity'),h=b('DocumentTitle'),i=b('JSLogger'),j=b('MercuryThreadInformer'),k=b('MercuryNotificationRenderer'),l=b('PresenceState'),m=b('MercuryTimestampTracker'),n=b('MercuryUnseenState'),o=i.create('chat_title'),p=null,q=0,r=false;function s(){if(p){p.stop();p=null;return true;}return false;}function t(y){var z=y||m.getLastUserMessageTimestamp();if(q<=z){q=z;if(s()||r)l.doSync();}}var u={blink:function(y,z){if(!p&&q<z)k.renderDocumentTitle(y,function(aa){if(!p)p=h.blink(aa);});},stopBlinking:function(){t();},blinkingElsewhere:function(){r=true;}};function v(y){var z=l.verifyNumber(y.sb2);if(!z||z<=q)return null;return z;}function w(y){var z=y&&v(y);if(z){q=z;o.debug('load',q);s();r=false;}}function x(y){var z=v(y);if(!z){o.debug('store',q);y.sb2=q;r=false;}return y;}l.registerStateStorer(x);l.registerStateLoader(w);j.subscribe('thread-read-changed',function(y,z){var aa=m.getLastUserMessageTimestamp(),ba=0;for(var ca in z)if(z[ca].mark_as_read&&z[ca].timestamp>=aa&&z[ca].timestamp>ba)ba=z[ca].timestamp;ba&&t(ba);});g.subscribe('activity',function(){t();});(function(){var y=l.getInitial();if(y)q=v(y)||0;})();e.exports=u;});
__d("MercuryBrowserAlerts",["ArbiterMixin","ChatActivity","ChatConfig","ChatOptions","ChatTitleBarBlinker","MercuryConstants","MercuryParticipants","Sound","copyProperties"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('ChatActivity'),i=b('ChatConfig'),j=b('ChatOptions'),k=b('ChatTitleBarBlinker'),l=b('MercuryConstants'),m=b('MercuryParticipants'),n=b('Sound'),o=b('copyProperties');n.init(['audio/ogg','audio/mpeg']);function p(r){if(j.getSetting('sound'))n.play([i.get('sound.notif_ogg_url'),i.get('sound.notif_mp3_url')],r,false);}var q={messageReceived:function(r){var s=l.MessagingTag;if(r.author==m.user||!r.is_unread||(r.folder!=s.INBOX&&r.folder!=s.ARCHIVED))return;var t=h.isActive(),u=r.thread_id,v=r.timestamp;if(t){var w=false;q.inform('before-alert',{threadID:u,cancelAlert:function(){w=true;}});!w&&p(v);}else{k.blink(u,v);p(v);}k.blinkingElsewhere();}};e.exports=o(q,g);});
__d("ActiveXSupport",[],function(a,b,c,d,e,f){var g=null,h={isSupported:function(){if(g!==null)return g;try{g=!!window.ActiveXObject&&!!new ActiveXObject("htmlfile");}catch(i){g=false;}return g;}};e.exports=h;});
__d("VideoCallRecordMessageDialog",["AsyncDialog","AsyncRequest","Dialog","MercuryConfig","URI","tx"],function(a,b,c,d,e,f){var g=b('AsyncDialog'),h=b('AsyncRequest'),i=b('Dialog'),j=b('MercuryConfig'),k=b('URI'),l=b('tx'),m={get:function(n,o){var p=j.MessagesMercuryIntegrationGK?"Would you like to leave a message?":"Would you like to leave a video message?",q=j.MessagesMercuryIntegrationGK?"New Message":"Record Message";return new i().setTitle(l._("{firstname} is Unavailable",{firstname:o})).setBody(p).setButtons([{name:'record-message',label:q},i.CANCEL]).setHandler(function(){var r=k('/ajax/messaging/composer.php').setQueryData({ids:[n],autoloadvideo:true}).toString();g.send(new h(r));});}};e.exports=m;});
__d("VideoCallCore",["event-extensions","ActiveXSupport","Arbiter","AsyncRequest","AvailableList","AvailableListConstants","Bootloader","ChannelConstants","Cookie","CSS","Dialog","MercuryConfig","UserAgent","emptyFunction","ge","ShortProfiles","VideoCallRecordMessageDialog"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ActiveXSupport'),h=b('Arbiter'),i=b('AsyncRequest'),j=b('AvailableList'),k=b('AvailableListConstants'),l=b('Bootloader'),m=b('ChannelConstants'),n=b('Cookie'),o=b('CSS'),p=b('Dialog'),q=b('MercuryConfig'),r=b('UserAgent'),s=b('emptyFunction'),t=b('ge'),u=[],v={isSupported:function(){if(r.windows()){if(r.ie()>=9&&!r.ie64()){return g.isSupported();}else return (r.ie()>=7&&!r.ie64())||r.firefox()>=3.6||r.chrome()>=5||r.opera()>=12;}else if(r.osx()>10.4)return (r.firefox()>=3.6||r.chrome()>=5||r.webkit()>=500||r.opera()>=12);return false;},isInstalled:function(){var z=false;if(this.isSupported())if(w()){var aa=null;try{aa=new ActiveXObject('SkypeLimited.SkypeWebPlugin');z=!!aa;}catch(ba){}aa=null;}else{z=x();if(q.VideoCallingNoJavaGK)if(z&&r.osx()>=10.8)if(z.description&&z.description.charAt(0)!='v')z=false;}return z;},mightReloadPostInstall:function(){return r.windows();},onVideoMessage:function(z){u.push(z);l.loadModules(['VideoCallController'],s);},setMessageHandler:function(z){this.onVideoMessage=z;if(z)while(u.length)z(u.shift());},availableForCall:function(z){var aa=j.get(z);return aa==k.ACTIVE||aa==k.IDLE;},onProfileButtonClick:function(z){v.startCallOrLeaveMessage(z,'profile_button_click');},attachListenerToProfileButton:function(z){var aa=t('videoCallProfileButton');if(aa){if(!v.isSupported()){o.hide(aa);return;}Event.listen(aa,'click',function(event){v.startCallOrLeaveMessage(z,'profile_button_click_timeline');});}},startCallOrLeaveMessage:function(z,aa){if(this.availableForCall(z)){v.showOutgoingCallDialog(z,aa);}else b('ShortProfiles').get(z,function(ba){b('VideoCallRecordMessageDialog').get(z,ba.firstName).show();});},showOutgoingCallDialog:function(z,aa){var ba=aa||'unknown';v.logClick(z,ba);var ca=v.isInstalled()?'outgoing_dialog.php':'intro.php',da='/ajax/chat/video/'+ca+'?idTarget='+z;new p().setAllowCrossPageTransition(true).setAsync(new i(da)).show();},logClick:function(z,aa){new i().setURI('/ajax/chat/video/log_click.php').setData({targetUserID:z,clickSource:aa}).setAllowCrossPageTransition(true).setErrorHandler(s).send();}};function w(){return r.ie()&&r.windows()&&!r.opera();}function x(){if(!navigator)return null;navigator.plugins.refresh(false);var z=navigator.mimeTypes['application/skypesdk-plugin'];return z&&z.enabledPlugin;}function y(){if(!v.mightReloadPostInstall())return;var z=n.get('vcpwn');if(z){n.clear('vcpwn');var aa=n.get('vctid');if(aa){n.clear('vctid');if(n.get('vctid'))return;if(aa&&v.isInstalled()){var ba='/ajax/chat/video/outgoing_dialog.php?idTarget='+aa;new p().setAllowCrossPageTransition(true).setAsync(new i(ba)).show();}}}}h.subscribe(m.getArbiterType('video'),function(z,aa){v.onVideoMessage(aa.obj);});h.subscribe(m.getArbiterType('chat_event'),function(z,aa){if(aa.obj.event_name=="missed-call")l.loadModules(['VideoCallController'],function(ba){ba.onMissedCallEvent(aa.obj);});});y();e.exports=v;});
__d("ChatApp",["CSS","JSLogger"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('JSLogger'),i=false,j=false,k=false,l=null,m={init:function(n,o,p){if(l){h.create('chat_app').error('repeated_init');return;}l=n;d(['TabsViewport','ChatTabController','ChatTabViewCoordinator','MercuryServerRequests','MercuryChannelHandler','MercuryStateCheck'],function(q,r,s,t,u,v){t.handleUpdate(p);this.tabsViewport=new q(o);this.tabController=new r(this.tabsViewport);this.tabViewCoordinator=new s(o,this.tabsViewport);i=j=true;}.bind(this));},hide:function(){if(!i||k)return;g.hide(l);k=true;},unhide:function(){if(i){if(k){g.show(l);this.tabsViewport.checkWidth();d(['Dock'],function(n){n.resizeAllFlyouts();});k=false;}}else if(!j){d(['UIPagelet'],function(n){n.loadFromEndpoint('DockChatPagelet','pagelet_chat');});j=true;}}};e.exports=m;});
__d("ChatTabModel",["function-extensions","Arbiter","ArbiterMixin","ChatBehavior","ChatConfig","JSLogger","MercuryAssert","MercuryServerRequests","MercuryThreads","MercuryTimestampTracker","PresenceInitialData","PresenceState","PresenceUtil","areObjectsEqual","copyProperties"],function(a,b,c,d,e,f){b('function-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('ChatBehavior'),j=b('ChatConfig'),k=b('JSLogger'),l=b('MercuryAssert'),m=b('MercuryServerRequests'),n=b('MercuryThreads').get(),o=b('MercuryTimestampTracker'),p=b('PresenceInitialData'),q=b('PresenceState'),r=b('PresenceUtil'),s=b('areObjectsEqual'),t=b('copyProperties'),u=[],v=null,w=null,x=null,y=null;function z(){return parseInt(p.serverTime,10);}var aa=j.get('tab_max_load_age')||3600000,ba=z()-aa,ca=0,da=20,ea=k.create('chat_tab_model'),fa=false;function ga(xa){var ya=q.verifyNumber(xa.uct2);if(!ya||typeof ya!=='number'){ea.warn('bad_cookie_version',xa.uct2);return null;}if(ya<=ca||ya<ba)return null;return ya;}function ha(xa){var ya=ga(xa);if(!ya){var za={};za.old_tabs=xa&&xa.t2&&JSON.stringify(xa.t2);za.old_promoted=xa&&xa.lm2;za.old_time=xa&&xa.uct2;za.old_reason=xa&&xa.tr;za.old_window=xa&&xa.tw;var ab;if(w&&xa.t2)for(var bb=0;bb<xa.t2.length;bb++){var cb=xa.t2[bb];if(cb.i===w)ab=cb.r;}var db=[];u.forEach(function(eb){if(!eb.fragile){var fb={i:eb.id,si:eb.server_id};if(eb.raised||(eb.id===w&&ab))fb.r=1;db.push(fb);}});xa.t2=db;xa.uct2=ca;xa.lm2=v;xa.tr=y;xa.tw=r.getSessionID();za.new_tabs=JSON.stringify(xa.t2);za.new_promoted=xa.lm2;za.new_time=xa.uct2;za.new_reason=xa.tr;za.new_window=xa.tw;ea.debug('store',za);}return xa;}function ia(xa){if(xa){var ya=ga(xa);if(ya){var za={};za.old_tabs=JSON.stringify(u);za.old_promoted=v;za.old_time=ca;za.old_reason=y;za.window_id=r.getSessionID();za.cookie_tabs=xa&&xa.t2&&JSON.stringify(xa.t2);za.cookie_promoted=xa&&xa.lm2;za.cookie_time=xa&&xa.uct2;za.cookie_reason=xa&&xa.tr;za.cookie_window=xa&&xa.tw;ca=ya;y='load';var ab=ja(xa.t2,xa.lm2||null);za.load_result=ab;za.new_tabs=JSON.stringify(u);za.new_promoted=v;za.new_time=ca;za.new_reason=y;var event='load';if(!fa)event+='_init';ea.log(event,za);return ab;}}return false;}function ja(xa,ya){if(ka(xa,ya)){var za=u.filter(function(cb){return cb.fragile;}),ab={};v=null;u=xa.map(function(cb){var db={id:cb.i,server_id:cb.si};if(db.id==ya)v=db.id;if(w==cb.i){var eb=pa(w);if(eb!=-1){db.raised=u[eb].raised;return db;}else return null;}if(cb.r)db.raised=true;ab[db.id]=db;return db;});u=u.filter(function(cb){return cb!=null;});if(x)for(var bb in x)if(!ab[bb]||!ab[bb].raised)delete x[bb];za=za.filter(function(cb){return !ab[cb.id];});u=u.concat(za);oa();return true;}return false;}function ka(xa,ya){if(ya!=v)return true;var za=u.filter(function(cb){return !cb.fragile;});if(xa.length!=za.length)return true;for(var ab=0,bb=xa.length;ab<bb;ab++){if(xa[ab].id===w)continue;if(!s(xa[ab],za[ab]))return true;}return false;}function la(xa,ya,za){var ab=ia(q.get());if(ya===undefined||ya>ca){if(xa()){ab=true;y=za||null;na(ya);}}else ea.error('rejected',{change_time:ya,state_time:ca});ab&&ma();}function ma(){if(fa)va.inform('chat/tabs-changed',va.get());}function na(xa){if(xa===undefined)xa=Math.max(o.getLastUserMessageTimestamp()||1,ca+1);ca=xa;q.doSync();}function oa(){var xa=u.length-da;if(xa>0)u=u.filter(function(ya){return ya.raised||xa--<=0;});}function pa(xa){for(var ya=0;ya<u.length;ya++)if(u[ya].id==xa)return ya;return -1;}function qa(xa){var ya=n.getThreadMetaNow(xa);if(!ya)return false;if(ya.is_canonical_user){return sa(xa);}else{var za=ra(xa);if(za)m.getServerThreadID(xa,function(ab){if(ta(xa,ab)){na();ma();}});return za;}}function ra(xa){if(pa(xa)===-1){u.push({id:xa,fragile:true});ea.log('open_fragile_tab',{tabs:JSON.stringify(u),opened:xa,window_id:r.getSessionID()});return true;}return false;}function sa(xa){var ya=pa(xa);if(ya!=-1)if(u[ya].fragile){u.splice(ya,1);}else return false;for(var za=0;za<=u.length;za++)if(za==u.length||u[za].fragile){u.splice(za,0,{id:xa});oa();ea.log('open_tab',{tabs:JSON.stringify(u),opened:xa,window_id:r.getSessionID()});return true;}}function ta(xa,ya){var za=pa(xa);if(za!=-1&&u[za].fragile){var ab=u[za];ab.fragile=false;ab.server_id=ya;var bb=[];u.forEach(function(cb){if(cb.id!=xa){if(ab&&cb.fragile){bb.push(ab);ab=null;}bb.push(cb);}});if(ab)bb.push(ab);u=bb;ea.log('make_permanent',{tabs:JSON.stringify(u),tab_id:xa,window_id:r.getSessionID()});return true;}return false;}function ua(xa){var ya=pa(xa);if(xa==v)v=null;if(ya!=-1){u.splice(ya,1);ea.log('close_tab',{tabs:JSON.stringify(u),closed:xa,window_id:r.getSessionID()});return true;}return false;}q.registerStateStorer(ha);q.registerStateLoader(function(xa){if(ia(xa))ma();});function va(){}t(va,h,{indexOf:function(xa){return pa(xa);},getTab:function(xa){l.isThreadID(xa);var ya=this.indexOf(xa);if(ya>-1){var za=u[ya];return t({},za);}return null;},closeAllTabs:function(){if(u.length){ea.log('close_all_tabs',{closed_tabs:JSON.stringify(u),window_id:r.getSessionID()});u=[];v=null;if(x)x={};na();ma();}},closeFragileTabs:function(){var xa=[];for(var ya=0;ya<u.length;ya++)if(u[ya].fragile){xa.push(u[ya]);u.splice(ya);ma();break;}ea.log('close_fragile_tabs',{tabs:JSON.stringify(u),fragile_closed:xa,window_id:r.getSessionID()});},closeTab:function(xa,ya){l.isThreadID(xa);var za=false;if(x){delete x[xa];za=true;}la(function(){if(ua(xa))za=true;return za;},undefined,ya);},closeTabAndDemote:function(xa,ya,za){l.isThreadID(xa);var ab=false;if(x){delete x[xa];ab=true;}la(function(){if(ua(xa)){if(v){var bb=pa(v);if(bb>ya){var cb=u.splice(bb,1)[0];u.splice(ya,0,cb);v=null;}}ab=true;}return ab;},undefined,za);},raiseTab:function(xa,ya){l.isThreadID(xa);var za=false;if(x&&ya){x[xa]=true;za=true;}if(!ya&&xa===w){za&&ma();return;}la(function(){if(qa(xa))za=true;var ab=pa(xa);if(ab!=-1&&!u[ab].raised){u[ab].raised=true;za=true;ea.log('raise_tab',{tabs:JSON.stringify(u),raised:xa,window_id:r.getSessionID()});}return za;});},get:function(){var xa=u.map(function(ya){var za=t({},ya);delete za.fragile;if(x)za.raised=x[za.id];return za;});return {tabs:xa,promoted:v};},openFragileTab:function(xa){l.isThreadID(xa);if(ra(xa))ma();},openTab:function(xa){l.isThreadID(xa);la(qa.curry(xa));},lowerTab:function(xa){l.isThreadID(xa);var ya=false;if(x){delete x[xa];ya=true;}la(function(){var za=pa(xa);if(za!=-1&&u[za].raised){delete u[za].raised;ea.log('lower_tab',{tabs:JSON.stringify(u),lowered:xa,window_id:r.getSessionID()});ya=true;}return ya;});},raiseAndPromoteTab:function(xa,ya,za,ab){l.isThreadID(xa);var bb=false;if(x&&ya){x[xa]=true;bb=true;}if(!ya&&xa===w){bb&&ma();return;}la(function(){if(qa(xa))bb=true;var cb=pa(xa);if(cb!=-1&&(!u[cb].raised||v!=xa)){u[cb].raised=true;v=xa;bb=true;ea.log('raise_and_promote_tab',{tabs:JSON.stringify(u),promoted:xa,window_id:r.getSessionID()});}return bb;},za,ab);},squelchTab:function(xa){l.isThreadID(xa);w=xa;this.lowerTab(xa);ea.log('squelch_tab',{squelched:xa,tabs:JSON.stringify(u),window_id:r.getSessionID()});},clearSquelchedTab:function(){if(w)ea.log('unsquelch_tab',{squelched:w,tabs:JSON.stringify(u),window_id:r.getSessionID()});w=null;},persistLocalRaised:function(){if(x){la(function(){var xa=false;u.forEach(function(ya){if(ya.raised!=x[ya.id]){xa=true;if(x[ya.id]){ya.raised=true;}else delete ya.raised;}});return xa;});ea.log('persist_local_raise',{tabs:JSON.stringify(u),window_id:r.getSessionID()});}}});g.subscribe(k.DUMP_EVENT,function(xa,ya){ya.chat_tabs={promoted:v,tabs:u.map(function(za){return t({},za);}),time:ca,max_load_age:aa};});function wa(){var xa=i.ignoresRemoteTabRaise();if(xa&&!x){ea.log('start_ignore_remote_raise');x={};ma();}else if(!xa&&x){ea.log('stop_ignore_remote_raise');x=null;ma();}}i.subscribe(i.ON_CHANGED,wa);wa();ia(q.getInitial(),true);if(ca===0)ca=z()-600000;fa=true;e.exports=va;});
__d("VideoCallPromo",["ArbiterMixin","AsyncRequest","AvailableList","AvailableListConstants","ChatConfig","ChatVisibility","ContextualDialogX","CSS","MercuryParticipants","MercuryThreads","ChatTabTemplates","VideoCallCore","copyProperties","emptyFunction"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('AsyncRequest'),i=b('AvailableList'),j=b('AvailableListConstants'),k=b('ChatConfig'),l=b('ChatVisibility'),m=b('ContextualDialogX'),n=b('CSS'),o=b('MercuryParticipants'),p=b('MercuryThreads').get(),q=b('ChatTabTemplates'),r=b('VideoCallCore'),s=b('copyProperties'),t=b('emptyFunction');function u(){this._dialog=null;}function v(x){if(!(r.isSupported()&&k.get('video.show_promo')))return false;var y=p.getCanonicalUserInThread(x);if(!y)return false;return l.isOnline()&&r.availableForCall(y);}function w(x){new h().setURI('/ajax/chat/video/log_promo.php').setData({viewedUserID:x}).setAllowCrossPageTransition(true).setErrorHandler(t).send();}s(u.prototype,g);s(u.prototype,{render:function(x,y){var z=v(y);if(!z)return;var aa=p.getCanonicalUserInThread(y);o.get('fbid:'+aa,function(ba){if(!ba.call_promo)return;var ca=q[':fb:mercury:call:promo'].build();this._dialog=new m();this._dialog.init(ca.getRoot()).setWidth(250).setAlignH('center').setContext(x).show();n.addClass(this._dialog.getRoot(),'uiContextualDialogWithFooterArrowBottom');n.addClass(x,'video_call_promo');w(p.getCanonicalUserInThread(y));this.inform('chat/dialog-rendered',{dialog:this,thread_id:y});}.bind(this));},updatePosition:function(){if(this._dialog&&this._dialog.isShown())this._dialog.updatePosition();},hide:function(){if(this._dialog&&this._dialog.isShown()){this._dialog.hide();this._dialog=null;}}});e.exports=u;});
__d("VideoCallTourDialog",["ArbiterMixin","ContextualDialogX","CSS","MercuryThreads","ChatTabTemplates","VideoCallCore","VideoCallingTour","copyProperties"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('ContextualDialogX'),i=b('CSS'),j=b('MercuryThreads').get(),k=b('ChatTabTemplates'),l=b('VideoCallCore'),m=b('VideoCallingTour'),n=b('copyProperties');function o(){this._dialog=null;}n(o.prototype,g);n(o.prototype,{render:function(p,q){var r=j.getCanonicalUserInThread(q);if(!r||!l.availableForCall(r))return;var s=k[':fb:mercury:call:tour'].build();this._dialog=new h();this._dialog.init(s.getRoot()).setWidth(250).setAlignH('center').setContext(p).show();i.addClass(this._dialog.getRoot(),'uiContextualDialogWithFooterArrowBottom');i.addClass(p,'video_call_tour');this.inform('chat/dialog-rendered',{dialog:this,thread_id:q});m.inform('videocallingtour/end');},updatePosition:function(){if(this._dialog&&this._dialog.isShown())this._dialog.updatePosition();},hide:function(){if(this._dialog&&this._dialog.isShown()){this._dialog.hide();this._dialog=null;}}});e.exports=o;});
__d("ChatContextualDialogController",["event-extensions","ArbiterMixin","ChatTabModel","VideoCallingTour","VideoCallPromo","VideoCallTourDialog","copyProperties","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ArbiterMixin'),h=b('ChatTabModel'),i=b('VideoCallingTour'),j=b('VideoCallPromo'),k=b('VideoCallTourDialog'),l=b('copyProperties'),m=b('setTimeoutAcrossTransitions'),n=60000,o=false,p=false,q=function(x,y){this._videoCallPromo=new j();this._videoCallTour=new k();this._threadID=x;this._tabMainElement=y;this._openDialog=null;this._subscriptionTokens=[];this._scrollListener=null;this._timeout=null;};function r(x,event,y){if(x._openDialog)x._openDialog.updatePosition();}function s(x){if(x._openDialog)x._openDialog.updatePosition();}function t(x){if(x._openDialog){x._openDialog.hide();x._openDialog=null;}if(x._timeout){clearTimeout(x._timeout);x._timeout=null;}while(x._subscriptionTokens.length)x._subscriptionTokens.pop().unsubscribe();if(x._scrollListener){x._scrollListener.remove();x._scrollListener=null;}}function u(x,event,y){if(y.thread_id===x._threadID){x._openDialog=y.dialog;o=true;w(x);x._timeout=m(x.destroy.bind(x,x._threadID),n);x._scrollListener=Event.listen(window,'scroll',s.curry(x));}}function v(x,y){if(!x._openDialog){x._subscriptionTokens.push(y.subscribe('chat/dialog-rendered',u.curry(x)));y.render(x._tabMainElement,x._threadID);}}function w(x){x._subscriptionTokens.push(h.subscribe('chat/tabs-changed',r.curry(x)),q.subscribe('dialog/close-all',t.curry(x)));}l(q,g);l(q.prototype,{destroy:function(){t(this);},tabFocused:function(){if(p){v(this,this._videoCallTour);return;}if(!o)v(this,this._videoCallPromo);},tabNotActive:function(){t(this);},hideVideoCallouts:function(){t(this);}});i.subscribe('videocallingtour/start',function(){p=true;q.inform('dialog/close-all');});i.subscribe('videocallingtour/end',function(){p=false;});e.exports=q;});
__d("ChatPrivacyActionController",["Arbiter","ChatVisibility","JSLogger","PresencePrivacy","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChatVisibility'),i=b('JSLogger'),j=b('PresencePrivacy'),k=b('copyProperties'),l=function(m,n){this._userID=m;this._logger=i.create('blackbird');this._getState=function(){if(h.isOnline())return j.allows(this._userID)?l.NORMAL:l.BLOCKED;return l.OFFLINE;};this._togglePrivacy=function(){var o=this._getState();switch(this._getState()){case l.OFFLINE:if(h.isOnline()){this._logger.error('tabs_already_online');break;}this._logger.log('tabs_go_online',{tab_id:this._userID});h.goOnline(function(){if(!j.allows(this._userID)){if(this._getState()!==l.BLOCKED)this._logger.error('privacy_action_controller_blocked_inconsistency');this._togglePrivacy();}}.bind(this));break;case l.BLOCKED:j.allow(this._userID);this._logger.log('tabs_unblock',{tab_id:this._userID});break;case l.NORMAL:j.disallow(this._userID);this._logger.log('tabs_block',{tab_id:this._userID});break;}};(function(){var o=function(){n&&n(this._getState());}.bind(this);o();this._subscribeToken=j.subscribe('privacy-changed',o);}.bind(this)).defer();};l.OFFLINE='offline';l.BLOCKED='blocked';l.NORMAL='normal';k(l.prototype,{togglePrivacy:function(){this._logger.log('gear_menu_toggle_privacy',{tab_id:this._userID});this._togglePrivacy();},destroy:function(){j.unsubscribe(this._subscribeToken);}});e.exports=l;});
__d("MercuryAttachmentRenderer",["JSXDOM","MercuryAttachmentAudioClipImpl","MercuryAttachmentTemplates","MercuryConstants","CSS","DOM","MercuryAttachment","MercuryMessages","MercuryParticipants","React","Style","URI","UserAgent","cx","md5","tx"],function(a,b,c,d,e,f){var g=b('MercuryAttachmentAudioClipImpl').module,h=b('MercuryAttachmentTemplates'),i=b('MercuryConstants'),j=b('CSS'),k=b('DOM'),l=b('MercuryAttachment'),m=b('MercuryMessages'),n=b('MercuryParticipants'),o=b('React'),p=b('Style'),q=b('URI'),r=b('UserAgent'),s=b('cx'),t=b('md5'),u=b('tx'),v=r.ie()<=8;function w(aa,ba){var ca=h[ba].build().setNodeContent('filename',aa.name),da=ca.getNode('link');da.setAttribute('href',aa.url);aa.rel&&da.setAttribute('rel',aa.rel);j.addClass(ca.getRoot(),l.getAttachIconClass(aa.icon_type));return ca;}function x(aa,ba){var ca=h[ba].build().setNodeContent('filename',aa.name);j.addClass(ca.getRoot(),l.getAttachIconClass(aa.icon_type));return ca;}function y(aa){var ba=i.SocialReportHoldout;if(!ba)return false;var ca=t(aa.substring(5).toString());ca=ca.substring(ba.start,ba.start+ba.length);ca=parseInt(ca,16);var da=ba.buckets;return (((ca%da)+da)%da)<ba.limit;}var z={renderError:function(aa){var ba=h[':fb:mercury:attachment:error'].build();k.appendContent(ba.getNode('error'),aa.error_msg);return ba.getRoot();},renderExternalLink:function(aa){var ba=h[':fb:mercury:attachment:external-link'].build().setNodeContent('name',aa.name);aa.base_url&&ba.setNodeContent('shortLink',aa.base_url);var ca=ba.getNode('preview'),da=ba.getNode('image-link');da.setAttribute('href',aa.url);aa.rel&&da.setAttribute('rel',aa.rel);if(aa.preview_url){var ea=ba.getNode('preview-image');ea.setAttribute('src',aa.preview_url);j.addClass(ca,aa.preview_class);j.show(ea);}else{j.addClass(ba.getRoot(),'noMedia');j.hide(ca);}ba.getNode('name').setAttribute('href',aa.url);d(['LinkshimHandler'],function(fa){fa.setUpLinkshimHandling(ba.getNode('name'));fa.setUpLinkshimHandling(ba.getNode('image-link'));});if(aa.rel)ba.getNode('name').setAttribute('rel',aa.rel);return ba.getRoot();},renderFileLink:function(aa){var ba=null;if(aa.url===''){ba=':fb:mercury:attachment:file-name';return x(aa,ba).getRoot();}else{ba=':fb:mercury:attachment:file-link';return w(aa,ba).getRoot();}},renderAudioClip:function(aa,ba,ca){if(!g)return null;var da=aa.metadata.duration/1000,ea=200;if(ba&&ca)if(da<5){ea=ba;}else ea=(1-Math.pow(10,(da-5)/-30))*(ca-ba)+ba;return g({src:aa.url,duration:aa.metadata.duration/1000,width:ea});},renderExtendedFileLink:function(aa){var ba=null;if(aa.url===''){ba=':fb:mercury:attachment:file-name';return x(aa,ba).getRoot();}var ba=':fb:mercury:attachment:extended-file-link',ca=w(aa,ba);if(aa.open_url){var da=ca.getNode('openLinkContainer');j.show(da);var ea=ca.getNode('openFile');ea.setAttribute('href',aa.open_url);}var fa=ca.getNode('downloadFile');fa.setAttribute('href',aa.url);aa.rel&&fa.setAttribute('rel',aa.rel);return ca.getRoot();},renderMusic:function(aa){var ba=h[':fb:mercury:attachment:music'].build().setNodeContent('filename',aa.name),ca=ba.getNode('link');ca.setAttribute('href',aa.url);ca.setAttribute('target','_blank');aa.rel&&ca.setAttribute('rel',aa.rel);var da=ba.getNode('image-link');da.setAttribute('href',aa.url);aa.rel&&da.setAttribute('rel',aa.rel);var ea=ba.getNode('preview-image');ea.setAttribute('src',aa.preview_url);j.show(ea);j.addClass(ba.getNode('icon_link'),'MercuryMusicIcon');return ba.getRoot();},renderPreview:function(aa,ba,ca,da,ea,fa){var ga=h[':fb:mercury:attachment:preview'].build(),ha=ga.getNode('image-link'),ia='';if(aa){ha.setAttribute('href',aa.url);aa.rel&&ha.setAttribute('rel',aa.rel);ia=aa.preview_url;if(ca&&q(ia).getPath()=='/ajax/messaging/attachment.php')ia+=ca;if(da)this.renderReportRespondLink(ga.getRoot(),aa,da.message_id);j.addClass(ha,aa.preview_class);}else j.addClass(ha,"_ksa");var ja=ga.getNode('preview-image');ba&&p.set(ja,'maxWidth',ba+'px');ba&&p.set(ja,'maxHeight',ba+'px');if(ia){ja.setAttribute('src',ia);if(!v)p.set(ha,'backgroundImage','url('+ia+')');}return ga.getRoot();},renderShareLink:function(aa){var ba=h[':fb:mercury:attachment:share-link'].build().setNodeContent('name',aa.name),ca=ba.getNode('link');ca.setAttribute('href',aa.url);aa.rel&&ca.setAttribute('rel',aa.rel);return ba.getRoot();},renderVideoThumb:function(aa){var ba=h[':fb:mercury:attachment:video-thumb'].build(),ca=ba.getNode('thumb');ca.setAttribute('href',aa.url);ca.setAttribute('rel',aa.rel);var da=k.find(ba.getRoot(),'img');da.src=aa.preview_url;return ba.getRoot();},renderShareXHP:function(aa,ba){var ca=k.create('div');if(aa){var da=aa.share_xhp;k.appendContent(ca,da);this.renderReportRespondLink(ca,aa,ba);}return ca;},renderReportRespondLink:function(aa,ba,ca){if(!ba.is_social_report_attachment)return null;switch(ba.share_data_type){case i.MercurySupportedShareType.FB_PHOTO:break;case i.MercurySupportedShareType.FB_SOCIAL_REPORT_PHOTO:return null;default:return null;}var da=null;if(ca)da=m.getMessagesFromIDs([ca])[0];if(!da)return null;if(da.author===n.user)return null;if(y(da.author))return null;var ea=null;n.get(da.author,function(fa){ea=k.create('a',{rel:'dialog-post',className:"_z6l",id:'respond-link',ajaxify:q('/ajax/report/social_resolution/photo/').setQueryData({attachment_fbid:ba.attach_id,photo_fbid:ba.shared_object_id,sender_id:n.getUserID(fa.id)}).toString()});k.setContent(ea,u._("Respond to {name}'s request",{name:fa.name}));k.appendContent(aa,ea);});}};e.exports=z;});
__d("MercuryTypingReceiver",["Arbiter","ChannelConstants","MercuryConstants","MercuryParticipants","MercuryServerRequests","MercuryThreads","TypingDetector","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChannelConstants'),i=b('MercuryConstants'),j=b('MercuryParticipants'),k=b('MercuryServerRequests'),l=b('MercuryThreads').get(),m=b('TypingDetector'),n=b('setTimeoutAcrossTransitions'),o,p={},q=30000,r=new g();function s(x){var y=p[x]||{},z=Object.keys(y);z.sort(function(aa,ba){return y[aa]-y[ba];});return z;}function t(){o=null;var x=Date.now(),y={},z=false;for(var aa in p){var ba=false;for(var ca in p[aa]||{})if(p[aa][ca]<x-q){delete p[aa][ca];ba=true;}else z=true;if(ba)y[aa]=s(aa);}for(var da in y){r.inform('state-changed',y);break;}if(z)o=n(t,3000);}function u(x,y){if(x in p)if(y in p[x]){delete p[x][y];v(x);}}function v(x){var y={};y[x]=s(x);r.inform('state-changed',y);}function w(x){if(x.thread)return k.getClientThreadIDNow(x.thread);if(x.type==='typ')return l.getThreadIdForUser(x.from);return null;}g.subscribe([h.getArbiterType('typ'),h.getArbiterType('ttyp')],function(x,y){var z=y.obj,aa=w(z);if(aa){var ba=j.getIDForUser(z.from);if(z.st==m.TYPING){p[aa]=p[aa]||{};var ca=p[aa][ba];p[aa][ba]=Date.now();if(!o)o=n(t,3000);!ca&&v(aa);}else if(z.st==m.INACTIVE)u(aa,ba);}});k.subscribe('update-typing-state',function(x,y){var z=y.payload_source;if(z!=i.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE)return;var aa=y.actions;if(!aa||!aa.length)return;var ba=i.MercuryActionType.USER_GENERATED_MESSAGE;aa.forEach(function(ca){if(ca.action_type==ba&&ca.author!=j.user)u(ca.thread_id,ca.author);});});e.exports=r;});
__d("ChatTabIndicatorController",["date-extensions","ArbiterMixin","DOM","MercuryConfig","MercuryConstants","MercuryDelayedRoger","MercuryParticipants","MercuryRoger","MercuryThreads","MercuryTypingReceiver","copyProperties","tx"],function(a,b,c,d,e,f){b('date-extensions');var g=b('ArbiterMixin'),h=b('DOM'),i=b('MercuryConfig'),j=b('MercuryConstants'),k=b('MercuryDelayedRoger'),l=b('MercuryParticipants'),m=b('MercuryRoger'),n=b('MercuryThreads').get(),o=b('MercuryTypingReceiver'),p=b('copyProperties'),q=b('tx'),r=[];function s(t){this._threadID=t;this._canonicalUser=n.getCanonicalUserInThread(t);r.push(this);}p(s.prototype,g,{destroy:function(){r.remove(this);},setLastMessage:function(t){this._lastMsg=t;this._handleStateChange();},_informStateChanged:function(t){if(t.activity=='none'&&this._currentActivity=='none')return;this._currentActivity=t.activity;this.inform('state-changed',t);},_notifySentFrom:function(){var t=j.MercurySourceType,u,v,w=this._lastMsg.location_text;if(w){u=q._("Sent from {location}",{location:w});v='sentFromMobile';}else switch(this._lastMsg.source){case t.CHAT_ORCA:case t.TITAN_ORCA:u=h.create('a',{href:'/mobile/messenger','class':'fcg',target:'_blank'},"Sent from Messenger");v='sentFromMobile';break;case t.MOBILE:case t.CHAT_IPHONE:case t.TITAN_API_MOBILE:case t.TITAN_WAP:u=h.create('a',{href:'/mobile','class':'fcg',target:'_blank'},"Sent from Mobile");v='sentFromMobile';break;case t.EMAIL:case t.TITAN_EMAIL_REPLY:u="Sent from email";v='sentFromEmail';break;default:this._informStateChanged({activity:'none'});return;}this._informStateChanged({activity:v,text:u});},_notifySeenTimestamp:function(t){var u=m.getSeenTimestamp(this._threadID,t[0])*.001,v=Date.now()*.001,w=i['24h_times']?'H:i':'g:i A';if(u<v-518400){w='M j';}else if(u<v-86400)w='D '+w;var x=Date.format(w,u);this._informStateChanged({activity:'seen-timestamp',text:q._("Seen {timestamp}",{timestamp:x})});},_notifySeenBy:function(t){var u=this._lastMsg,v=true;l.getMulti(t,function(w){v=false;if(this._lastMsg!=u)return;var x=n.getThreadMetaNow(this._threadID),y=x?x.participants.length:0,z=t.length+(u.author!=l.user),aa,ba=false;if(y>2&&z>=y-1){aa="Seen by everyone";}else if(t.length==1){aa=q._("Seen by {user}",{user:w[t[0]].short_name});}else if(t.length==2){aa=q._("Seen by {user1}, {user2}",{user1:w[t[0]].short_name,user2:w[t[1]].short_name});}else if(t.length==3){aa=q._("Seen by {user1}, {user2}, {user3}",{user1:w[t[0]].short_name,user2:w[t[1]].short_name,user3:w[t[2]].short_name});}else if(t.length>3){var ca=Object.keys(w).length-2,da=q._("{num} more",{num:ca}),ea=h.create('span',{className:'more'},da);aa=h.tx._("Seen by {user1}, {user2}, {=num more link}",{user1:w[t[0]].short_name,user2:w[t[1]].short_name,'=num more link':ea});ba=true;}this._informStateChanged({activity:'seen-by',text:aa,seenBy:t,tooltip:ba});}.bind(this));v&&this._informStateChanged({activity:'none'});},_notifyTyping:function(t){var u=this._lastMsg,v=true;l.getMulti(t,function(w){v=false;if(this._lastMsg!=u)return;if(this._canonicalUser||i.ChatMultiTypGK){var x=n.getThreadMetaNow(this._threadID),y=x?x.participants.length:0,z,aa=false;if(y>2&&t.length>=y-1){z="Everyone is typing...";}else if(t.length==1){z=q._("{name} is typing...",{name:w[t[0]].short_name});}else if(t.length==2){z=q._("{user1} and {user2} are typing...",{user1:w[t[0]].short_name,user2:w[t[1]].short_name});}else if(t.length==3){z=q._("{user1}, {user2}, and {user3} are typing...",{user1:w[t[0]].short_name,user2:w[t[1]].short_name,user3:w[t[2]].short_name});}else if(t.length>3){var ba=Object.keys(w).length-2,ca=q._("{num} more",{num:ba}),da=h.create('a',{href:'#'},ca);z=h.tx._("{user1}, {user2}, and {=num more link} are typing...",{user1:w[t[0]].short_name,user2:w[t[1]].short_name,'=num more link':da});aa=true;}this._informStateChanged({activity:'typing',text:z,typing:t,tooltip:aa});}}.bind(this));v&&this._informStateChanged({activity:'none'});},_handleStateChange:function(){var t=j.MercuryActionType.LOG_MESSAGE;if(!this._lastMsg||this._lastMsg.action_type==t){this._informStateChanged({activity:'none'});return;}if(this._typing&&this._typing.length){this._notifyTyping(this._typing);return;}if(this._canonicalUser&&this._lastMsg.author!=l.user){this._notifySentFrom();return;}var u=k.getSeenBy(this._threadID,true);if(u.length)if(this._canonicalUser){this._notifySeenTimestamp(u);return;}else{this._notifySeenBy(u);return;}this._informStateChanged({activity:'none'});}});o.subscribe('state-changed',function(t,u){r.forEach(function(v){var w=u[v._threadID];if(w!==undefined){v._typing=w;v._handleStateChange();}});});k.subscribe('state-changed',function(t,u){r.forEach(function(v){u[v._threadID]&&v._handleStateChange();});});e.exports=s;});
__d("ChatTabIndicatorLine",["ChatTabIndicatorController","CSS","DOM","DOMQuery","MercuryParticipants","Tooltip","copyProperties","csx"],function(a,b,c,d,e,f){var g=b('ChatTabIndicatorController'),h=b('CSS'),i=b('DOM'),j=b('DOMQuery'),k=b('MercuryParticipants'),l=b('Tooltip'),m=b('copyProperties'),n=b('csx');function o(p,q,r){this._typingIndicator=q;this._messagesView=r;this._controller=new g(p);this._subscription=this._controller.subscribe('state-changed',this._handleStateChanged.bind(this));}m(o.prototype,{destroy:function(){this._setClass(null);this._subscription.unsubscribe();this._controller.destroy();},setLastMessage:function(p){this._controller.setLastMessage(p);},_handleStateChanged:function(p,q){var r=this._messagesView.isScrolledToBottom();this._rerender(q);r&&this._messagesView.scrollToBottom();},_rerender:function(p){if(p.activity=='none'){this._setClass(null);return;}var q=i.find(this._typingIndicator,"._9q");if(p.text){i.setContent(q,p.text);}else i.empty(q);if(p.activity.substring(0,4)=='seen'){this._setClass('seen');if(p.activity=='seen-by'&&p.tooltip)k.getMulti(p.seenBy,function(r){var s=i.create('div'),t=0;for(var u in r)if(t++>=2){var v=i.create('div');i.setContent(v,r[u].name);i.appendContent(s,v);}var w=j.find(this._typingIndicator,'span.more');l.set(w,s,'above','center');}.bind(this));}else this._setClass(p.activity);},_setClass:function(p){if(this._lastClass===p)return;this._lastClass&&h.removeClass(this._typingIndicator,this._lastClass);p&&h.addClass(this._typingIndicator,p);this._lastClass=p;}});e.exports=o;});
__d("htmlHyperlink",["Env","htmlize","UntrustedLink","URI","URLScraper"],function(a,b,c,d,e,f){var g=b('Env'),h=b('htmlize'),i=b('UntrustedLink'),j=b('URI'),k=b('URLScraper');function l(m,n,o,p){if(typeof m==='undefined'||!m.toString)return '';if(typeof n!=='function')n=h;if(typeof o!=='function')o=h;var m=m.toString(),q=[],r;while((r=k.match(m))){var s=m.indexOf(r);if(s>=0)q.push(n(m.substring(0,s)));var t=o(r),u=r.replace(/"/g,'%22');if(!(/^[a-z][a-z0-9\-+.]+:\/\//i.test(r)))u='http://'+u;q.push('<a target="_blank" rel="nofollow" href="'+u+'"');if(p&&!j(u).isFacebookURI()){a.UntrustedLink=i;q.push(' onmousedown="UntrustedLink.bootstrap(this, \''+g.lhsh+'\', event)"');}q.push('>'+t+'</a>');m=m.substring(s+r.length);}m&&q.push(n(m));return q.join('');}e.exports=l;});
__d("MercuryMessageRenderer",["MercuryAttachmentRenderer","MercuryConstants","CSS","DOM","DOMQuery","HTML","MercuryEmoji","MercuryParticipants","Tooltip","cx","htmlHyperlink","tx"],function(a,b,c,d,e,f){var g=b('MercuryAttachmentRenderer'),h=b('MercuryConstants'),i=b('CSS'),j=b('DOM'),k=b('DOMQuery'),l=b('HTML'),m=b('MercuryEmoji'),n=b('MercuryParticipants'),o=b('Tooltip'),p=b('cx'),q=b('htmlHyperlink'),r=b('tx'),s=["January","February","March","April","May","June","July","August","September","October","November","December"],t={renderDate:function(ka){var la=new Date();la.setHours(0);la.setMinutes(0);la.setSeconds(0);la.setMilliseconds(0);var ma=24*60*60*1000,na=la.getTime()-ka.getTime();if(na<=0){return "Today";}else if(na<ma)return "Yesterday";var oa=s[ka.getMonth()],pa=ka.getDate(),qa=ka.getFullYear();if(qa!=la.getFullYear()){return r._("{month} {date}, {year}",{month:oa,date:pa,year:qa});}else return r._("{month} {date}",{month:oa,date:pa});},renderTooltipFlyout:function(ka,la){la.forEach(function(ma){var na=j.create('div');j.setContent(na,ma.name);j.appendContent(ka,na);});},renderLogMessage:function(ka,la,ma,na){w(ka,na);x(la,na);y(ma,na);},formatMessageBody:function(ka,la,ma){var na=(ka||'').replace(/\s+$/,'');if(!la)return v(na,false,ma);var oa=Object.keys(la).map(function(ra){return window.parseInt(ra);}).sort(function(ra,sa){return ra-sa;}),pa=[],qa=0;oa.forEach(function(ra){var sa=na.slice(qa,ra);if(sa)pa.push(v(sa,false,ma));qa=ra+la[ra].length;var ta=na.slice(ra,qa);if(ta)pa.push(v(ta,true,ma));});if(qa<na.length)pa.push(v(na.slice(qa),false,ma));return pa.length===0?null:pa.length===1?pa[0]:j.create('span',{},pa);}};function u(ka,la){var ma=ka.replace(/\r\n?/g,'\n').split(/\n{2,}/),na=[];for(var oa=0;oa<ma.length;oa++){var pa=ma[oa];if(pa.length){na.push('<p>');na.push(la(pa));na.push('</p>');}}return na.join('');}function v(ka,la,ma){var na=null;if(ka.length===0&&!la)return na;function oa(pa){return q(pa,m.htmlEmojiAndEmote,null,true);}na=ma?u(ka,oa):oa(ka);if(la)return j.create('span',{className:'highlight'},l(na));return l(na);}function w(ka,la){var ma='',na;switch(la.log_message_type){case h.MercuryLogMessageType.SUBSCRIBE:ma='mercurySubscribeIcon';break;case h.MercuryLogMessageType.UNSUBSCRIBE:ma='mercuryUnsubscribeIcon';break;case h.MercuryLogMessageType.THREAD_NAME:ma='mercuryThreadNameIcon';break;case h.MercuryLogMessageType.THREAD_IMAGE:ma='mercuryThreadImageIcon';break;case h.MercuryLogMessageType.VIDEO_CALL:na=la.log_message_data.answered;if(na||ja(la)){ma='mercuryVideoCallIcon';}else ma='mercuryMissedVideoCallIcon';break;case h.MercuryLogMessageType.PHONE_CALL:na=la.log_message_data.answered;if(na){ma='mercuryPhoneCallIcon';}else ma='mercuryMissedPhoneCallIcon';break;case h.MercuryLogMessageType.SERVER_ERROR:ma='mercuryErrorIcon';break;}i.addClass(ka,ma);}function x(ka,la){switch(la.log_message_type){case h.MercuryLogMessageType.SUBSCRIBE:ga(ka,la);break;case h.MercuryLogMessageType.UNSUBSCRIBE:ha(ka,la);break;case h.MercuryLogMessageType.VIDEO_CALL:if(ja(la)){z(ka,la);}else ba(ka,la);break;case h.MercuryLogMessageType.PHONE_CALL:aa(ka,la);break;case h.MercuryLogMessageType.THREAD_NAME:ca(ka,la);break;case h.MercuryLogMessageType.THREAD_IMAGE:da(ka,la);break;case h.MercuryLogMessageType.SERVER_ERROR:ia(ka,la);break;}}function y(ka,la){var ma=la.log_message_type;if(ma==h.MercuryLogMessageType.THREAD_IMAGE){var na=la.log_message_data.image;if(na){var oa=g.renderPreview(na.preview_url?na:null);j.setContent(ka,oa);i.addClass(oa,"_z6a");i.show(ka);}}}var z=function(ka,la){n.get(la.author,function(ma){var na=ma.short_name,oa;switch(la.log_message_data.event_name){case 'installing':oa=j.tx._("{firstname} is setting up video calling...",{firstname:na});break;case 'installed':oa=j.tx._("{firstname} finished setting up video calling.",{firstname:na});break;case 'install_canceled':oa=j.tx._("You canceled the video calling installation. ",{firstname:na});break;}if(oa)j.setContent(ka,oa);});},aa=function(ka,la){var ma=la.log_message_data.caller,na=la.log_message_data.callee,oa=[ma,na];n.getMulti(oa,function(pa){if(ma==n.user){var qa=pa[na].short_name,ra;if(la.log_message_data.answered){ra=j.tx._("You called {firstname}.",{firstname:qa});}else ra=j.tx._("{firstname} missed a call from you. ",{firstname:qa});}else{var sa=pa[ma].short_name;if(la.log_message_data.answered){ra=j.tx._("{firstname} called you.",{firstname:sa});}else ra=j.tx._("You missed a call from {firstname}. ",{firstname:sa});}j.setContent(ka,ra);});},ba=function(ka,la){var ma=la.log_message_data.caller,na=la.log_message_data.callee,oa=[ma,na];n.getMulti(oa,function(pa){if(ma==n.user){var qa=pa[na].short_name,ra;if(la.log_message_data.answered){ra=j.tx._("You called {firstname}.",{firstname:qa});}else ra=j.tx._("{firstname} missed a call from you. ",{firstname:qa});}else{var sa=pa[ma].short_name;if(la.log_message_data.answered){ra=j.tx._("{firstname} called you.",{firstname:sa});}else ra=j.tx._("You missed a call from {firstname}. ",{firstname:sa});}j.setContent(ka,ra);});},ca=function(ka,la){var ma=la.log_message_data.name,na=j.create('b',{},ma);if(la.author==n.user){if(ma){j.setContent(ka,j.tx._("You named the conversation: {name}.",{name:na}));}else j.setContent(ka,j.tx._("You removed the conversation name."));}else n.get(la.author,function(oa){var pa,qa=ea(oa);if(ma){pa=j.tx._("{actor} named the conversation: {name}.",{actor:qa,name:na});}else pa=j.tx._("{actor} removed the conversation name.",{actor:qa});j.setContent(ka,pa);});},da=function(ka,la){if(la.author==n.user){if(la.log_message_data.image){j.setContent(ka,j.tx._("You changed the conversation picture."));}else j.setContent(ka,j.tx._("You removed the conversation picture."));}else n.get(la.author,function(ma){var na=ea(ma),oa;if(la.log_message_data.image){oa=j.tx._("{actor} changed the conversation picture.",{actor:na});}else oa=j.tx._("{actor} removed the conversation picture.",{actor:na});j.setContent(ka,oa);});},ea=function(ka){if(ka.href)return j.create('a',{href:ka.href},ka.name);return ka.name;},fa=function(ka){var la=ka.indexOf(n.user);if(la>0)return ka.splice(la,1).concat(ka);return ka;},ga=function(ka,la){var ma=fa(la.log_message_data.added_participants),na=null,oa;if(ma.length==1){na=[la.author,ma[0]];n.getMulti(na,function(pa){if(la.author==n.user){oa=j.tx._("You added {subscriber1}.",{subscriber1:ea(pa[ma[0]])});}else if(ma[0]==n.user){oa=j.tx._("{actor} added you.",{actor:ea(pa[la.author])});}else oa=j.tx._("{actor} added {subscriber1}.",{actor:ea(pa[la.author]),subscriber1:ea(pa[ma[0]])});j.setContent(ka,oa);});}else if(ma.length==2){na=[la.author].concat(ma);n.getMulti(na,function(pa){if(la.author==n.user){oa=j.tx._("You added {subscriber1} and {subscriber2}.",{subscriber1:ea(pa[ma[0]]),subscriber2:ea(pa[ma[1]])});}else if(ma[0]==n.user){oa=j.tx._("{actor} added you and {subscriber2}.",{actor:ea(pa[la.author]),subscriber2:ea(pa[ma[1]])});}else oa=j.tx._("{actor} added {subscriber1} and {subscriber2}.",{actor:ea(pa[la.author]),subscriber1:ea(pa[ma[0]]),subscriber2:ea(pa[ma[1]])});j.setContent(ka,oa);});}else if(ma.length==3){na=[la.author].concat(ma);n.getMulti(na,function(pa){if(la.author==n.user){oa=j.tx._("You added {subscriber1}, {subscriber2} and {subscriber3}.",{subscriber1:ea(pa[ma[0]]),subscriber2:ea(pa[ma[1]]),subscriber3:ea(pa[ma[2]])});}else if(ma[0]==n.user){oa=j.tx._("{actor} added you, {subscriber2} and {subscriber3}.",{actor:ea(pa[la.author]),subscriber2:ea(pa[ma[1]]),subscriber3:ea(pa[ma[2]])});}else oa=j.tx._("{actor} added {subscriber1}, {subscriber2} and {subscriber3}.",{actor:ea(pa[la.author]),subscriber1:ea(pa[ma[0]]),subscriber2:ea(pa[ma[1]]),subscriber3:ea(pa[ma[2]])});j.setContent(ka,oa);});}else{na=[la.author].concat(ma);n.getMulti(na,function(pa){var qa=j.tx._("{num} more",{num:ma.length-2}),ra=j.create('span',{className:'more'},qa),sa=j.create('div');t.renderTooltipFlyout(sa,ma.slice(2).map(function(ua){return pa[ua];}));if(la.author==n.user){oa=j.tx._("You added {subscriber1}, {subscriber2} and {more_people}.",{subscriber1:ea(pa[ma[0]]),subscriber2:ea(pa[ma[1]]),more_people:ra});}else if(ma[0]==n.user){oa=j.tx._("{actor} added you, {subscriber2} and {more_people}.",{actor:ea(pa[la.author]),subscriber2:ea(pa[ma[1]]),more_people:ra});}else oa=j.tx._("{actor} added {subscriber1}, {subscriber2} and {more_people}.",{actor:ea(pa[la.author]),subscriber1:ea(pa[ma[0]]),subscriber2:ea(pa[ma[1]]),more_people:ra});j.setContent(ka,oa);var ta=k.find(ka,'span.more');o.set(ta,sa,'above','center');});}},ha=function(ka,la){n.get(la.author,function(ma){var na;if(la.author==n.user){na=j.tx._("You left the conversation.");}else na=j.tx._("{actor} left the conversation.",{actor:ea(ma)});j.setContent(ka,na);});},ia=function(ka,la){var ma="We were unable to fetch previous messages in this conversation.";j.setContent(ka,ma);},ja=function(ka){return ka.log_message_data.event_name==='installing'||ka.log_message_data.event_name==='install_canceled';};e.exports=t;});
__d("ChatTabMessagesView",["date-extensions","event-extensions","Arbiter","ArbiterMixin","MercuryAttachment","MercuryAttachmentRenderer","ChannelConstants","ChatConfig","ChatTabIndicatorLine","ChatVisibility","MercuryConfig","MercuryConstants","CSS","DOM","Env","MercuryMessages","MercuryThreadMetadataRawRenderer","MercuryThreadMetadataRenderer","MercuryThreads","MercuryMessageRenderer","MercuryParticipants","ChatTabTemplates","MercuryThreadInformer","Tooltip","VideoCallCore","copyProperties","isRTL","throttle","tx"],function(a,b,c,d,e,f){b('date-extensions');b('event-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('MercuryAttachment'),j=b('MercuryAttachmentRenderer'),k=b('ChannelConstants'),l=b('ChatConfig'),m=b('ChatTabIndicatorLine'),n=b('ChatVisibility'),o=b('MercuryConfig'),p=b('MercuryConstants'),q=b('CSS'),r=b('DOM'),s=b('Env'),t=b('MercuryMessages'),u=b('MercuryThreadMetadataRawRenderer'),v=b('MercuryThreadMetadataRenderer'),w=b('MercuryThreads').get(),x=b('MercuryMessageRenderer'),y=b('MercuryParticipants'),z=b('ChatTabTemplates'),aa=b('MercuryThreadInformer'),ba=b('Tooltip'),ca=b('VideoCallCore'),da=b('copyProperties'),ea=b('isRTL'),fa=b('throttle'),ga=b('tx');function ha(qa){return Date.format(l.get('24h_times')?'H:i':'g:ia',qa/1000);}function ia(qa){var ra=z[':fb:chat:conversation:message-group'].build();ra.setNodeContent('timestamp',ha(qa.timestamp));y.get(qa.author,function(sa){var ta=ra.getNode('profileLink');ta.href=sa.href;var ua=sa.fbid==s.user?"You":sa.name;ba.set(ta,ua,'left');ra.setNodeProperty('profilePhoto','src',sa.image_src);});return ra;}function ja(qa){var ra=z[':fb:chat:conversation:message:event'].build();ra.setNodeContent('timestamp',ha(qa.timestamp));x.renderLogMessage(ra.getNode('icon'),ra.getNode('message'),ra.getNode('attachment'),qa);var sa=ka(qa);if(sa)r.appendContent(ra.getNode('message'),sa);return ra.getRoot();}function ka(qa){var ra,sa;if(qa.log_message_type==p.MercuryLogMessageType.VIDEO_CALL)if(qa.log_message_data.event_name=='install_canceled'){ra=r.tx._("Retry setup and call back.");sa='callback_cancelinstall_link';return la(ra,qa.thread_id,qa.log_message_data.to,sa);}else if(!qa.log_message_data.event_name&&qa.log_message_data.callee==y.user&&!qa.log_message_data.answered){ra=r.tx._("Call Back");sa='callback_link';return la(ra,qa.thread_id,qa.log_message_data.caller.split(':')[1],sa);}return null;}function la(qa,ra,sa,ta){if(ca.isSupported()){var ua=!n.isOnline()||!ca.availableForCall(sa),va=r.create('a',{href:'#',className:'callBackLink'},qa);if(ua)q.hide(va);va.setAttribute('data-gt',JSON.stringify({videochat:'clicked_callback_link'}));Event.listen(va,'click',function(){oa.inform('video-call-clicked',{userID:sa,threadID:ra,clickSource:ta});});return va;}return null;}function ma(qa){var ra=z[':fb:mercury:chat:message:forward'].build(),sa=ra.getNode('forwardText');if(sa){q.hide(ra.getRoot());v.renderTitanLink(qa.thread_id,ra.getNode('forwardLink'),q.show.bind(q,ra.getRoot()));if(qa.forward_count>1){r.appendContent(sa,ga._("{count} forwarded messages",{count:qa.forward_count}));}else r.appendContent(sa,"1 forwarded message");}return ra.getRoot();}var na=[];function oa(qa,ra,sa,ta,ua,va){this.loadingIcon=ua;this.threadID=qa;this.sheetController=ra;this.scrollContainer=sa;this.conversationElem=ta;this.messageElements={};this.messageGroup=null;this.prevMessage=null;this._fetchMultiplier=1;this._oldestMessageDisplayedTimestamp=null;this._loadingMoreMessages=false;this._currentMessageCount=0;this._hasReachedClearedMessages=false;var wa=p.MercuryThreadlistConstants.MESSAGE_TIMESTAMP_THRESHOLD;this._oldestMessageDisplayedTimestamp=Date.now()-wa;na.push(this);this._subscription=g.subscribe('overflow-applied-to-body',this.scrollToBottom.bind(this));Event.listen(this.scrollContainer,'scroll',fa(this.scrolling,50,this));if(va)this.indicatorLine=new m(this.threadID,va,this);var xa=o.InfiniteScrollChatTabGK?this._updateTimestamp.bind(this):function(){};t.getThreadMessagesRange(this.threadID,0,p.MercuryThreadlistConstants.RECENT_MESSAGES_LIMIT,xa);this.rerender();}da(oa,h);da(oa.prototype,{scrolling:function(){if(o.InfiniteScrollChatTabGK&&!this._loadingMoreMessages&&this.isScrolledNearTop()&&!this.isScrolledToBottom()&&!this._hasReachedClearedMessages)this.loadMoreMessages();if(!this._newMessagesSheetOpened)return;if(this.isScrolledToBottom()){this.sheetController.closeNewMessagesSheet();this._newMessagesSheetOpened=false;}},destroy:function(){r.empty(this.conversationElem);this._subscription.unsubscribe();na.remove(this);this.indicatorLine&&this.indicatorLine.destroy();this.destroyed=true;},_appendMessage:function(qa){if(qa==this.prevMessage)return;var ra=p.MercuryThreadlistConstants,sa=ra.GROUPING_THRESHOLD,ta=qa.action_type==p.MercuryActionType.LOG_MESSAGE&&qa.log_message_type==p.MercuryLogMessageType.SERVER_ERROR;if(qa.is_cleared){this._hasReachedClearedMessages=true;return;}var ua=null;if(this.prevMessage)ua=new Date(this.prevMessage.timestamp);var va=new Date(qa.timestamp);if(!ta&&(!ua||ua.getDate()!=va.getDate()||ua.getMonth()!=va.getMonth()||ua.getFullYear()!=va.getFullYear())){var wa=z[':fb:chat:conversation:date-break'].build();r.setContent(wa.getRoot(),x.renderDate(va));r.appendContent(this.conversationElem,wa.getRoot());this.messageGroup=null;}if(qa.action_type==p.MercuryActionType.LOG_MESSAGE){r.appendContent(this.conversationElem,ja(qa));this.messageGroup=null;this.prevMessage=qa;return;}if(!this.messageGroup||this.prevMessage.author!=qa.author||this.prevMessage.timestamp<qa.timestamp-sa){this.messageGroup=ia(qa);r.appendContent(this.conversationElem,this.messageGroup.getRoot());}var xa=this._renderSingleMessage(qa);this.messageElements[qa.message_id]=xa;r.appendContent(this.messageGroup.getNode('messages'),xa);this.prevMessage=qa;},rerender:function(){if(!this._oldestMessageDisplayedTimestamp)return;var qa=this._finishedFetchingMoreMessages&&this.scrollContainer.scrollHeight,ra=this._finishedFetchingMoreMessages&&this.scrollContainer.scrollTop,sa=this.isScrolledToBottom();r.empty(this.conversationElem);this.messageElements={};this.messageGroup=null;this.prevMessage=null;var ta=t.getThreadMessagesSinceTimestamp(this.threadID,this._oldestMessageDisplayedTimestamp);this._renderOlderMessages(ta,qa,ra,sa);this._finishedFetchingMoreMessages=false;},update:function(qa){for(var ra in qa){var sa=this.messageElements[ra];if(sa){var ta=this.isScrolledToBottom(),ua=this._renderSingleMessage(t.getMessagesFromIDs([ra])[0]);this.messageElements[ra]=ua;r.replace(sa,ua);if(ta)this.scrollToBottom();}}},_getLoadingHeight:function(){return this.loadingHeight||this.loadingIcon.clientHeight;},_appendMessages:function(qa){qa.forEach(this._appendMessage.bind(this));this.indicatorLine&&this.indicatorLine.setLastMessage(this.prevMessage);this.sheetController.displayMessengerPromoTabSheet(this.prevMessage);},_appendNewMessages:function(qa){var ra=this.isScrolledToBottom(),sa=this._messagesOnlySentFromSelf(qa);this._appendMessages(qa);if(ra){this.scrollToBottom();}else if(!sa){this.sheetController.openNewMessagesSheet();this._newMessagesSheetOpened=true;}},_messagesOnlySentFromSelf:function(qa){for(var ra=0;ra<qa.length;ra++)if(qa[ra].author!==y.user)return false;return true;},_renderOlderMessages:function(qa,ra,sa,ta){if(!qa)return;this._appendMessages(qa);if(ta){this.scrollToBottom();}else if(this._finishedFetchingMoreMessages)this.scrollToPosition(this.scrollContainer.scrollHeight-ra-this.loadingHeight+sa);},_updateTimestamp:function(qa){if(qa&&qa.length){this._oldestMessageDisplayedTimestamp=qa[0].timestamp;this._currentMessageCount=qa.length;}this._loadingMoreMessages=false;this._finishedFetchingMoreMessages=true;q.hide(this.loadingIcon);},isScrolledToBottom:function(){var qa=this.scrollContainer;return qa.scrollTop+qa.clientHeight>=qa.scrollHeight-1;},isScrolledNearTop:function(){return this.scrollContainer.scrollTop<this.scrollContainer.clientHeight;},scrollToBottom:function(){this.scrollToPosition(this.scrollContainer.scrollHeight);},scrollToPosition:function(qa){this.scrollContainer.scrollTop=qa;},loadMoreMessages:function(){if(t.hasLoadedExactlyNMessages(this.threadID,this._currentMessageCount)&&t.hasLoadedAllMessages(this.threadID))return;q.show(this.loadingIcon);this.loadingHeight=this._getLoadingHeight();this._loadingMoreMessages=true;if(this._fetchMultiplier<10)this._fetchMultiplier+=1;var qa=p.MercuryThreadlistConstants.RECENT_MESSAGES_LIMIT*this._fetchMultiplier,ra=this._currentMessageCount+qa,sa=t.hasLoadedNMessages(this.threadID,ra);t.getThreadMessagesRange(this.threadID,0,ra,this._updateTimestamp.bind(this),null,p.MercuryAPIArgsSource.CHAT);if(sa)this.rerender();},_renderSingleMessage:function(qa){var ra=z[':fb:chat:conversation:message'].render();if(qa.subject){var sa=z[':fb:chat:conversation:message:subject'].render();r.setContent(sa,qa.subject);r.appendContent(ra,sa);}if(qa.body.substr(0,4)=='?OTR'){r.setContent(ra,"[encrypted message]");q.addClass(ra,'cyphertext');}else{q.addClass(ra,ea(qa.body)?'direction_rtl':'direction_ltr');r.appendContent(ra,x.formatMessageBody(qa.body));}if(qa.has_attachment)this._appendMessageAttachments(ra,qa);if(qa.forward_count)r.appendContent(ra,ma(qa));if(qa.is_spoof_warning){var ta=z[':fb:chat:conversation:message:undertext'].build();r.appendContent(ta.getNode('message'),ra);y.get(qa.author,function(wa){v.renderChatSpoofWarning(ta.getNode('status'),qa.is_spoof_warning,wa);});return ta.getRoot();}var ua=u.renderStatusIndicator(qa.status,qa.error_data,t.resendMessage.shield(t,qa));if(ua){q.addClass(ra,'errorStatus');var va=z[':fb:chat:conversation:message:status'].build();r.appendContent(va.getNode('message'),ra);r.appendContent(va.getNode('status'),ua);return va.getRoot();}return ra;},_appendMessageAttachments:function(qa,ra){var sa=p.MercuryAttachmentType,ta=ra.attachments;if(ra.raw_attachments&&ra.raw_attachments.length>0)ta=i.convertRaw(ra.raw_attachments);for(var ua=0,va=ta.length;ua<va;++ua){var wa=ta[ua],xa=wa.attach_type,ya=wa.share_data_type;if(xa==sa.ERROR)r.appendContent(qa,j.renderError(wa));if(xa==sa.FILE)r.appendContent(qa,j.renderFileLink(wa));var za=null,ab,bb=p.MercurySupportedShareType.FB_SOCIAL_REPORT_PHOTO;if(xa==sa.SHARE&&ya==p.MercurySupportedShareType.FB_VIDEO){za=j.renderVideoThumb(wa);ab=r.find(za,'img');Event.listen(ab,'load',this._thumbLoaded.shield(this,ab));}else if(xa==sa.SHARE&&(ya==p.MercurySupportedShareType.FB_MUSIC_ALBUM||ya==p.MercurySupportedShareType.FB_SONG)){za=j.renderMusic(wa);ab=r.find(za,'img');Event.listen(ab,'load',this._thumbLoaded.shield(this,ab));}else if(xa==sa.SHARE&&(ya==p.MercurySupportedShareType.EXTERNAL||ya==p.MercurySupportedShareType.FB_TEMPLATE||ya==p.MercurySupportedShareType.FB_COUPON)){za=j.renderExternalLink(wa);ab=r.find(za,'img');Event.listen(ab,'load',this._thumbLoaded.shield(this,ab));}else if(ya==bb){za=j.renderExternalLink(wa);ab=r.find(za,'img');Event.listen(ab,'load',this._thumbLoaded.shield(this,ab));}else if(wa.preview_url){y.get(ra.author,function(cb){var db=y.getUserID(cb.id);za=j.renderPreview(wa,0,null,ra,cb,db);ab=r.find(za,'img');Event.listen(ab,'load',this._thumbLoaded.shield(this,ab));}.bind(this));}else if(xa==sa.SHARE)za=j.renderShareLink(wa);if(za)r.appendContent(qa,za);}},_thumbLoaded:function(qa){var ra=this.scrollContainer.scrollTop+this.scrollContainer.clientHeight;if(ra+qa.offsetHeight>=this.scrollContainer.scrollHeight)this.scrollToBottom();}});aa.subscribe('messages-reordered',function(qa,ra){na.forEach(function(sa){ra[sa.threadID]&&sa.rerender();});});aa.subscribe('messages-updated',function(qa,ra){na.forEach(function(sa){ra[sa.threadID]&&sa.update(ra[sa.threadID]);});});aa.subscribe('messages-received',function(qa,ra){na.forEach(function(sa){var ta=ra[sa.threadID];if(o.InfiniteScrollChatTabGK&&ta&&ta.length)sa._currentMessageCount+=ta.length;ta&&sa._appendNewMessages(ta);});});g.subscribe(k.getArbiterType('chat_event'),function(qa,ra){if(pa(ra.obj)){var sa=(s.user==ra.obj.from)?ra.obj.to:ra.obj.from,ta=w.getThreadIdForUser(sa),ua=na.filter(function(xa){return xa.threadID===ta;});if(ua.length>0){var va=ua[0],wa=t.constructLogMessageObject(p.MercurySourceType.CHAT_WEB,ta,p.MercuryLogMessageType.VIDEO_CALL,ra.obj);wa.author='fbid:'+ra.obj.from;va._appendNewMessages([wa]);}}});function pa(qa){return (qa.event_name==='installing'||qa.event_name==='install_canceled');}e.exports=oa;});
__d("MercuryTypeahead",["event-extensions","ArbiterMixin","DOM","Input","MercuryTypeaheadTemplates","Tokenizer","Typeahead","TypeaheadCore","copyProperties","cx"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ArbiterMixin'),h=b('DOM'),i=b('Input'),j=b('MercuryTypeaheadTemplates'),k=b('Tokenizer'),l=b('Typeahead'),m=b('TypeaheadCore'),n=b('copyProperties'),o=b('cx'),p=function(q,r){this._domElement=null;this._typeahead=null;this._tokenizer=null;this._placeholder='';this._exclusions=[];this._viewNodeOrID=null;this._viewOptions={renderer:'compact',autoSelect:true};this._tokenizerBehaviors=[];this._dataSource=q;this._view=r;};n(p.prototype,g);n(p.prototype,{setPlaceholder:function(q){this._placeholder=q;return this;},setExcludedParticipants:function(q){this._exclusions=[];q.forEach(function(r){var s=r.indexOf(':');if(r.substr(0,s)=='fbid')this._exclusions.push(r.substr(s+1));}.bind(this));return this;},setViewNodeID:function(q){this._viewNodeOrID=q;},setViewNode:function(q){this._viewNodeOrID=q;},setFullWidthView:function(q){var r=h.create('div',{className:"_4ck uiTypeaheadView"});h.setContent(q,r);this.setViewNode(r);},setViewOption:function(q,r){this._viewOptions[q]=r;},addTokenizerBehavior:function(q){this._tokenizerBehaviors.push(q);},build:function(q){if(this._domElement)return;var r=j[':fb:mercury:tokenizer'].build(),s=j[':fb:mercury:typeahead'].build();this._domElement=r.getRoot();h.appendContent(this._domElement,s.getRoot());var t=s.getNode('textfield');i.setPlaceholder(t,this._placeholder);t.setAttribute('data-placeholder',this._placeholder);var u={node_id:this._viewNodeOrID,ctor:this._view,options:this._viewOptions},v={ctor:m,options:{setValueOnSelect:true}};this._typeahead=new l(this._dataSource,u,v,s.getRoot());this._typeahead.init();var w={inline:true,behaviors:this._tokenizerBehaviors};this._tokenizer=new k(this._domElement,this._typeahead);this._tokenizer.init(r.getNode('tokenarea'),'participants',[],w);this._tokenizer.subscribe(['addToken','removeToken','removeAllTokens'],function(){this.inform('tokens-changed');}.bind(this));Event.listen(t,'focus',function(){this._resetDataSource();this._typeahead.init();}.bind(this));Event.listen(this._domElement,'click',this.focus.bind(this));},getElement:function(){return this._domElement;},getSelectedParticipantIDs:function(){var q=[];if(this._tokenizer)(this._tokenizer.getTokenValues()||[]).forEach(function(r){q.push('fbid:'+r);});return q;},getTokens:function(){var q=[];if(this._tokenizer)q=this._tokenizer.getTokens();return q;},getTokenizer:function(){return this._tokenizer;},reset:function(){this._tokenizer&&this._tokenizer.removeAllTokens();this._typeahead&&this._typeahead.getCore().reset();},focus:function(){this._tokenizer&&this._tokenizer.focusInput();},getTypeahead:function(){return this._typeahead;},_resetDataSource:function(){this._dataSource.setExclusions(this._exclusions);}});e.exports=p;});
__d("ChatAddFriendsTabSheetRawRenderer",["event-extensions","ContextualTypeaheadView","DOM","MercuryTypeahead","ChatTabTemplates","tx","MercuryDataSourceWrapper"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ContextualTypeaheadView'),h=b('DOM'),i=b('MercuryTypeahead'),j=b('ChatTabTemplates'),k=b('tx'),l=b('MercuryDataSourceWrapper').source,m={render:function(n,o,p,q,r){var s=j[':fb:mercury:chat:tab-sheet:add-friends'].build(),t=new i(l,g);t.setExcludedParticipants(q.participants);t.setPlaceholder("Enter a friend's name");t.build();h.replace(s.getNode('participantsTypeahead'),t.getElement());h.setContent(p,s.getRoot());t.focus();var u=function(){var v=t.getSelectedParticipantIDs();if(v.length)r(v);o.close(n);};Event.listen(s.getNode('doneButton'),'click',u);}};e.exports=m;});
__d("MercurySheetPolicy",[],function(a,b,c,d,e,f){var g={canReplaceOpenSheet:function(h,i){if(h.getType()==i.getType())return false;if(h.isPermanent()&&!i.isPermanent())return false;return true;}};e.exports=g;});
__d("MercurySheetView",["event-extensions","Animation","MercurySheetPolicy","CSS","DOM","Style","MercurySheetTemplates","Vector","copyProperties","cx"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Animation'),h=b('MercurySheetPolicy'),i=b('CSS'),j=b('DOM'),k=b('Style'),l=b('MercurySheetTemplates'),m=b('Vector'),n=b('copyProperties'),o=b('cx'),p=5000,q=function(r,s,t){this._threadID=r;this._rootElement=s;this._tabMainElement=t;this._openSheet=null;};n(q.prototype,{destroy:function(){j.empty(this._rootElement);},_openCommon:function(r,s){if(this._openSheet&&!h.canReplaceOpenSheet(this._openSheet,r))return;this.clear(function(){this._openSheet=r;var t=l[':fb:mercury:tab-sheet:loading'].build().getRoot();j.setContent(this._rootElement,t);i.show(t);i.show(this._rootElement);r.render();if(s){i.addClass(this._tabMainElement,'sheetSlide');i.addClass(this._tabMainElement,"_1sk4");var u=m.getElementDimensions(this._rootElement).y;k.set(this._rootElement,'bottom',u+'px');this._animation=new g(this._rootElement).to('bottom',0).duration(150).ease(g.ease.both).ondone(function(){i.removeClass(this._tabMainElement,'sheetSlide');i.removeClass(this._tabMainElement,"_1sk4");}.bind(this)).go();}if(!r.isPermanent()){var v=p;if(r.getCloseTimeout)v=r.getCloseTimeout();this._sheetCloseHandler=this.close.bind(this,r).defer(v,false);if(r.timeoutCanBeReset)r.setResetTimeoutCallback(this.resetTimeout.bind(this));}}.bind(this));},resetTimeout:function(r,s){clearTimeout(this._sheetCloseHandler);this._sheetCloseHandler=this.close.bind(this,r).defer(s,false);},set:function(r){return this._openCommon(r,false);},open:function(r){return this._openCommon(r,true);},close:function(r,s){if(this._openSheet!=r)return;if(!this._openSheet){s&&s();return;}if(this._animation)this._animation.stop();if(this._sheetCloseHandler){clearTimeout(this._sheetCloseHandler);this._sheetCloseHandler=null;}i.addClass(this._tabMainElement,'sheetSlide');i.addClass(this._tabMainElement,"_1sk4");var t=m.getElementDimensions(this._rootElement).y;this._animation=new g(this._rootElement).to('bottom',t+'px').duration(100).ease(g.ease.begin).ondone(function(){j.empty(this._rootElement);i.hide(this._rootElement);i.removeClass(this._tabMainElement,'sheetSlide');i.removeClass(this._tabMainElement,"_1sk4");this._openSheet=null;s&&s();}.bind(this)).go();},clear:function(r){this.close(this._openSheet,r);}});e.exports=q;});
__d("MultiChatController",["Arbiter","AsyncSignal","copyProperties","Form","MercuryMessages","MercuryServerRequests","MercuryThreads"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncSignal'),i=b('copyProperties'),j=b('Form'),k=b('MercuryMessages'),l=b('MercuryServerRequests'),m=b('MercuryThreads').get();function n(){}i(n,{subscribe:function(o,p){o.subscribe('confirm',function(){this.createGroupThreadFromChooserDialog(o,p);}.bind(this));},createGroupThreadFromChooserDialog:function(o,p){var q=j.serialize(o.getRoot()),r=JSON.parse(q.profileChooserItems),s=[];for(var t in r)if(r[t])s.push(t);var u=n.createThreadForFBIDs(s);l.subscribe('update-thread-ids',function(v,w){for(var x in w)if(w[x]==u)new h('/ajax/groups/chat/log',{group_id:p,message_id:x}).send();});o.hide();},createThreadForTokens:function(o){if(!o.length)return;var p;if(o.length==1){p='user:'+o[0].split(':')[1];}else p='root:'+k.generateNewClientMessageID(Date.now());m.createNewLocalThread(p,o);g.inform('chat/open-tab',{thread_id:p});return p;},createThreadForFBIDs:function(o){var p=[];for(var q=0;q<o.length;q++)p.push("fbid:"+o[q]);return n.createThreadForTokens(p);}});e.exports=n;});
__d("ChatAddFriendsTabSheet",["ChatAddFriendsTabSheetRawRenderer","MercurySheetView","MercuryConstants","MercuryMessages","MultiChatController","MercuryThreads","copyProperties","cx"],function(a,b,c,d,e,f){var g=b('ChatAddFriendsTabSheetRawRenderer'),h=b('MercurySheetView'),i=b('MercuryConstants'),j=b('MercuryMessages'),k=b('MultiChatController'),l=b('MercuryThreads').get(),m=b('copyProperties'),n=b('cx');function o(r,s,t){this._threadID=r;this._rootElement=s;this._sheetView=t;}m(o.prototype,{render:function(){l.getThreadMeta(this._threadID,function(r){var s=r.is_canonical_user?p:q;g.render(this,this._sheetView,this._rootElement,r,s.curry(r));}.bind(this));},isPermanent:function(){return true;},getType:function(){return 'add_friends_type';},open:function(){this._sheetView.open(this);}});function p(r,s){var t=r.participants;k.createThreadForTokens(t.concat(s));}function q(r,s){var t=r.thread_id;if(l.isEmptyLocalThread(t)){l.addParticipantsToThreadLocally(t,s);}else j.sendMessage(j.constructLogMessageObject(i.MercurySourceType.CHAT_WEB,t,i.MercuryLogMessageType.SUBSCRIBE,{added_participants:s}));}e.exports=o;});
__d("ChatAvailabilityTabSheetRawRenderer",["AvailableListConstants","CSS","cx","DOM","GenderConst","MercuryConfig","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('AvailableListConstants'),h=b('CSS'),i=b('cx'),j=b('DOM'),k=b('GenderConst'),l=b('MercuryConfig'),m=b('ChatTabTemplates'),n={render:function(r,s,t){var u=m[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build(),v=null;switch(r){case g.ACTIVE:h.addClass(u.getRoot(),"_1sk2");v=o(t);break;case g.MOBILE:h.addClass(u.getRoot(),"_1sk3");v=p(t);break;case g.OFFLINE:v=q(t);break;}j.setContent(u.getNode('text'),v);j.setContent(s,u.getRoot());}};function o(r){return j.tx._("{name} is now available.",{name:r.firstName});}function p(r){return j.tx._("Your messages will be sent to {name}'s phone.",{name:r.firstName});}function q(r){switch(r.gender){case k.FEMALE_SINGULAR:case k.FEMALE_SINGULAR_GUESS:if(l.ChatControlLanguageChangeGK){return j.tx._("{name} isn't on chat, but you can still send her a message.",{name:r.firstName});}else return j.tx._("{name} is offline, but you can still send her a message.",{name:r.firstName});case k.MALE_SINGULAR:case k.MALE_SINGULAR_GUESS:if(l.ChatControlLanguageChangeGK){return j.tx._("{name} isn't on chat, but you can still send him a message.",{name:r.firstName});}else return j.tx._("{name} is offline, but you can still send him a message.",{name:r.firstName});default:if(l.ChatControlLanguageChangeGK){return j.tx._("{name} isn't on chat, but you can still send them a message.",{name:r.firstName});}else return j.tx._("{name} is offline, but you can still send them a message.",{name:r.firstName});}}e.exports=n;});
__d("ChatAvailabilityTabSheet",["Arbiter","AvailableList","AvailableListConstants","ChatAvailabilityTabSheetRawRenderer","ChatConfig","MercuryThreads","ShortProfiles","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableList'),i=b('AvailableListConstants'),j=b('ChatAvailabilityTabSheetRawRenderer'),k=b('ChatConfig'),l=b('MercuryThreads').get(),m=b('ShortProfiles'),n=b('copyProperties');function o(p,q,r,s){this._handledAvailability=q;this._sheetView=s;this._rootElement=r;this._canonicalUser=l.getCanonicalUserInThread(p);if(this._canonicalUser){this._currentAvailability=i.ACTIVE;this._handleAvailabilityChange();g.subscribe(i.ON_AVAILABILITY_CHANGED,this._handleAvailabilityChange.bind(this));}}o.createSheets=function(p,q,r){var s={};if(k.get('roger.ui')){s[i.OFFLINE]=new o(p,i.OFFLINE,q,r);return s;}[i.ACTIVE,i.OFFLINE,i.MOBILE].forEach(function(t){s[t]=new o(p,t,q,r);});return s;};n(o.prototype,{render:function(){!this._canonicalUser;m.get(this._canonicalUser,j.render.curry(this._currentAvailability,this._rootElement));},isPermanent:function(){return false;},getType:function(){switch(this._handledAvailability){case i.ACTIVE:return 'availability_active_type';case i.MOBILE:return 'availability_mobile_type';case i.OFFLINE:return 'availability_offline_type';default:throw new Error("Invalid handled availability");}},getCloseTimeout:function(){return 5000;},_handleAvailabilityChange:function(){var p=h.get(this._canonicalUser);if(p==this._currentAvailability)return;this._currentAvailability=p;if(p==this._handledAvailability)this._sheetView.open(this);}});e.exports=o;});
__d("ChatMessengerUpsellConfig",["AsyncRequest","KeyedCallbackManager"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('KeyedCallbackManager'),i=new h(),j={get:function(k,l){var m=i.executeOrEnqueue(k,l),n=i.getUnavailableResources(m);if(n.length)new g().setURI('/ajax/chat/messenger_upsell/config.php').setHandler(this._setPromoConfig.bind(this)).send();},_setPromoConfig:function(k){var l=k.payload;if(l){i.setResource('impression_count',l.number_of_impressions);i.setResource('max_impressions',l.max_impressions);i.setResource('promo_timeout',l.promo_timeout);i.setResource('post_click_timeout',l.post_click_timeout);i.setResource('should_show_orca_promotion',true);}else i.setResource('should_show_orca_promotion',false);},getNow:function(k){return i.getResource(k);},setImpressionCount:function(k,l){new g().setURI('/ajax/chat/messenger_upsell/update_impressions.php').setData({impressions:l,friend_id:k}).send();i.setResource('impression_count',l);if(l>=i.getResource('max_impressions'))i.setResource('should_show_orca_promotion',false);}};e.exports=j;});
__d("ChatMessengerPromoTabSheet",["event-extensions","AsyncRequest","ChatConfig","MercuryConstants","DOM","MercuryParticipants","MercuryThreads","ChatTabTemplates","ChatMessengerUpsellConfig","URI","copyProperties","tx"],function(a,b,c,d,e,f){b('event-extensions');var g=b('AsyncRequest'),h=b('ChatConfig'),i=b('MercuryConstants'),j=b('DOM'),k=b('MercuryParticipants'),l=b('MercuryThreads').get(),m=b('ChatTabTemplates'),n=b('ChatMessengerUpsellConfig'),o=b('URI'),p=b('copyProperties'),q=b('tx');function r(s,t,u){this._threadID=s;this._rootElement=t;this._sheetView=u;this._sheetHasBeenDisplayed=false;this._canonicalUser=l.getCanonicalUserInThread(s);this._timeoutResetCallback=null;this._template;}p(r.prototype,{render:function(){this._template=m[':fb:mercury:chat:tab-sheet:promo-sheet'].build();var s=k.getIDForUser(this._canonicalUser);k.get(s,function(t){j.setContent(this._template.getNode('text'),q._("{name} is using Messenger. Get the app to chat on the go.",{name:t.short_name}));}.bind(this));this._button=this._template.getNode('installButton');Event.listen(this._template.getNode('installButton'),'click',this.installButtonClickHandler.bind(this));j.setContent(this._rootElement,this._template.getRoot());},rerender:function(){j.empty(this._rootElement);j.setContent(this._template.getNode('text'),"A link has been sent to your phone to install Messenger");j.remove(this._template.getNode('installButton'));j.setContent(this._rootElement,this._template.getRoot());n.get('post_click_timeout',function(s){this._timeoutResetCallback(this,s);}.bind(this));},installButtonClickHandler:function(){var s=new o('/ajax/marketing/messenger_send_to_mobile').setQueryData({fb_source:'web_chat_upsell'});new g().setURI(s).setMethod('POST').setHandler(function(v){this.rerender();}.bind(this)).send();var t=n.getNow('impression_count'),u=t*100;n.setImpressionCount(this._canonicalUser,u);},isPermanent:function(){return false;},timeoutCanBeReset:function(){return true;},setResetTimeoutCallback:function(s){this._timeoutResetCallback=s;},getType:function(){return 'messenger_promo_type';},getCloseTimeout:function(){return n.getNow('promo_timeout');},_displayUpsellCallback:function(s){if(!s)return;this._sheetView.open(this);this._sheetHasBeenDisplayed=true;var t=n.getNow('impression_count');n.setImpressionCount(this._canonicalUser,t+1);return;},displayPromo:function(s){var t=i.MercurySourceType;if(!s||(s.source!=t.CHAT_ORCA&&s.source!=t.TITAN_ORCA)||k.getUserID(s.author)!=this._canonicalUser||this._sheetHasBeenDisplayed)return;n.get('should_show_orca_promotion',function(u){this._displayUpsellCallback(u);}.bind(this));}});e.exports=r;});
__d("ChatNewMessagesTabSheet",["event-extensions","ArbiterMixin","DOM","ChatTabTemplates","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ArbiterMixin'),h=b('DOM'),i=b('ChatTabTemplates'),j=b('copyProperties');function k(l,m,n){this._threadID=l;this._rootElement=m;this._sheetView=n;}j(k.prototype,g,{render:function(){var l=i[':fb:mercury:chat:tab-sheet:clickable-message-icon-sheet'].build();h.setContent(l.getNode('text'),h.tx._("Scroll down to see new messages."));h.setContent(this._rootElement,l.getRoot());Event.listen(l.getRoot(),'click',function(){this.inform('clicked',this._threadID);}.bind(this));},isPermanent:function(){return true;},getType:function(){return 'new_messages_type';},open:function(){this._sheetView.open(this);},close:function(){this._sheetView.close(this);}});e.exports=k;});
__d("ChatNoRecipientsTabSheet",["DOM","MercuryParticipants","ChatTabTemplates","MercuryThreadInformer","MercuryThreads","copyProperties"],function(a,b,c,d,e,f){var g=b('DOM'),h=b('MercuryParticipants'),i=b('ChatTabTemplates'),j=b('MercuryThreadInformer'),k=b('MercuryThreads').get(),l=b('copyProperties');function m(n,o,p){this._threadID=n;this._rootElement=o;this._sheetView=p;j.subscribe('threads-updated',this._handleThreadsUpdated.bind(this));}l(m.prototype,{render:function(){var n=i[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build();g.setContent(n.getNode('text'),g.tx._("All recipients have left this conversation. Please close the stale tab."));g.setContent(this._rootElement,n.getRoot());},isPermanent:function(){return true;},getType:function(){return 'no_recipients_type';},_handleThreadsUpdated:function(){k.getThreadMeta(this._threadID,function(n){var o=h.user,p=n.participants.filter(function(q){return q!=o;});if(p.length<1){this._sheetView.open(this);}else this._sheetView.close(this);}.bind(this));}});e.exports=m;});
__d("ChatOfflineTabSheet",["event-extensions","ChatPrivacyActionController","MercurySheetView","ChatVisibility","CSS","DOM","JSLogger","MercuryConfig","MercuryParticipants","MercuryThreads","ChatTabTemplates","copyProperties","cx"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ChatPrivacyActionController'),h=b('MercurySheetView'),i=b('ChatVisibility'),j=b('CSS'),k=b('DOM'),l=b('JSLogger'),m=b('MercuryConfig'),n=b('MercuryParticipants'),o=b('MercuryThreads').get(),p=b('ChatTabTemplates'),q=b('copyProperties'),r=b('cx');function s(t,u,v){this._rootElement=u;this._sheetView=v;this._logger=l.create('blackbird');this._canonicalUser=o.getCanonicalUserInThread(t);if(this._canonicalUser)this._privacyActionController=new g(this._canonicalUser,this._handlePrivacyChange.bind(this));}q(s.prototype,{render:function(){if(!this._canonicalUser){this._logger.error('offline_sheet_open_with_non_friend');return;}var t=p[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build(),u='fbid:'+this._canonicalUser;n.get(u,function(v){var w='fbChatGoOnlineLink',x=m.ChatControlLanguageChangeGK?k.tx._("turn on chat"):k.tx._("go online"),y=k.create('a',{href:'#',className:w},x),z;if(m.ChatControlLanguageChangeGK){z=k.tx._("To chat with {name} and other friends, {link}.",{name:v.short_name,link:y});}else z=k.tx._("You are now offline. To chat with {name} and other friends, {link}.",{name:v.short_name,link:y});k.setContent(t.getNode('text'),z);j.addClass(t.getRoot(),"_1sk1");k.setContent(this._rootElement,t.getRoot());Event.listen(this._rootElement,'click',function(event){if(j.hasClass(event.getTarget(),w)){if(i.isOnline())this._logger.error('tab_sheet_already_online');this._privacyActionController.togglePrivacy();this._logger.log('tab_sheet_go_online',{tab_id:this._canonicalUser});return false;}}.bind(this));}.bind(this));},_handlePrivacyChange:function(t){if(!this._canonicalUser)this._logger.error('user_blocked_sheet_privacy_changed_non_friend');switch(t){case g.OFFLINE:this._sheetView.open(this);break;case g.NORMAL:case g.BLOCKED:this._sheetView.close(this);break;}},isPermanent:function(){return true;},getType:function(){return 'offline_type';},destroy:function(){this._privacyActionController&&this._privacyActionController.destroy();}});e.exports=s;});
__d("ChatUploadWarningTabSheet",["DOM","ChatTabTemplates","copyProperties"],function(a,b,c,d,e,f){var g=b('DOM'),h=b('ChatTabTemplates'),i=b('copyProperties');function j(k,l,m){this._threadID=k;this._rootElement=l;this._sheetView=m;}i(j.prototype,{render:function(){var k=h[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build();g.setContent(k.getNode('text'),g.tx._("Please wait until the upload is complete before you send your message."));g.setContent(this._rootElement,k.getRoot());},isPermanent:function(){return false;},getType:function(){return 'upload_warning_type';},open:function(){this._sheetView.open(this);},close:function(){this._sheetView.close(this);}});e.exports=j;});
__d("ChatThreadIsMutedTabSheet",["event-extensions","ArbiterMixin","DOM","ChatTabTemplates","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ArbiterMixin'),h=b('DOM'),i=b('ChatTabTemplates'),j=b('copyProperties');function k(l,m,n){this._threadID=l;this._rootElement=m;this._sheetView=n;}j(k.prototype,g,{render:function(){var l=i[':fb:mercury:chat:tab-sheet:message-mute-sheet'].build();h.setContent(l.getNode('text'),h.tx._("Conversation is muted."));h.setContent(this._rootElement,l.getRoot());Event.listen(l.getNode('unmuteButton'),'click',function(){this.inform('clicked',this._threadID);}.bind(this));},isPermanent:function(){return false;},getType:function(){return 'chat-thread-is-muted';},open:function(){this._sheetView.open(this);},close:function(){this._sheetView.close(this);}});e.exports=k;});
__d("ChatUserBlockedTabSheet",["event-extensions","ChatPrivacyActionController","MercurySheetView","CSS","DOM","GenderConst","JSLogger","MercuryConfig","MercuryParticipants","MercuryThreads","ChatTabTemplates","copyProperties","cx","tx"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ChatPrivacyActionController'),h=b('MercurySheetView'),i=b('CSS'),j=b('DOM'),k=b('GenderConst'),l=b('JSLogger'),m=b('MercuryConfig'),n=b('MercuryParticipants'),o=b('MercuryThreads').get(),p=b('ChatTabTemplates'),q=b('copyProperties'),r=b('cx'),s=b('tx');function t(u,v,w){this._rootElement=v;this._sheetView=w;this._logger=l.create('blackbird');this._canonicalUser=o.getCanonicalUserInThread(u);if(this._canonicalUser)this._privacyActionController=new g(this._canonicalUser,this._handlePrivacyChange.bind(this));}q(t.prototype,{render:function(){if(!this._canonicalUser){this._logger.error('user_blocked_sheet_open_with_non_friend');return;}var u=p[':fb:mercury:chat:tab-sheet:user-blocked'].build(),v='fbid:'+this._canonicalUser;n.get(v,function(w){var x=null;switch(w.gender){case k.FEMALE_SINGULAR:case k.FEMALE_SINGULAR_GUESS:x=m.ChatControlLanguageChangeGK?s._("You turned off chat for {name} but you can still send her a message. ",{name:w.short_name}):s._("{name} sees you as offline on chat, but you can still send her a message. ",{name:w.short_name});break;case k.MALE_SINGULAR:case k.MALE_SINGULAR_GUESS:x=m.ChatControlLanguageChangeGK?s._("You turned off chat for {name} but you can still send him a message. ",{name:w.short_name}):s._("{name} sees you as offline on chat, but you can still send him a message. ",{name:w.short_name});break;default:x=m.ChatControlLanguageChangeGK?s._("You turned off chat for {name} but you can still send them a message. ",{name:w.short_name}):s._("{name} sees you as offline on chat, but you can still send them a message. ",{name:w.short_name});}j.setContent(u.getNode('text'),x);var y=m.ChatControlLanguageChangeGK?s._("Turn on chat for {name}?",{name:w.short_name}):s._("Go Online to {name}",{name:w.short_name});j.setContent(u.getNode('actionLink'),y);i.addClass(u.getRoot(),"_1sk0");j.setContent(this._rootElement,u.getRoot());Event.listen(u.getNode('actionLink'),'click',this._privacyActionController.togglePrivacy.bind(this._privacyActionController));}.bind(this));},_handlePrivacyChange:function(u){if(!this._canonicalUser)this._logger.error('user_blocked_sheet_privacy_changed_non_friend');switch(u){case g.BLOCKED:this._sheetView.open(this);break;case g.NORMAL:case g.OFFLINE:this._sheetView.close(this);break;}},isPermanent:function(){return true;},getType:function(){return 'user_blocked_type';},destroy:function(){this._privacyActionController&&this._privacyActionController.destroy();}});e.exports=t;});
__d("ChatTabSheetController",["ChatAddFriendsTabSheet","ChatAvailabilityTabSheet","ChatMessengerPromoTabSheet","ChatNewMessagesTabSheet","ChatNoRecipientsTabSheet","ChatOfflineTabSheet","ChatUploadWarningTabSheet","ChatThreadIsMutedTabSheet","ChatUserBlockedTabSheet","copyProperties","MercurySheetView","MercuryThreads"],function(a,b,c,d,e,f){var g=b('ChatAddFriendsTabSheet'),h=b('ChatAvailabilityTabSheet'),i=b('ChatMessengerPromoTabSheet'),j=b('ChatNewMessagesTabSheet'),k=b('ChatNoRecipientsTabSheet'),l=b('ChatOfflineTabSheet'),m=b('ChatUploadWarningTabSheet'),n=b('ChatThreadIsMutedTabSheet'),o=b('ChatUserBlockedTabSheet'),p=b('copyProperties'),q=b('MercurySheetView'),r=b('MercuryThreads').get(),s=function(t,u,v){this._sheetView=new q(t,u,v);this._addFriendsTabSheet=new g(t,u,this._sheetView);this._userBlockedTabSheet=new o(t,u,this._sheetView);this._offlineTabSheet=new l(t,u,this._sheetView);this._messengerPromoTabSheet=new i(t,u,this._sheetView);this._newMessagesTabSheet=new j(t,u,this._sheetView);this._availabilityTabSheets=h.createSheets(t,u,this._sheetView);this._uploadWarningTabSheet=new m(t,u,this._sheetView);this._threadIsMutedTabSheet=new n(t,u,this._sheetView);if(!r.getCanonicalUserInThread(t))this._noRecipientsTabSheet=new k(t,u,this._sheetView);};p(s.prototype,{openAddFriendsSheet:function(){this._addFriendsTabSheet.open();},openNewMessagesSheet:function(){this._newMessagesTabSheet.open();},openUploadWarningTabSheet:function(){this._uploadWarningTabSheet.open();},openThreadIsMutedTabSheet:function(){this._threadIsMutedTabSheet.open();},closeThreadIsMutedTabSheet:function(){this._threadIsMutedTabSheet.close();},closeNewMessagesSheet:function(){this._newMessagesTabSheet.close();},displayMessengerPromoTabSheet:function(t){this._messengerPromoTabSheet.displayPromo(t);},closeUploadWarningTabSheet:function(){this._uploadWarningTabSheet.close();},onClickNewMessagesSheet:function(t){this._newMessageClickSub=this._newMessagesTabSheet.subscribe('clicked',t);},onClickThreadIsMutedSheet:function(t){this._threadIsMutedClickSub=this._threadIsMutedTabSheet.subscribe('clicked',t);},destroy:function(){this._sheetView.destroy();this._offlineTabSheet.destroy();this._userBlockedTabSheet.destroy();this._newMessageClickSub&&this._newMessageClickSub.unsubscribe();this._threadIsMutedClickSub&&this._threadIsMutedClickSub.unsubscribe();}});e.exports=s;});
__d("MercuryThreadMuter",["AsyncDialog","AsyncRequest","Env","MercuryThreads"],function(a,b,c,d,e,f){var g=b('AsyncDialog'),h=b('AsyncRequest'),i=b('Env'),j=b('MercuryThreads').get(),k={getUserIDEmail:function(){return i.user+'@facebook.com';},getThreadMuteSettingForUser:function(l){return l.mute_settings&&l.mute_settings[k.getUserIDEmail()];},isThreadMuted:function(l){return k.getThreadMuteSettingForUser(l)!==undefined;},showMuteChangeDialog:function(l,m){g.send(new h('/ajax/mercury/mute_thread_dialog.php').setData({muting:l}),function(n){n.subscribe('confirm',function(){this.hide();j.updateThreadMuteSetting(m,l);}.bind(n));});}};e.exports=k;});
__d("endsWith",[],function(a,b,c,d,e,f){function g(h,i){return h.indexOf(i,h.length-i.length)>-1;}e.exports=g;});
__d("MessagesEmoticonView",["event-extensions","function-extensions","DOM","InputSelection","Parent","TextAreaControl","Toggler","copyProperties","endsWith","startsWith","EmoticonsList"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('DOM'),h=b('InputSelection'),i=b('Parent'),j=b('TextAreaControl'),k=b('Toggler'),l=b('copyProperties'),m=b('endsWith'),n=b('startsWith'),o=b('EmoticonsList'),p=o.symbols;function q(s,t,u){var v=i.byClass(s,'emoticon');if(!v)return;var w='emoticon_',x=null;v.className.split(' ').forEach(function(ea){if(n(ea,w))x=ea.substring(w.length);});if(!p[x])return;var y=j.getInstance(t),z=y.getValue(),aa=p[x],ba=z.substring(0,u.start),ca=z.substring(u.end);if(u.start>0&&!m(ba,' '))aa=' '+aa;if(!n(ca,' '))aa+=' ';var da=ba+aa+ca;u.start+=aa.length;u.end=u.start;y.setValue(da);h.set(t,u.start,u.end);}function r(s,t){var u={start:0,end:0};function v(){u=h.get(t);}var w=g.find(s,'.uiToggleFlyout');this._subscription=k.subscribe('show',function(x,y){if(y.active&&g.contains(s,y.active))h.set(t,u.start,u.end);});this._eventListeners=[Event.listen(w,'click',function(event){k.hide(s);q(event.getTarget(),t,u);}),Event.listen(t,'keyup',v),Event.listen(t,'click',v)];}l(r.prototype,{destroy:function(){this._subscription.unsubscribe();while(this._eventListeners.length)this._eventListeners.pop().remove();}});l(r,{create:function(s,t){return new r(s,t);}});e.exports=r;});
__d("SubscriptionsHandler",["JSLogger","copyProperties"],function(a,b,c,d,e,f){var g=b('JSLogger'),h=b('copyProperties'),i=g.create('subscriptions_handler');function j(k){this._name=k||'unnamed';this._subscriptions=[];}h(j.prototype,{addSubscriptions:function(){if(this._subscriptions){Array.prototype.push.apply(this._subscriptions,arguments);}else{i.warn(this._name+'.subscribe_while_released');for(var k=0,l=arguments.length;k<l;k++)this._unsubscribe(arguments[k]);}},engage:function(){this._subscriptions=this._subscriptions||[];},release:function(){if(this._subscriptions)this._subscriptions.forEach(this._unsubscribe.bind(this));this._subscriptions=null;},_unsubscribe:function(k){if(k.remove){k.remove();}else if(k.reset){k.reset();}else if(k.unsubscribe){k.unsubscribe();}else i.error(this._name+'.invalid',k);}});e.exports=j;});
__d("ChatTabView",["event-extensions","function-extensions","Arbiter","ArbiterMixin","AsyncDialog","AsyncRequest","AvailableList","AvailableListConstants","ChatBehavior","ChatConfig","ChatContextualDialogController","ChatPrivacyActionController","ChatQuietLinks","ChatTabMessagesView","ChatTabSheetController","ChatVisibility","MercuryConfig","CSS","Dialog","Dock","DOM","JSLogger","Keys","MercuryConstants","MercuryFileUploader","MercuryMessages","MercuryParticipants","MercuryServerRequests","MercuryThreadInformer","MercuryThreadMetadataRawRenderer","MercuryThreadMetadataRenderer","MercuryThreadMuter","MercuryThreads","MercuryTypingReceiver","MessagesEmoticonView","NubController","Parent","PresencePrivacy","SubscriptionsHandler","ChatTabTemplates","TextAreaControl","Tooltip","TypingIndicator","URI","UserAgent","VideoCallCore","copyProperties","setIntervalAcrossTransitions","tx"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('AsyncDialog'),j=b('AsyncRequest'),k=b('AvailableList'),l=b('AvailableListConstants'),m=b('ChatBehavior'),n=b('ChatConfig'),o=b('ChatContextualDialogController'),p=b('ChatPrivacyActionController'),q=b('ChatQuietLinks'),r=b('ChatTabMessagesView'),s=b('ChatTabSheetController'),t=b('ChatVisibility'),u=b('MercuryConfig'),v=b('CSS'),w=b('Dialog'),x=b('Dock'),y=b('DOM'),z=b('JSLogger'),aa=b('Keys'),ba=b('MercuryConfig'),ca=b('MercuryConstants'),da=b('MercuryFileUploader'),ea=b('MercuryMessages'),fa=b('MercuryParticipants'),ga=b('MercuryServerRequests'),ha=b('MercuryThreadInformer'),ia=b('MercuryThreadMetadataRawRenderer'),ja=b('MercuryThreadMetadataRenderer'),ka=b('MercuryThreadMuter'),la=b('MercuryThreads').get(),ma=b('MercuryTypingReceiver'),na=b('MessagesEmoticonView'),oa=b('NubController'),pa=b('Parent'),qa=b('PresencePrivacy'),ra=b('SubscriptionsHandler'),sa=b('ChatTabTemplates'),ta=b('TextAreaControl'),ua=b('Tooltip'),va=b('TypingIndicator'),wa=b('URI'),xa=b('UserAgent'),ya=b('VideoCallCore'),za=b('copyProperties'),ab=b('setIntervalAcrossTransitions'),bb=b('tx'),cb=z.create('tab_view'),db={};function eb(tb,ub){var vb=y.create('div');ub=ub.filter(function(wb){return wb!=fa.user;});fa.getMulti(ub,function(wb){for(var xb in wb){var yb=wb[xb],zb=sa[':fb:mercury:chat:multichat-tooltip-item'].build();y.setContent(zb.getNode('name'),yb.name);var ac=fa.getUserID(xb),bc=ac&&k.get(ac)==l.ACTIVE;v.conditionShow(zb.getNode('icon'),bc);v.conditionClass(zb.getNode('name'),'tooltipItemWithIcon',bc);y.appendContent(vb,zb.getRoot());}ua.set(tb,vb,'above','center');});}var fb={},gb=null,hb=false;function ib(tb,ub,vb){if(vb){fb[tb]=ub;if(!gb)gb=ab(jb,600);}else{v.removeClass(ub,'highlightTitle');delete fb[tb];}}function jb(){for(var tb in fb){var ub=fb[tb];if(ub.parentNode){v.conditionClass(ub,'highlightTitle',hb);}else delete fb[tb];}hb=!hb;if(!Object.keys(fb).length){clearInterval(gb);gb=null;}}function kb(tb){var ub=ga.tokenizeThreadID(tb);switch(ub.type){case 'user':return sa[':fb:mercury:chat:user-tab'].build();case 'group':return sa[':fb:mercury:chat:group-tab'].build();}return sa[':fb:mercury:chat:multichat-tab'].build();}function lb(tb){var ub=tb._fileUploader&&tb._fileUploader.getAttachments();return ub&&ub.length;}function mb(tb){var ub=tb._tabTemplate.getNode('input'),vb=ub.value||'';if(!/^\s*$/.test(vb)||lb(tb))la.getThreadMeta(tb._threadID,function(wb){var xb=ea.constructUserGeneratedMessageObject(vb,ca.MercurySourceType.CHAT_WEB,tb._threadID);if(n.get('send_files_from_chat')){var yb=tb._fileUploader.getAttachments();if(yb&&yb.length){xb.has_attachment=true;xb.raw_attachments=yb;}}if(la.isEmptyLocalThread(tb._threadID)){var zb=ga.tokenizeThreadID(tb._threadID);xb.message_id=zb.value;xb.specific_to_list=wb.participants;}ea.sendMessage(xb);if(n.get('send_files_from_chat'))nb(tb);tb._getNode('input').value='';tb._typingIndicator&&tb._typingIndicator.resetState();tb._messagesView&&tb._messagesView.scrollToBottom();}.bind(tb));}function nb(tb){tb._fileUploader.removeAttachments();}function ob(tb){tb._blocked=true;tb._sheetController.openUploadWarningTabSheet();}function pb(){if(this._blocked){if(this._fileUploader.isUploading())return;this._blocked=false;mb(this);this._sheetController.closeUploadWarningTabSheet();}}function qb(){d(['Dock'],function(tb){tb.resizeAllFlyouts();});this._attachmentsDiv.scrollTop=this._attachmentsDiv.scrollHeight;}function rb(tb,ub){if(ub)ga.ensureThreadIsFetched(ub);this._threadID=tb;this._eventListeners=[];this._tabTemplate=kb(tb);this._tabElem=this._tabTemplate.getRoot();if(!(this._getNode instanceof Function))cb.log('getnode_undefined',{is_getnode_set:!!this._getNode,is_prototype_set:!!rb.prototype,is_window:window==this,is_chat_tab_view:this instanceof rb,ctor_name:this.constructor&&this.constructor.name});this._subscriptionsHandler=new ra();if(n.get('send_files_from_chat')){this._fileUploader=new da(this._tabTemplate.getNode('attachmentShelf'),this._tabTemplate.getNode('attachButtonForm'),this._tabTemplate.getNode('fileInput'),this._tabTemplate.getNode('attachID'));this._subscriptionsHandler.addSubscriptions(this._fileUploader.subscribe(['all-uploads-completed','upload-canceled'],pb.bind(this)),this._fileUploader.subscribe('dom-updated',qb.bind(this)));this._attachmentsDiv=this._getNode('attachmentShelf');}else if(this._tabTemplate.getNode('uploadFilesLink'))v.hide(this._tabTemplate.getNode('uploadFilesLink'));this._sheetController=new s(this._threadID,this._getNode('sheet'),this._tabElem);this._sheetController.onClickNewMessagesSheet(function(){this._messagesView&&this._messagesView.scrollToBottom();this.focus();}.bind(this));this._sheetController.onClickThreadIsMutedSheet(function(){ka.showMuteChangeDialog(0,this._threadID);this.focus();}.bind(this));this._contextualDialogController=new o(this._threadID,this._getNode('videoCallLink'));this._messagesView=null;var vb=this._getNode('conversationLink');if(vb){v.hide(vb);ja.renderTitanLink(tb,vb,v.show.bind(v,vb));}if(!la.getCanonicalUserInThread(this._threadID))this._titlebarTooltipAnchor=this._getNode('titlebarText');var wb=this._getCanonicalUserID();if(this._isTitleTextLinked())fa.get('fbid:'+wb,function(zb){if(zb.href){var ac=this._getNode('titlebarText');ac.setAttribute('href',zb.href);ac.removeAttribute('rel');v.removeClass(ac,'noLink');}}.bind(this));this._nubController=new oa().init(this._tabElem);ta.getInstance(this._getNode('input')).subscribe('resize',function(){this._nubController.flyoutContentChanged();}.bind(this));this._nubController.subscribe('resize',function(){this._emoticonsNode.style.left=(this._getNode('input').clientWidth+3)+'px';ta.getInstance(this._getNode('input')).update();}.bind(this));this._listen('closeButton','click',this._closeClicked);this._listen('titlebarCloseButton','click',this._closeClicked);this._listen('dockButton','click',this._nubClicked);this._listen('dockButton','keydown',this._dockKeyDown);this._listen('nubFlyoutTitlebar','click',this._titleClicked);this._listen('chatConv','click',this._chatConvClicked);this._listen('uploadFilesLink','click',this._uploadFilesLinkClicked,true);this._listen('addFriendLink','click',this._addFriendLinkClicked,true);this._listen('addToThreadLink','click',this._addFriendLinkClicked,true);this._listen('clearWindowLink','click',this._clearHistory,true);this._listen('unsubscribeLink','click',this._unsubscribeLinkClicked,true);this._listen('videoCallLink','click',this._callClicked,true);this._listen('reportSpamLink','click',this._reportSpamClicked,true);this._listen('muteThreadLink','click',this._showMuteSettingDialog.bind(this,-1),true);this._listen('unmuteThreadLink','click',this._showMuteSettingDialog.bind(this,0),true);this._listen('input','focus',this._focusTab);this._listen('input','blur',this._blurTab);this._emoticonsNode=this._getNode('emoticons');this._emoticonView=new na(this._emoticonsNode,this._getNode('input'));if(xa.firefox()){this._listen('input','keypress',this._inputKeyDown);}else this._listen('input','keydown',this._inputKeyDown);this._privacyLink=this._getNode('privacyLink');if(this._privacyLink){this._privacyActionController=new p(wb,this._updatePrivacyLink.bind(this));this._eventListeners.push(Event.listen(this._privacyLink,'click',this._privacyActionController.togglePrivacy.bind(this._privacyActionController)));}la.getThreadMeta(this._threadID,function(zb){var ac=wb||(n.get('chat_multi_typ_send')&&!zb.is_canonical);if(ac)ga.getServerThreadID(this._threadID,function(bc){this._typingIndicator=new va(wb,this._getNode('input'),'mercury-chat',null,bc);}.bind(this));this._setUpMutingSettings(zb);}.bind(this));var xb=this._getNode('muteGroupLink');if(xb){var yb=la.getCanonicalGroupInThread(this._threadID);if(yb)xb.setAttribute('ajaxify',wa(xb.getAttribute('ajaxify')).addQueryData({id:yb}));}q.removeEmptyHrefs(this._tabElem);db[tb]=this;this.updateAvailableStatus();this.updateTab();}function sb(){for(var tb in db){db[tb].updateAvailableStatus();db[tb].updateMultichatTooltip();}}g.subscribe(['buddylist/availability-changed'],sb);qa.subscribe(['privacy-changed','privacy-availability-changed'],sb);m.subscribe(m.ON_CHANGED,function(){for(var tb in db)la.getThreadMeta(tb,function(ub){db[tb]._updateUnreadCount(ub);});});ma.subscribe('state-changed',function(tb,ub){for(var vb in ub){var wb=ub[vb]&&ub[vb].length,xb=db[vb];xb&&xb.showTypingIndicator(wb);}});ha.subscribe('threads-updated',function(tb,ub){for(var vb in db)ub[vb]&&db[vb].updateTab();});ha.subscribe('threads-deleted',function(tb,ub){for(var vb in db)ub[vb]&&rb.inform('thread-deleted',vb);});za(rb,h,{get:function(tb){return db[tb];}});za(rb.prototype,{getThreadID:function(){return this._threadID;},isVisible:function(){return v.shown(this._tabElem);},setVisibleState:function(tb,ub){var vb=v.shown(this._tabElem),wb=v.hasClass(this._tabElem,'opened');v.conditionShow(this._tabElem,tb);v.conditionClass(this._tabElem,'opened',ub);if(!(vb&&wb)&&tb&&ub){if(!this._messagesView)this._messagesView=new r(this._threadID,this._sheetController,this._getNode('chatConv'),this._getNode('conversation'),this._getNode('loadingIndicator'),this._getNode('typingIndicator'));this._nubController.flyoutContentChanged();this._messagesView.scrollToBottom();}if(vb&&wb&&!(tb&&ub))this._contextualDialogController.tabNotActive();},focus:function(){var tb=v.hasClass(this._tabElem,'opened')?'input':'dockButton';this._getNode(tb).focus();},isFocused:function(){var tb=document.activeElement;return pa.byClass(tb,'fbMercuryChatTab')===this._tabElem;},setInput:function(tb){this._getNode('input').value=tb;},insertBefore:function(tb){y.insertBefore(tb._tabElem,this._tabElem);},appendTo:function(tb){y.appendContent(tb,this._tabElem);},nextTabIs:function(tb){var ub=tb&&tb._tabElem;return this._tabElem.nextSibling==ub;},destroy:function(){y.remove(this._tabElem);this._emoticonView&&this._emoticonView.destroy();while(this._eventListeners.length)this._eventListeners.pop().remove();this._messagesView&&this._messagesView.destroy();this._sheetController.destroy();if(n.get('send_files_from_chat'))this._fileUploader.destroy();this._subscriptionsHandler.release();this._contextualDialogController.destroy();this._privacyActionController&&this._privacyActionController.destroy();delete db[this._threadID];x.unregisterNubController(this._nubController);},updateAvailableStatus:function(){var tb={active:false,mobile:false,greenphone:false},ub=this._getCanonicalUserID(),vb=true,wb=false;if(ub){var xb=k.get(ub);vb=!t.isOnline();wb=!qa.allows(ub);tb.active=(xb===l.ACTIVE);if(n.get('sidebar_mobile_icon_green')){tb.greenphone=xb===l.MOBILE;}else tb.mobile=xb===l.MOBILE;this._updateCallLink(xb);}v.conditionClass(this._tabElem,'chatOffline',vb);v.conditionClass(this._tabElem,'blocked',!vb&&wb);for(var yb in tb)v.conditionClass(this._tabElem,yb,!vb&&!wb&&tb[yb]);},updateTab:function(){la.getThreadMeta(this._threadID,function(tb){if(!tb.is_subscribed){rb.inform('unsubscribed',this._threadID);return;}ja.renderAndSeparatedParticipantList(this._threadID,[this._getNode('name'),this._getNode('titlebarText')],{names_renderer:ia.renderShortNames,check_length:true});this._updateMutingSettings(tb);this._updateUnreadCount(tb);this.updateMultichatTooltip();this._updateArchiveWarning(tb);}.bind(this));},_setUpMutingSettings:function(tb){var ub=ka.isThreadMuted(tb);if(ub&&u.MuteThreadsOnDesktopGK)this._sheetController.openThreadIsMutedTabSheet();this._updateActionMenu(ub);},_updateMutingSettings:function(tb){if(!u.MuteThreadsOnDesktopGK)return;var ub=ka.isThreadMuted(tb);if(ub&&v.shown(this._getNode('muteThreadLink').parentNode)){this._sheetController.openThreadIsMutedTabSheet();}else if(!ub&&v.shown(this._getNode('unmuteThreadLink').parentNode))this._sheetController.closeThreadIsMutedTabSheet();this._updateActionMenu(ub);},_updateActionMenu:function(tb){v.conditionShow(this._getNode('muteThreadLink').parentNode,u.MuteThreadsOnDesktopGK&&!tb);v.conditionShow(this._getNode('unmuteThreadLink').parentNode,u.MuteThreadsOnDesktopGK&&tb);},_updateArchiveWarning:function(tb){var ub=false;fa.get(fa.user,function(vb){ub=vb.employee;if(ub)fa.getMulti(tb.participants,this._showArchiveWarningIfAllParticipantsAreEmployees.bind(this));}.bind(this));},_showArchiveWarningIfAllParticipantsAreEmployees:function(tb){var ub=true;for(var vb in tb)ub=ub&&tb[vb].employee;var wb=this._getNode('titanArchiveWarning');if(wb){if(this._titlebarTooltipAnchor)v.conditionClass(this._titlebarTooltipAnchor,'narrowTitleBar',ub);v.conditionShow(wb,ub);}},updateMultichatTooltip:function(){la.getThreadMeta(this._threadID,function(tb){if(!tb.is_canonical)eb(this._titlebarTooltipAnchor,tb.participants);}.bind(this));},_getNode:function(tb){return this._tabTemplate.getNode(tb);},_getCanonicalUserID:function(){return la.getCanonicalUserInThread(this._threadID);},_listen:function(tb,event,ub,vb){var wb=this._getNode(tb);if(wb){this._eventListeners.push(Event.listen(wb,event,ub.bind(this)));}else if(!vb)throw new Error('Could not find node "'+tb+'"');},_closeClicked:function(tb){rb.inform('closed-tab',this._threadID);tb.prevent();},_nubClicked:function(){return rb.inform('nub-activated',this._threadID);},_dockKeyDown:function(event){if(event.keyCode===aa.RETURN||event.keyCode===aa.SPACE){rb.inform('nub-activated',this._threadID);event.kill();}else this._handleHotkeyPressed(event);},_handleHotkeyPressed:function(event){if(event.keyCode===aa.ESC){rb.inform('esc-pressed',this._threadID);event.kill();}else if(event.keyCode===aa.TAB&&!event.ctrlKey){var tb=rb.inform('tab-pressed',{id:this._threadID,shiftPressed:event.shiftKey});!tb&&event.kill();}},_isTitleTextLinked:function(){var tb=this._getCanonicalUserID();return tb&&n.get('chat_tab_title_link_timeline');},_titleClicked:function(event){var tb=event.getTarget(),ub=pa.byClass(tb,'titlebarText'),vb=ub&&this._isTitleTextLinked();if(!vb&&!pa.byClass(tb,'uiSelector')&&!pa.byClass(tb,'addToThread'))rb.inform('lower-activated',this._threadID);},_callClicked:function(tb){var ub=this._getCanonicalUserID();if(ya.availableForCall(ub)){var vb='chat_tab_icon';if(tb.target&&v.hasClass(tb.target,'video_call_promo')){vb='chat_tab_icon_promo';}else if(tb.target&&v.hasClass(tb.target,'video_call_tour'))vb='chat_tab_icon_tour';rb.inform('video-call-clicked',{threadID:this._threadID,userID:ub,clickSource:vb});}return false;},_uploadFilesLinkClicked:function(){this._tabTemplate.getNode('fileInput').click();},_addFriendLinkClicked:function(){this._sheetController.openAddFriendsSheet();},_clearHistory:function(){var tb=la.getThreadMetaNow(this._threadID);if(tb){var ub=this._getCanonicalUserID();ga.clearChat(this._threadID,ub,tb.timestamp);}},_unsubscribeLinkClicked:function(){var tb=[];tb.push({name:'unsubscribe',label:"Leave Conversation",handler:this._unsubscribeToThread.bind(this)});tb.push(w.CANCEL);new w().setTitle("Leave Conversation?").setBody("You will stop receiving messages from this conversation and people will see that you left.").setButtons(tb).show();},_reportSpamClicked:function(){var tb=this._getCanonicalUserID(),ub=wa('/ajax/chat/report.php').addQueryData({id:tb}).addQueryData({src:'top_report_link'});i.send(new j(ub));},_showMuteSettingDialog:function(tb){ka.showMuteChangeDialog(tb,this._threadID);},_focusTab:function(){v.addClass(this._tabElem,'focusedTab');rb.inform('focused',this._threadID);this._contextualDialogController.tabFocused();},_blurTab:function(){v.removeClass(this._tabElem,'focusedTab');},_inputKeyDown:function(event){if(event.keyCode===aa.RETURN&&!event.shiftKey){if(n.get('send_files_from_chat')){var tb=this._fileUploader.isUploading();if(tb){ob(this);return;}}mb(this);event.kill();}if(event.keyCode===aa.DOWN&&event.shiftKey&&this._getNode('input').value===''){rb.inform('lower-activated',this._threadID);event.kill();return;}this._handleHotkeyPressed(event);},_chatConvClicked:function(tb){if(pa.byTag(tb.getTarget(),'a')||y.getSelection())return;this.focus();},showTypingIndicator:function(tb){var ub=la.getThreadMetaNow(this._threadID),vb=this._getCanonicalUserID()||(n.get('chat_multi_typ')&&ub&&!ub.is_canonical);if(vb)v.conditionClass(this._tabElem,'typing',tb);},_updateUnreadCount:function(tb){var ub=tb.unread_count;if(typeof ub!='undefined'){var vb=!!ub&&(!m.showsTabUnreadUI||m.showsTabUnreadUI()),wb=this._getNode('numMessages');v.conditionShow(wb,vb);v.conditionClass(this._tabElem,'highlightTab',vb);ib(this._threadID,this._tabElem,vb);y.setContent(wb,ub);}},_updateCallLink:function(tb){var ub=this._getNode('videoCallLink');if(t.isOnline()){var vb=this._getCanonicalUserID(),wb='fbid:'+vb;fa.get(wb,function(xb){if(ya.availableForCall(vb)){ua.set(ub,bb._("Start a video call with {firstname}",{firstname:xb.short_name}));this._updateCallBackLinks(this._tabElem,true);}else{ua.set(ub,bb._("{firstname} is currently unavailable for video calling",{firstname:xb.short_name}));this._hideVideoCallouts();this._updateCallBackLinks(this._tabElem,false);}}.bind(this));}else{ua.set(ub,"You must be online to make a call.");this._hideVideoCallouts();this._updateCallBackLinks(document.body,false);}},_updateCallBackLinks:function(tb,ub){var vb=y.scry(tb,'a.callBackLink');if(ub){vb.forEach(v.show);}else vb.forEach(v.hide);},_hideVideoCallouts:function(){this._contextualDialogController.hideVideoCallouts();},_updatePrivacyLink:function(tb){if(tb==p.OFFLINE){y.setContent(this._privacyLink,"Go online");}else{var ub=this._getCanonicalUserID(),vb='fbid:'+ub;fa.get(vb,function(wb){var xb=null;if(tb==p.BLOCKED){if(ba.ChatControlLanguageChangeGK){xb=bb._("Turn On Chat for {name}",{name:wb.short_name});}else xb=bb._("Go Online to {name}",{name:wb.short_name});}else if(ba.ChatControlLanguageChangeGK){xb=bb._("Turn Off Chat for {name}",{name:wb.short_name});}else xb=bb._("Go Offline to {name}",{name:wb.short_name});y.setContent(this._privacyLink,xb);}.bind(this));}},_unsubscribeToThread:function(){if(la.isEmptyLocalThread(this._threadID)){rb.inform('unsubscribed',this._threadID);}else{var tb=ea.constructLogMessageObject(ca.MercurySourceType.CHAT_WEB,this._threadID,ca.MercuryLogMessageType.UNSUBSCRIBE,{});ea.sendMessage(tb);}return true;},_emoticonView:null});e.exports=rb;});
__d("ChatNewMessageHandler",["ChatActivity","ChatTabModel","ChatTabView","JSLogger","MercuryAssert","MercuryBrowserAlerts","MercuryThreads","MercuryUnseenState"],function(a,b,c,d,e,f){var g=b('ChatActivity'),h=b('ChatTabModel'),i=b('ChatTabView'),j=b('JSLogger'),k=b('MercuryAssert'),l=b('MercuryBrowserAlerts'),m=b('MercuryThreads').get(),n=b('MercuryUnseenState'),o=j.create('chat_new_message'),p={_raiseTab:function(q,r){var s=h.getTab(q),t=false;if(s){t=s.raised;}else{h.raiseTab(q,false);t=true;}r.to_new_tab=!s;r.to_raised_tab=!!t;},_notify:function(q,r,s){var t=i.get(q);s.view_is_visible=t&&t.isVisible();s.view_is_focused=t&&t.isFocused();if(!s.view_is_visible)o.log('message_to_hidden');s.is_active=g.isActive();l.messageReceived(r);},newMessage:function(q,r){k.isThreadID(q);var s={thread_id:q,message_id:r.message_id};this._raiseTab(q,s);this._notify(q,r,s);o.log('message',s);}};l.subscribe('before-alert',function(q,event){var r=event.threadID,s=i.get(r),t=h.getTab(r);if(t&&t.raised&&s&&s.isVisible()&&s.isFocused()){m.changeThreadReadStatus(r,true);n.markThreadSeen(r);event.cancelAlert();}});e.exports=p;});
__d("ChatTabPresence",["Arbiter","AvailableList","ChatTabModel","MercuryThreads"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableList'),i=b('ChatTabModel'),j=b('MercuryThreads').get(),k={};function l(m){var n=j.getCanonicalUserInThread(m);if(n)h.updateForID(n);}i.subscribe('chat/tabs-changed',function(event,m){m.tabs.forEach(function(n){if(n.raised&&!k[n.id])l(n.id);});k={};m.tabs.forEach(function(n){if(n.raised)k[n.id]=true;});});e.exports={};});
__d("ChatTabPolicy",["ChatBehavior","ChatConfig","MercuryConfig","FBDesktopPlugin","JSLogger","MercuryAssert","MercuryConstants","MercuryParticipants","MercuryThreadMuter","MercuryThreads","MercuryUnseenState","PresencePrivacy","ShortProfiles"],function(a,b,c,d,e,f){var g=b('ChatBehavior'),h=b('ChatConfig'),i=b('MercuryConfig'),j=b('FBDesktopPlugin'),k=b('JSLogger'),l=b('MercuryAssert'),m=b('MercuryConstants'),n=b('MercuryParticipants'),o=b('MercuryThreadMuter'),p=b('MercuryThreads').get(),q=b('MercuryUnseenState'),r=b('PresencePrivacy'),s=b('ShortProfiles'),t=k.create('tab_policy');function u(v,w){q.markThreadSeen(v,w);}e.exports={messageIsAllowed:function(v,w,x){var y=v.thread_id,z=w.message_id;l.isThreadID(y);l.isParticipantID(w.author);var aa;if(i.MuteThreadsOnDesktopGK&&o.isThreadMuted(v)){aa={thread_id:y,message_id:z,mute_settings:v.mute_settings};t.log('message_thread_muted',aa);return;}if(v.mode==m.MercuryThreadMode.OBJECT_ORIGINATED){aa={thread_id:y,message_id:z,mode:v.mode};t.log('message_object_originated',aa);return;}var ba=m.MercurySourceType;if(w.source==ba.EMAIL||w.source==ba.TITAN_EMAIL_REPLY){aa={thread_id:y,message_id:z,source:w.source};t.log('message_source_not_allowed',aa);return;}var ca=n.getUserID(w.author);if(!ca){t.log('message_bad_author',{thread_id:y,message_id:z,user:ca});return;}if(w.action_type!=m.MercuryActionType.USER_GENERATED_MESSAGE){aa={thread_id:y,message_id:z,type:w.action_type};t.log('message_non_user_generated',aa);return;}if(v.is_canonical_user&&!g.notifiesUserMessages()){t.log('message_jabber',{thread_id:y,message_id:z});u(y,true);return;}if(j.shouldSuppressMessages()){t.log('message_desktop',{thread_id:y,message_id:z});return;}if(v.folder!=m.MessagingTag.INBOX){t.log('message_folder',{thread_id:y,message_id:z,folder:v.folder});return;}s.get(ca,function(da){if(!r.allows(ca)){t.log('message_privacy',{thread_id:y,message_id:z,user:ca});return;}if(da.type!='friend'){t.log('message_non_friend',{thread_id:y,message_id:z,user:ca});return;}x();});}};});
__d("ChatTabViewSelector",["event-extensions","Arbiter","CSS","DataStore","DOM","Menu","MercuryThreadInformer","MercuryThreads","NubController","ChatTabTemplates","MercuryThreadMetadataRenderer","Toggler","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('CSS'),i=b('DataStore'),j=b('DOM'),k=b('Menu'),l=b('MercuryThreadInformer'),m=b('MercuryThreads').get(),n=b('NubController'),o=b('ChatTabTemplates'),p=b('MercuryThreadMetadataRenderer'),q=b('Toggler'),r=b('copyProperties');function s(t){var u=o[':fb:chat:tab:selector'].build(),v=u.getRoot(),w=u.getNode('menu'),x=j.find(w,'.uiMenuInner'),y={},z=new n().init(v);h.hide(v);j.insertBefore(t,v);function aa(da){var ea=0;for(var fa in y){var ga=y[fa],ha=m.getThreadMetaNow(fa),ia=ga.getNode('unreadCount'),ja=(ha&&ha.unread_count)||0;ea+=ja;if(ja>9)ja='+';h.conditionClass(ia,'invisible_elem',!ja);j.setContent(ia,ja);}var ka=u.getNode('numMessages');h.conditionShow(ka,ea);j.setContent(ka,ea);}this.setTabData=function(da){y={};if(da.length<1){h.hide(v);return;}h.show(v);j.empty(x);da.forEach(function(ea){var fa=o[':fb:chat:tab:selector:item'].build();y[ea.id]=fa;var ga=fa.getNode('content');p.renderAndSeparatedParticipantList(ea.id,ga);j.prependContent(x,fa.getRoot());i.set(fa.getRoot(),'threadID',ea.id);var ha=fa.getNode('closeButton');Event.listen(ha,'click',function(event){s.inform('selector/close-tab',ea.id);event.kill();});});z.flyoutContentChanged();j.setContent(u.getNode('numTabs'),da.length);aa();};function ba(event,da){if(da.menu!=w)return;var ea=i.get(da.item,'threadID');s.inform('selected',ea);q.hide(v);}function ca(event,da){k.register(w);}k.subscribe('select',ba.bind(this));q.listen('show',v,function(){g.inform('layer_shown',{type:'ChatTabSelector'});ca();});q.listen('hide',v,function(){g.inform('layer_hidden',{type:'ChatTabSelector'});});l.subscribe('threads-updated',aa);}r(s,new g());e.exports=s;});
__d("ChatTabController",["ChatTabPresence","Arbiter","ChatActivity","ChatBehavior","ChatConfig","ChatNewMessageHandler","ChatTabMessagesView","ChatTabModel","ChatTabPolicy","ChatTabView","ChatTabViewSelector","JSLogger","MercuryParticipants","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","MercuryUnseenState","Style","UserAgent","VideoCallCore"],function(a,b,c,d,e,f){b('ChatTabPresence');var g=b('Arbiter'),h=b('ChatActivity'),i=b('ChatBehavior'),j=b('ChatConfig'),k=b('ChatNewMessageHandler'),l=b('ChatTabMessagesView'),m=b('ChatTabModel'),n=b('ChatTabPolicy'),o=b('ChatTabView'),p=b('ChatTabViewSelector'),q=b('JSLogger'),r=b('MercuryParticipants'),s=b('MercuryServerRequests'),t=b('MercuryThreadInformer'),u=b('MercuryThreads').get(),v=b('MercuryUnseenState'),w=b('Style'),x=b('UserAgent'),y=b('VideoCallCore'),z=j.get('tab_auto_close_timeout')||7200000,aa=q.create('tab_controller');function ba(la){u.changeThreadReadStatus(la,true);ca(la);}function ca(la){v.markThreadSeen(la);}function da(){var la=m.get();la.tabs.forEach(function(ma){if(ma.raised||i.showsTabUnreadUI())ca(ma.id);});}function ea(la,ma,na){var oa=m.get().tabs;la+=ma?1:-1;while(la>=0&&la<oa.length){var pa=oa[la],qa=o.get(pa.id);if(qa&&qa.isVisible()&&(!na||pa.raised)){qa.focus();return true;}la+=ma?1:-1;}return false;}function fa(la){function ma(pa){var qa=la.shouldPromoteOnRaise(pa);g.inform("chat/promote-tab",pa);if(qa){m.raiseAndPromoteTab(pa,true);}else m.raiseTab(pa,true);var ra=o.get(pa);ra&&ra.focus();}function na(pa,qa){var ra=la.getMaxTabsToShow(),sa=m.indexOf(pa);m.closeTabAndDemote(pa,ra-2,qa);return sa;}p.subscribe('selected',function(pa,qa){ma(qa);});g.subscribe('chat/open-tab',function(pa,qa){ma(qa.thread_id);});g.subscribe('page_transition',function(pa,qa){m.closeFragileTabs();});s.subscribe('model-update-completed',da);o.subscribe('focused',function(event,pa){ba(pa);});h.subscribe('idle',function(pa,qa){if(qa>z){var ra=m.get().tabs;ra.forEach(function(sa){var ta=sa.id;u.getThreadMeta(ta,function(ua){if(!ua.unread_count){aa.log('autoclose_idle_seen',{thread_id:ta,idleness:qa});m.closeTab(ta,'autoclose_idle_seen');}});});}});o.subscribe('nub-activated',function(pa,qa){ma(qa);});o.subscribe('lower-activated',function(pa,qa){m.lowerTab(qa);var ra=o.get(qa);ra&&ra.focus();});function oa(pa,qa){y.showOutgoingCallDialog(qa.userID,qa.clickSource);m.lowerTab(qa.threadID);}o.subscribe('video-call-clicked',oa);l.subscribe('video-call-clicked',oa);o.subscribe('closed-tab',function(pa,qa){aa.log('close_view',{thread_id:qa});na(qa,'close_view');return false;});o.subscribe('thread-deleted',function(pa,qa){aa.log('close_thread_deleted',{thread_id:qa});na(qa,'close_thread_deleted');return false;});o.subscribe('unsubscribed',function(pa,qa){aa.log('close_view_unsubscribed',{thread_id:qa});na(qa,'close_view_unsubscribed');return false;});o.subscribe('esc-pressed',function(pa,qa){aa.log('close_esc',{thread_id:qa});var ra=na(qa,'close_esc');(function(){ea(ra-1,true,true)||ea(ra,false,true);}).defer();});p.subscribe('selector/close-tab',function(pa,qa){aa.log('close_chat_from_selector',{thread_id:qa});na(qa,'close_chat_from_selector');});t.subscribe('messages-received',function(pa,qa){for(var ra in qa){var sa=qa[ra];for(var ta=0;ta<sa.length;ta++){var ua=sa[ta];if(ua.author!=r.user){if(!ua.is_unread){aa.log('message_already_read',{action_id:ua.action_id,thread_id:ua.thread_id});continue;}u.getThreadMeta(ra,function(va){n.messageIsAllowed(va,ua,function(){k.newMessage(ra,ua);});});}}}});t.subscribe('thread-read-changed',function(pa,qa){for(var ra in qa)if(!qa[ra].mark_as_read){aa.log('autoclose_marked_unread',{thread_id:ra});m.closeTab(ra,'autoclose_marked_unread');}});o.subscribe('tab-pressed',function(pa,qa){return !ea(m.indexOf(qa.id),qa.shiftPressed);});g.subscribe(q.DUMP_EVENT,function(pa,qa){qa.chat_controller={auto_close_timeout:z};});}if(x.firefox()){var ga=function(){return w.get(document.body,'overflowX')+' '+w.get(document.body,'overflowY');},ha=ga(),ia=function(){var la=ga();if(la!==ha){ha=la;g.inform('overflow-applied-to-body');}};if('MutationObserver' in window){var ja=new MutationObserver(ia),ka={attributes:true,attributeFilter:['class','style']};ja.observe(document.documentElement,ka);}else document.documentElement.addEventListener('DOMAttrModified',function(event){if(event.getTarget()===document.documentElement&&(event.attrName==='class'||event.attrName==='style'))ia();},false);}e.exports=fa;});
__d("ChatTabViewCoordinator",["Arbiter","ChatConfig","ChatTabModel","ChatTabView","ChatTabViewSelector","CSS","VideoCallCore"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChatConfig'),i=b('ChatTabModel'),j=b('ChatTabView'),k=b('ChatTabViewSelector'),l=b('CSS'),m=b('VideoCallCore');function n(o,p){var q=new k(o),r={},s=false;function t(){var y=i.get(),z={};y.tabs.forEach(function(ba){z[ba.id]=1;});for(var aa in r)if(!z[aa]){r[aa].destroy();delete(r[aa]);}u(y);v(y);}function u(y){var z=null;y.tabs.forEach(function(aa){var ba=aa.id,ca=false;if(!r[ba]){r[ba]=new j(ba,aa.server_id);ca=true;}if(ca||!r[ba].nextTabIs(z))if(z){r[ba].insertBefore(z);}else r[ba].appendTo(o);z=r[ba];});}function v(y){var z=p.getTabsToShow(y),aa=[],ba=false;y.tabs.forEach(function(ca){if(!z[ca.id]){r[ca.id].setVisibleState(false,ca.raised);aa.push(ca);}});y.tabs.forEach(function(ca){if(z[ca.id]){r[ca.id].setVisibleState(true,ca.raised);ba|=ca.raised;}});q.setTabData(aa);x(ba);}function w(y){for(var z=0,aa=y.tabs.length;z<aa;z++){var ba=y.tabs[z];if(ba.raised)if(ba.id===y.promoted||z<p.getMaxTabsToShow()-1)return true;}return false;}function x(y){if(!y&&s){g.inform('layer_hidden',{type:'ChatTab'});s=false;}else if(y&&!s){g.inform('layer_shown',{type:'ChatTab'});s=true;}}if(m.isSupported())l.addClass(o,'videoCallEnabled');p.subscribe('tabs-changed',t);t();}e.exports=n;});
__d("TabsViewport",["event-extensions","ArbiterMixin","ChatConfig","ChatTabModel","Class","CSS","Dock","DOM","Parent","Vector","areObjectsEqual","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ArbiterMixin'),h=b('ChatConfig'),i=b('ChatTabModel'),j=b('Class'),k=b('CSS'),l=b('Dock'),m=b('DOM'),n=b('Parent'),o=b('Vector'),p=b('areObjectsEqual'),q=b('copyProperties');function r(s){this._root=s;Event.listen(window,'resize',this._recalculateWidth.bind(this));l.subscribe('resize',this._recalculateWidth.bind(this));i.subscribe('chat/tabs-changed',this._recalculateTabs.shield(this,true));this._recalculateWidth();this._initialized=true;}q(r.prototype,g,{_root:null,_initialized:false,_availableWidth:0,_maxShown:1,_viewState:null,_recalculateWidth:function(){var s=r._getAvailableDockWidth(this._root),t=Math.max(1,Math.floor(s/264)),u=t!=this._maxShown;if(!this._viewState||u||s<=this._viewState.usedWidth||s>this._viewState.widthToShowNext){this._availableWidth=s;this._maxShown=t;this._viewState=null;this._recalculateTabs(u);}},_onTabsChanged:function(){if(this._initialized){this.inform('tabs-changed');this.inform('max-to-show-changed',this._maxShown);this.inform('max-to-show-change-completed');}},_recalculateTabs:function(s){var t=r._getTabsToShow(i.get(),this._availableWidth);if(s||!p(this._viewState,t)){this._viewState=t;this._onTabsChanged();}},getMaxTabsToShow:function(){return this._maxShown;},checkWidth:function(){this._recalculateWidth();},getTabsToShow:function(){return JSON.parse(JSON.stringify(this._viewState.tabsToShow));},shouldPromoteOnRaise:function(s){if(!this._viewState.tabsToShow[s])return true;if(this._viewState.nextToHide!=s)return false;var t=i.getTab(s),u=t&&t.raised;return !u&&(this._availableWidth-this._viewState.usedWidth<100);}});q(r,{_getAvailableDockWidth:function(s){var t=o.getViewportDimensions().x;t-=230;t-=50;var u=n.byClass(s,'fbDock'),v=o.getElementDimensions(u),w=n.byClass(s,'fbDockChat'),x=o.getElementDimensions(w),y=v.x-x.x;t-=y;t-=20;return Math.max(t,0);},_getTabsToShow:function(s,t){var u=164,v=264;t=Math.max(t,v+1);function w(la){return la.raised?v:u;}var x=JSON.parse(JSON.stringify(s.tabs)),y=-1,z=null;if(s.promoted)x.forEach(function(la,ma){if(la.id===s.promoted){y=ma;z=la;}});var aa=0,ba=0,ca=!z;x.forEach(function(la,ma){var na=w(la);la.leftmostOffset=aa+v;aa+=na;if(la.leftmostOffset<t)ba++;ca|=ma==y;la.alreadyPlacedPromoted=ca;});function da(la,ma,na){var oa={};for(var pa=0;pa<ma;pa++){var qa=la[pa];if(!qa.alreadyPlacedPromoted&&pa==ma-1){oa[na]=true;}else oa[qa.id]=true;}return oa;}var ea=da(x,ba,s.promoted),fa=da(x,ba-1,s.promoted),ga=null;for(var ha in ea)if(!fa[ha])ga=ha;var ia=x[ba-1],ja=ia?ia.leftmostOffset:0,ka=Infinity;if(ba<x.length)ka=x[ba].leftmostOffset;return {nextToHide:ga,tabsToShow:ea,usedWidth:ja,widthToShowNext:ka};}});e.exports=r;});
__d("MercuryStateCheck",["Arbiter","ChannelConstants","MercuryConstants","MercuryFolders","MercuryServerRequests","URI","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChannelConstants'),i=b('MercuryConstants'),j=b('MercuryFolders'),k=b('MercuryServerRequests'),l=b('URI'),m=b('copyProperties'),n=m(new g(),{initialize:function(){g.subscribe(h.ON_INVALID_HISTORY,o);d(['ChannelConnection'],function(p){p.subscribe(p.CONNECTED,function(q,r){if(!r.init)o();});});}});function o(){var p;if(l.getRequestURI().getPath().search(/messages/)!==-1){p=j.getSupportedFolders();}else p=[i.MessagingTag.INBOX];k.fetchMissedMessages(p);}n.initialize();e.exports=n;});
__d("LinkshimHandler",["event-extensions","LinkshimAsyncLink","URI","LinkshimHandlerConfig"],function(a,b,c,d,e,f){b('event-extensions');var g=b('LinkshimAsyncLink'),h=b('URI'),i=b('LinkshimHandlerConfig'),j={setUpLinkshimHandling:function(p){var q=h(p.getAttribute('href')),r=k(q);if(r&&l(q)){Event.listen(p,'mouseover',g.swap.shield(null,p,r));var s=n(q);Event.listen(p,'click',function(){if(i.supports_meta_referrer){g.referrer_log(p,s,m(q).toString());}else g.swap(p,q);});}}};function k(p){return p.getQueryData().u?new h(p.getQueryData().u):null;}function l(p){return p.getQueryData().hasOwnProperty('s');}function m(p){return h('/si/ajax/l/render_linkshim_log/').setSubdomain('www').setQueryData(p.getQueryData());}function n(p){var q;if(o()){q=h(p).addQueryData({render_verification:true});}else q=k(p);return q;}function o(){var p=i.render_verification_rate||0;return Math.floor(Math.random()*p+1)===p;}e.exports=j;});
__d("escapeRegex",[],function(a,b,c,d,e,f){function g(h){return h.replace(/([.?*+\^$\[\]\\(){}|\-])/g,"\\$1");}e.exports=g;});
__d("ChatQuietLinks",["event-extensions","DOM","DOMQuery","UserAgent","DataStore","Parent"],function(a,b,c,d,e,f){b('event-extensions');var g=b('DOM'),h=b('DOMQuery'),i=b('UserAgent'),j=b('DataStore'),k=b('Parent'),l={},m={silenceLinks:function(q){n(q,this.removeEmptyHrefs.bind(this));},nukeLinks:function(q){n(q,this.removeAllHrefs.bind(this));},removeEmptyHrefs:function(q){o(q,function(r){return !r||r==='#';});},removeAllHrefs:function(q){o(q);}};function n(q,r){var s=!!i.chrome(),t=!!i.chrome()||i.ie()>=9||i.firefox()>=4;if(l[g.getID(q)])return;l[g.getID(q)]=true;if(!t)return;if(!s){r&&r(q);return;}Event.listen(q,'mouseover',function u(v){var w=k.byTag(v.getTarget(),'a');if(w){var x=w.getAttribute('href');if(p(x)){j.set(w,'stashedHref',w.getAttribute('href'));w.removeAttribute('href');}}});Event.listen(q,'mouseout',function u(v){var w=k.byTag(v.getTarget(),'a'),x=w&&j.remove(w,'stashedHref');if(p(x))w.setAttribute('href',x);});Event.listen(q,'mousedown',function(u){if(!u.isDefaultRequested())return true;var v=k.byTag(u.getTarget(),'a'),w=v&&j.get(v,'stashedHref');if(p(w))v.setAttribute('href',w);});}function o(q,r){var s=g.scry(q,'a');if(r)s=s.filter(function(t){return r(t.getAttribute('href'));});s.forEach(function(t){t.removeAttribute('href');t.setAttribute('tabindex',0);});}function p(q){return q&&q!=='#';}e.exports=m;});
__d("Dock",["event-extensions","function-extensions","Arbiter","ArbiterMixin","ChatQuietLinks","CSS","DataStore","DOM","Parent","Style","Toggler","Vector","copyProperties","emptyFunction","ge"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('ChatQuietLinks'),j=b('CSS'),k=b('DataStore'),l=b('DOM'),m=b('Parent'),n=b('Style'),o=b('Toggler'),p=b('Vector'),q=b('copyProperties'),r=b('emptyFunction'),s=b('ge');function t(){}q(t,h,{MIN_HEIGHT:140,INITIAL_FLYOUT_HEIGHT_OFFSET:10,init:function(u){this.init=r;this.rootEl=u;this.calculateViewportDimensions();this.calculateFlyoutHeightOffset();i.removeEmptyHrefs(this.rootEl);Event.listen(u,'click',this._onClick.bind(this));Event.listen(window,'resize',this._onWindowResize.bind(this));o.subscribe(['show','hide'],function(v,w){var x=w.getActive();if(!l.contains(u,x))return;if(j.hasClass(x,'fbNub')){this.notifyNub(x,v);if(v==='show')this._resizeNubFlyout(x);}else{var y=m.byClass(x,'fbNubFlyout');if(y)j.conditionClass(y,'menuOpened',v==='show');}}.bind(this));this.inform('init',{},g.BEHAVIOR_PERSISTENT);},calculateViewportDimensions:function(){return (this.viewportDimensions=p.getViewportDimensions());},calculateFlyoutHeightOffset:function(){this.flyoutHeightOffset=this.INITIAL_FLYOUT_HEIGHT_OFFSET+p.getElementDimensions(this.rootEl).y;var u=s('blueBar');if(u){var v=n.isFixed(u)?'viewport':'document';this.flyoutHeightOffset+=p.getElementPosition(u,v).y+p.getElementDimensions(u).y;}},toggle:function(u){var v=this._findFlyout(u);if(!v)return;this.subscribe('init',function(){o.toggle(u);});},show:function(u){this.subscribe('init',function(){o.show(u);});},showNub:function(u){j.show(u);},hide:function(u){this.subscribe('init',function(){var v=o.getInstance(u);l.contains(u,v.getActive())&&v.hide();});},hideNub:function(u){j.hide(u);this.hide(u);},setUseMaxHeight:function(u,v){j.conditionClass(u,'maxHeight',v!==false);this._resizeNubFlyout(u);},_resizeNubFlyout:function(u){var v=this._findFlyout(u);if(!v||!(j.hasClass(u,'openToggler')||j.hasClass(u,'opened')))return;var w=l.find(v,'div.fbNubFlyoutOuter'),x=l.find(w,'div.fbNubFlyoutInner'),y=l.find(x,'div.fbNubFlyoutBody'),z=y.scrollTop,aa=y.offsetHeight;n.set(y,'height','auto');var ba=p.getElementPosition(v,'viewport'),ca=p.getElementDimensions(v),da=p.getElementDimensions(y),ea=this.getMaxFlyoutHeight(u);n.set(v,'max-height',ea+'px');n.set(w,'max-height',ea+'px');ca=p.getElementDimensions(v);var fa=p.getElementDimensions(x),ga=fa.y-da.y;if(ca.y>ga)n.set(y,'height',(ca.y-ga)+'px');j.removeClass(v,'swapDirection');var ha=p.getElementPosition(v).x;j.conditionClass(v,'swapDirection',function(){if(ha<0)return true;return (ha+ca.x>this.viewportDimensions.x);}.bind(this)());if(z+aa>=da.y){y.scrollTop=y.scrollHeight;}else y.scrollTop=z;this.notifyNub(u,'resize');},getMaxFlyoutHeight:function(u){var v=this._findFlyout(u),w=p.getElementPosition(v,'viewport'),x=p.getElementDimensions(v),y=Math.max(this.MIN_HEIGHT,this.viewportDimensions.y-this.flyoutHeightOffset)-(this.viewportDimensions.y-w.y-x.y);return Math.max(y,0);},resizeAllFlyouts:function(){var u=l.scry(this.rootEl,'div.fbNub.openToggler');u=u.concat(l.scry(this.rootEl,'div.fbNub.opened'));var v=u.length;while(v--)this._resizeNubFlyout(u[v]);},_onClick:function(event){var u=event.getTarget(),v=m.byClass(u,'fbNub');if(v){if(m.byClass(u,'fbNubFlyoutTitlebar')){var w=m.byTag(u,'a');if(!w){this.hide(v);return false;}}this.notifyNub(v,'click');}},_onWindowResize:function(event){this.calculateViewportDimensions();this.resizeAllFlyouts();},_findFlyout:function(u){return j.hasClass(u,'fbNubFlyout')?u:l.scry(u,'div.fbNubFlyout')[0]||null;},registerNubController:function(u,v){k.set(u,'dock:nub:controller',v);v.subscribe('nub/button/content-changed',this.inform.shield(this,'resize',u));v.subscribe('nub/flyout/content-changed',this._resizeNubFlyout.shield(this,u));},unregisterNubController:function(u){k.remove(u,'dock:nub:controller');},notifyNub:function(u,v,w){var x=k.get(u,'dock:nub:controller');x&&x.inform(v,w);}});e.exports=a.Dock||t;});
__d("Token",["CSS","DataStore","DOM","copyProperties","tx"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('DataStore'),i=b('DOM'),j=b('copyProperties'),k=b('tx');function l(m,n){this.info=m;this.paramName=n;}j(l.prototype,{getInfo:function(){return this.info;},getText:function(){return this.info.text;},getValue:function(){return this.info.uid;},isFreeform:function(){return !!this.info.freeform;},getElement:function(){if(!this.element)this.setElement(this.createElement());return this.element;},setElement:function(m){h.set(m,'Token',this);this.element=m;return this;},isRemovable:function(){return g.hasClass(this.element,'removable');},createElement:function(){var m=this.paramName,n=this.getText(),o=this.getValue(),p=i.create('a',{href:'#','aria-label':k._("Remove {item}",{item:n}),className:'remove uiCloseButton uiCloseButtonSmall'}),q=i.create('input',{type:'hidden',value:o,name:m+'[]',autocomplete:'off'}),r=i.create('input',{type:'hidden',value:n,name:'text_'+m+'[]',autocomplete:'off'}),s=i.create('span',{className:'removable uiToken'},[n,q,r,p]);return s;}});e.exports=l;});
__d("Tokenizer",["array-extensions","event-extensions","Arbiter","ArbiterMixin","Class","CSS","DataStore","DOM","DOMQuery","Input","Keys","Parent","StickyPlaceholderInput","Style","TextMetrics","Token","UserAgent","copyProperties","createObjectFrom","emptyFunction"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('Class'),j=b('CSS'),k=b('DataStore'),l=b('DOM'),m=b('DOMQuery'),n=b('Input'),o=b('Keys'),p=b('Parent'),q=b('StickyPlaceholderInput'),r=b('Style'),s=b('TextMetrics'),t=b('Token'),u=b('UserAgent'),v=b('copyProperties'),w=b('createObjectFrom'),x=b('emptyFunction');function y(z,aa){this.element=z;this.typeahead=aa;this.input=aa.getCore().getElement();k.set(this.element,'Tokenizer',this);}y.getInstance=function(z){var aa=p.byClass(z,'uiTokenizer');return aa?k.get(aa,'Tokenizer'):null;};v(y.prototype,h,{inline:false,maxTokens:null,excludeDuplicates:true,placeholder:'',init:function(z,aa,ba,ca){this.init=x;this.tokenarea=z;this.paramName=aa;if(!this.placeholder)this.placeholder=this.input.getAttribute('data-placeholder')||'';v(this,ca||{});this.initEvents();this.initTypeahead();this.reset(ba);this.initBehaviors();g.inform('Tokenizer/init',this,g.BEHAVIOR_PERSISTENT);},reset:function(z){this.tokens=[];this.unique={};if(z){this.populate(z);}else l.empty(this.tokenarea);this.updateTokenarea();},populate:function(z){var aa=[];this.tokens=this.getTokenElements().map(function(ba,ca){var da=z[ca];aa.push(this._tokenKey(da));return this.createToken(da,ba);},this);this.unique=w(aa,this.tokens);},getElement:function(){return this.element;},getTypeahead:function(){return this.typeahead;},getInput:function(){return this.input;},initBehaviors:function(){this.behaviors=this.behaviors||[];if(this.behaviors instanceof Array){this.behaviors.forEach(function(ba){ba.behavior(this,ba.config);}.bind(this));}else for(var z in (this.behaviors||{})){var aa=window.TokenizerBehaviors&&window.TokenizerBehaviors[z];aa.call(null,this,this.behaviors[z]);}},initTypeahead:function(){var z=this.typeahead.getCore();z.resetOnSelect=true;z.setValueOnSelect=false;z.preventFocusChangeOnTab=true;if(this.inline){var aa=this.typeahead.getView();j.addClass(aa.getElement(),'uiInlineTokenizerView');}this.typeahead.subscribe('select',function(ba,ca){var da=ca.selected;if('uid' in da){this.updateInput();this.addToken(this.createToken(da));}}.bind(this));this.typeahead.subscribe('blur',this.handleBlur.bind(this));},handleBlur:function(event){this.inform('blur',{event:event});this.updatePlaceholder();},initEvents:function(){var z=this.handleEvents.bind(this),aa=u.firefox()<4?'keypress':'keydown';Event.listen(this.tokenarea,{click:z,keydown:z});Event.listen(this.input,'paste',this.paste.bind(this));Event.listen(this.input,aa,this.keydown.bind(this));},handleEvents:function(event){var z=event.getTarget(),aa=z&&this.getTokenElementFromTarget(z);if(!aa)return;if(event.type!='keydown'||Event.getKeyCode(event)==o.RETURN)this.processEvents(event,z,aa);},processEvents:function(event,z,aa){if(p.byClass(z,'remove')){var ba=aa.nextSibling;ba=ba&&m.scry(aa.nextSibling,'.remove')[0];var ca=this.getTokenFromElement(aa);ca=this.addTokenData(ca,z);this.removeToken(ca);this.focusOnTokenRemoval(event,ba);event.kill();}},focusOnTokenRemoval:function(event,z){n.focus(event.type=='keydown'&&z||this.input);},addTokenData:function(z,aa){return z;},keydown:function(event){this.inform('keydown',{event:event});var z=Event.getKeyCode(event),aa=this.input;if(this.inline&&z==o.BACKSPACE&&n.isEmpty(aa)){var ba=this.getLastToken();if(ba&&ba.isRemovable())this.removeToken(ba);}this.updateInput();},paste:function(event){this.inform('paste',{event:event});this.updateInput(true);},focusInput:function(){n.focus(this.input);},updateInput:function(z){if(!this.inline)return;setTimeout(function(){this.adjustWidth(this.input.value);if(z)this.input.value=this.input.value;}.bind(this),20);q.setPlaceholderText(this.input,'');},setPlaceholder:function(z){this.placeholder=z;if(this.stickyPlaceholder)q.setPlaceholderText(this.input,z);this.updatePlaceholder();},updatePlaceholder:function(){if(!this.inline||this.input.value)return;var z=!this.tokens.length,aa='';if(z||this.stickyPlaceholder){this.adjustWidth(this.placeholder);aa=this.placeholder;}q.setPlaceholderText(this.input,aa);},adjustWidth:function(z){if(!this.inline||!this._getIsInDOM())return;if(!z&&this.stickyPlaceholder&&this.input.value==='')z=this.placeholder;var aa=this._getMetrics().measure(z),ba=aa.width+this._getWidthOffset()+10;r.set(this.input,'width',ba+'px');},getToken:function(z){return this.unique[z]||null;},getTokens:function(){return this.tokens||[];},getTokenElements:function(){return m.scry(this.tokenarea,'span.uiToken');},getTokenElementFromTarget:function(z){return p.byClass(z,'uiToken');},getTokenFromElement:function(z){return k.get(z,'Token');},getTokenValues:function(){if(!this.tokens)return [];return this.tokens.map(function(z){return z.getValue();});},getFirstToken:function(){return this.tokens[0]||null;},getLastToken:function(){return this.tokens[this.tokens.length-1]||null;},hasMaxTokens:function(){return this.maxTokens&&this.maxTokens<=this.tokens.length;},createToken:function(z,aa){var ba=this.getToken(this._tokenKey(z));ba=ba||new t(z,this.paramName);aa&&ba.setElement(aa);return ba;},addToken:function(z){if(this.hasMaxTokens())return;var aa=this._tokenKey(z.getInfo());if(aa in this.unique)return;this.unique[aa]=z;this.tokens.push(z);this.insertToken(z);this.updateTokenarea();this.inform('addToken',z);g.inform('Form/change',{node:this.element});},insertToken:function(z){l.appendContent(this.tokenarea,z.getElement());},removeToken:function(z){if(!z)return;var aa=this.tokens.indexOf(z);if(aa<0)return;this.tokens.splice(this.tokens.indexOf(z),1);delete this.unique[this._tokenKey(z.getInfo())];l.remove(z.getElement());this.updateTokenarea();this.inform('removeToken',z);g.inform('Form/change',{node:this.element});},removeAllTokens:function(){this.reset();this.inform('removeAllTokens');},updateTokenarea:function(){var z=this.typeahead.getCore(),aa=this.getTokenValues();if(this.excludeDuplicates){this._exclusions||(this._exclusions=z.getExclusions());z.setExclusions(aa.concat(this._exclusions));}z.setEnabled(!this.hasMaxTokens());this.updateTokenareaVisibility();this.updatePlaceholder();this.adjustWidth(this.placeholder);},updateTokenareaVisibility:function(){j.conditionShow(this.tokenarea,this.tokens.length!==0);},_tokenKey:function(z){return z.uid+(z.freeform?':':'');},_widthOffset:null,_getWidthOffset:function(){if(this._widthOffset===null){var z=this.input.clientWidth,aa=r.getFloat(this.input,'width');if(z==aa){this._widthOffset=r.getFloat(this.input,'paddingLeft')+r.getFloat(this.input,'paddingRight');}else this._widthOffset=0;}return this._widthOffset;},_metrics:null,_getMetrics:function(){if(!this._metrics)this._metrics=new s(this.input,this.inline);return this._metrics;},_getIsInDOM:function(){return this._isInDOM||(this._isInDOM=m.contains(document.body,this.input));}});y.init=function(z,aa){z.init(aa.tokenarea,aa.param_name,aa.initial_info,aa.options);};e.exports=y;});